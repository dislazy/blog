{"title":"基于authelia的最佳实践","slug":"基于authelia的最佳实践","date":"2021-05-11T14:01:20.000Z","updated":"2022-06-02T01:05:59.617Z","comments":true,"path":"api/articles/基于authelia的最佳实践.json","excerpt":"前言作为一名工程师，在这个繁杂的网络世界中，想有自己的一片净土。自己有很多的网站，方便自己工作生活，但是苦于网络安全问题不敢轻易部署在公网中，所以发掘了这块一款SSO工具：authelia，他能很方便的在nginx层给你的网站加上独属于你的防火墙，账号密码，如果网站很多，并且没有自己独立的账号系统，那这款工具可以说非常适合你了。","covers":null,"content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>作为一名工程师，在这个繁杂的网络世界中，想有自己的一片净土。自己有很多的网站，方便自己工作生活，但是苦于网络安全问题不敢轻易部署在公网中，所以发掘了这块一款SSO工具：<a href=\"https://github.com/authelia/authelia\">authelia</a>，他能很方便的在nginx层给你的网站加上独属于你的防火墙，账号密码，如果网站很多，并且没有自己独立的账号系统，那这款工具可以说非常适合你了。</p>\n<span id=\"more\"></span>\n<h3 id=\"关于authelia\"><a href=\"#关于authelia\" class=\"headerlink\" title=\"关于authelia\"></a>关于authelia</h3><p><strong>Authelia</strong>是一个开源身份验证和授权服务器，可通过Web门户为您的应用程序提供2要素身份验证和单点登录（SSO）。它充当反向代理（如<a href=\"https://www.nginx.com/\">nginx</a>，<a href=\"https://traefik.io/\">Traefik</a>或<a href=\"https://www.haproxy.org/\">HAProxy）</a>的伴侣，以使他们知道查询是否应该通过。未经身份验证的用户将重定向到Authelia登录门户。<br>目前主要可用<strong>功能</strong></p>\n<ul>\n<li><p>几种第二因素方法：</p>\n<ul>\n<li>带有<a href=\"https://www.yubico.com/products/yubikey-hardware/yubikey4/\">Yubikey的</a><a href=\"https://www.authelia.com/docs/features/2fa/security-key\">安全密钥（U2F）</a>。</li>\n<li>使用<a href=\"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en\">Google Authenticator</a><a href=\"https://www.authelia.com/docs/features/2fa/one-time-password\">的基于时间的一次性密码</a>。</li>\n<li>带有<a href=\"https://duo.com/\">Duo的</a><a href=\"https://www.authelia.com/docs/features/2fa/push-notifications\">移动推送通知</a>。</li>\n</ul>\n</li>\n<li><p>使用电子邮件确认通过身份验证重置密码。</p>\n</li>\n<li><p>仅单因素身份验证方法可用。</p>\n</li>\n<li><p>尝试过多身份验证后的访问限制。</p>\n</li>\n<li><p>每个子域，用户，资源和网络的细粒度访问控制。</p>\n</li>\n<li><p>支持受单一因素保护的端点的基本身份验证。</p>\n</li>\n<li><p>Beta对<a href=\"https://www.authelia.com/docs/configuration/identity-providers/oidc.html\">OpenID Connect的</a>支持。</p>\n</li>\n<li><p>使用远程数据库具有很高的可用性，Redis可作为高可用性KV存储使用。</p>\n</li>\n<li><p>开箱即用与Kubernetes<a href=\"https://github.com/kubernetes/ingress-nginx\">ingress-nginx</a>控制器兼容。</p>\n<h3 id=\"最佳实践-部署\"><a href=\"#最佳实践-部署\" class=\"headerlink\" title=\"最佳实践-部署\"></a>最佳实践-部署</h3><p>使用容器化部署<strong>Authelia是</strong>比较简单快捷的方法，可以直接拉取对应的镜像，编辑自定义配置文件即可完成部署，超简单的哦。</p>\n<h4 id=\"1、拉取authelia镜像：\"><a href=\"#1、拉取authelia镜像：\" class=\"headerlink\" title=\"1、拉取authelia镜像：\"></a>1、拉取authelia镜像：</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull authelia/authelia</span><br></pre></td></tr></table></figure>\n<p>如果存在国内拉取镜像过慢的方法，可以使用以下的命令拉取,是直接使用github actions拉取到国内来的</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull registry.cn-shanghai.aliyuncs.com/bosong/autheli</span><br></pre></td></tr></table></figure>\n<h4 id=\"2、编写docker-compose文件\"><a href=\"#2、编写docker-compose文件\" class=\"headerlink\" title=\"2、编写docker compose文件\"></a>2、编写docker compose文件</h4><p>docker-compose.yaml文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">version: <span class=\"string\">&#x27;3.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  authelia:</span><br><span class=\"line\">    image: registry.cn-shanghai.aliyuncs.com/bosong/authelia</span><br><span class=\"line\">    container_name: authelia</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /data-colum/authelia:/config</span><br><span class=\"line\">    healthcheck:</span><br><span class=\"line\">      <span class=\"built_in\">disable</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - TZ=Asia/Shanghai</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 9999:9091</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：</p>\n</li>\n<li><p><code>/data-colum/authelia:/config</code> 此处是直接使用docker部署的配置，需要提前将对应配置放入到对应的文件夹中</p>\n<h4 id=\"3、配置authelia\"><a href=\"#3、配置authelia\" class=\"headerlink\" title=\"3、配置authelia\"></a>3、配置authelia</h4><p>具体的文件排列如下，以 文件夹为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── /data-colum/authelia/</span><br><span class=\"line\">│   ├── configuration.yml  <span class=\"comment\">#配置文件</span></span><br><span class=\"line\">│   └── users_database.yml <span class=\"comment\">#用户数据文件</span></span><br><span class=\"line\">└── docker-compose.yaml</span><br></pre></td></tr></table></figure>\n<p>configuration.yml模板文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\">###############################################################</span></span><br><span class=\"line\"><span class=\"comment\">#                   Authelia configuration                    #</span></span><br><span class=\"line\"><span class=\"comment\">###############################################################</span></span><br><span class=\"line\"><span class=\"comment\">#基本配置：配置端口、jwt秘钥、默认的跳转地址、totp对应的域名</span></span><br><span class=\"line\">host: 0.0.0.0</span><br><span class=\"line\">port: 9091</span><br><span class=\"line\">log_level: debug</span><br><span class=\"line\"><span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_JWT_SECRET_FILE</span></span><br><span class=\"line\">jwt_secret: adakusdhhadsk</span><br><span class=\"line\">default_redirection_url: https://www.abcd.com</span><br><span class=\"line\">totp:</span><br><span class=\"line\">  issuer: abcd.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># duo_api:</span></span><br><span class=\"line\"><span class=\"comment\">#  hostname: api-123456789.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#  integration_key: ABCDEF</span></span><br><span class=\"line\"><span class=\"comment\">#  # This secret can also be set using the env variables AUTHELIA_DUO_API_SECRET_KEY_FILE</span></span><br><span class=\"line\"><span class=\"comment\">#  secret_key: 1234567890abcdefghifjkl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用户文件配置：目前Authelia只支持ldap和使用文件形式的用户列表</span></span><br><span class=\"line\">authentication_backend:</span><br><span class=\"line\">  file:</span><br><span class=\"line\">    path: /config/users_database.yml</span><br><span class=\"line\"></span><br><span class=\"line\">access_control:</span><br><span class=\"line\">  default_policy: one_factor</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    <span class=\"comment\"># Rules applied to everyone</span></span><br><span class=\"line\">    - domain: abcd.abcd.com</span><br><span class=\"line\">      policy: one_factor</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#seesion 配置</span></span><br><span class=\"line\">session:</span><br><span class=\"line\">  name: authelia</span><br><span class=\"line\">  <span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_SESSION_SECRET_FILE</span></span><br><span class=\"line\">  secret: asdasfjjhas</span><br><span class=\"line\">  expiration: 3600  <span class=\"comment\"># 1 hour</span></span><br><span class=\"line\">  inactivity: 300  <span class=\"comment\"># 5 minutes</span></span><br><span class=\"line\">  domain: abcd.com  <span class=\"comment\"># Should match whatever your root protected domain is</span></span><br><span class=\"line\"></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    host: redis.xxxx.com</span><br><span class=\"line\">    port: 6379</span><br><span class=\"line\">    password: abcdhasd</span><br><span class=\"line\">    database_index: 5</span><br><span class=\"line\">    maximum_active_connections: 100</span><br><span class=\"line\">    minimum_idle_connections: 0</span><br><span class=\"line\"></span><br><span class=\"line\">regulation:</span><br><span class=\"line\">  max_retries: 3</span><br><span class=\"line\">  find_time: 120</span><br><span class=\"line\">  ban_time: 300</span><br><span class=\"line\"><span class=\"comment\">#存储配置</span></span><br><span class=\"line\">storage:</span><br><span class=\"line\">  mysql:</span><br><span class=\"line\">    host: mysql.abcd.com</span><br><span class=\"line\">    port: 3306</span><br><span class=\"line\">    database: authelia</span><br><span class=\"line\">    username: authelia</span><br><span class=\"line\">    <span class=\"comment\">## Password can also be set using a secret: https://www.authelia.com/docs/configuration/secrets.html</span></span><br><span class=\"line\">    password: 123456</span><br><span class=\"line\"><span class=\"comment\">#邮件发件配置，主要用于修改密码等操作</span></span><br><span class=\"line\">notifier:</span><br><span class=\"line\">  smtp:</span><br><span class=\"line\">    username: noreply@abcd.com</span><br><span class=\"line\">    <span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_NOTIFIER_SMTP_PASSWORD_FILE</span></span><br><span class=\"line\">    password: abcdaklfdj</span><br><span class=\"line\">    host: smtp.exmail.qq.com</span><br><span class=\"line\">    port: 465</span><br><span class=\"line\">    sender: noreply@abcd.com</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>用户文件模板文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">  authelia:</span><br><span class=\"line\">    password: $argon2id<span class=\"variable\">$v</span>=19<span class=\"variable\">$m</span>=65536,t=1,p=8$RUFuRGFEY291UGdaU0Jxqwqe<span class=\"variable\">$zqTCjJKc2Ka0MDA3OMQ8rX6HAMyLOppFQl1HPmN8mMI</span></span><br><span class=\"line\">    displayname: Authelia</span><br><span class=\"line\">    email: abcd@abcd.com</span><br><span class=\"line\">    <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">    - admins</span><br><span class=\"line\">    - dev</span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：</p>\n</li>\n<li><p><code>default_redirection_url</code> 是直接在<strong>auth.abcd.com登录后默认跳转的地址</strong></p>\n</li>\n<li><p>存储数据库可支持 mysql、sqlite等，结合<a href=\"https://www.authelia.com/docs/\">官方文档</a>来看即可</p>\n</li>\n<li><p>邮件发送配置如果使用即配置，不使用不配置。</p>\n</li>\n<li><p>如果需要修改对应的密码，使用<code>docker exec -it 容器名 sh </code> 后执行 <code>authelia hash-password 123456</code> 即可修改密码再进行填充</p>\n</li>\n<li><p>对应的<code>jwt_secret</code>、<code>session.secret</code> 一定记得更换</p>\n<h4 id=\"4、部署启动authelia\"><a href=\"#4、部署启动authelia\" class=\"headerlink\" title=\"4、部署启动authelia\"></a>4、部署启动authelia</h4><p>在3中已经给出了对应的文件层级，直接根据使用docker-compose执行执行对应命令即可启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-comose -f docker-compose.yaml up -d</span><br></pre></td></tr></table></figure>\n<h4 id=\"5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\"><a href=\"#5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\" class=\"headerlink\" title=\"5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\"></a>5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── /authelia/</span><br><span class=\"line\">│   ├── authelia.conf authelia文件</span><br><span class=\"line\">|\t\t├── auth.conf auth文件</span><br><span class=\"line\">│   └── proxy.conf 代理文件</span><br><span class=\"line\">└── nginx.conf</span><br></pre></td></tr></table></figure>\n<p><strong>authelia.conf</strong>文件内容如下<strong>：</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set</span> <span class=\"variable\">$upstream_authelia</span> http://127.0.0.1:9999/api/verify;</span><br><span class=\"line\"><span class=\"comment\"># Virtual endpoint created by nginx to forward auth requests.</span></span><br><span class=\"line\">location /authelia &#123;</span><br><span class=\"line\">    internal;</span><br><span class=\"line\">    proxy_pass_request_body off;</span><br><span class=\"line\">    proxy_pass <span class=\"variable\">$upstream_authelia</span>;</span><br><span class=\"line\">    proxy_set_header Content-Length <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Timeout if the real server is dead</span></span><br><span class=\"line\">    proxy_next_upstream error <span class=\"built_in\">timeout</span> invalid_header http_500 http_502 http_503;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># [REQUIRED] Needed by Authelia to check authorizations of the resource.</span></span><br><span class=\"line\">    <span class=\"comment\"># Provide either X-Original-URL and X-Forwarded-Proto or</span></span><br><span class=\"line\">    <span class=\"comment\"># X-Forwarded-Proto, X-Forwarded-Host and X-Forwarded-Uri or both.</span></span><br><span class=\"line\">    <span class=\"comment\"># Those headers will be used by Authelia to deduce the target url of the user.</span></span><br><span class=\"line\">    <span class=\"comment\"># Basic Proxy Config</span></span><br><span class=\"line\">    client_body_buffer_size 128k;</span><br><span class=\"line\">    proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    proxy_set_header X-Original-URL <span class=\"variable\">$scheme</span>://$http_host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Method <span class=\"variable\">$request_method</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Uri <span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-For <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Ssl on;</span><br><span class=\"line\">    proxy_redirect  http://  <span class=\"variable\">$scheme</span>://;</span><br><span class=\"line\">    proxy_http_version 1.1;</span><br><span class=\"line\">    proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">    proxy_cache_bypass <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">    proxy_no_cache <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">    proxy_buffers 4 32k;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Advanced Proxy Config</span></span><br><span class=\"line\">    send_timeout 5m;</span><br><span class=\"line\">    proxy_read_timeout 240;</span><br><span class=\"line\">    proxy_send_timeout 240;</span><br><span class=\"line\">    proxy_connect_timeout 240;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>auth.conf</strong>文件内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Basic Authelia Config</span></span><br><span class=\"line\"><span class=\"comment\"># Send a subsequent request to Authelia to verify if the user is authenticated</span></span><br><span class=\"line\"><span class=\"comment\"># and has the right permissions to access the resource.</span></span><br><span class=\"line\">auth_request /authelia;</span><br><span class=\"line\"><span class=\"comment\"># Set the `target_url` variable based on the request. It will be used to build the portal</span></span><br><span class=\"line\"><span class=\"comment\"># URL with the correct redirection parameter.</span></span><br><span class=\"line\">auth_request_set <span class=\"variable\">$target_url</span> <span class=\"variable\">$scheme</span>://$http_host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\"><span class=\"comment\"># Set the X-Forwarded-User and X-Forwarded-Groups with the headers</span></span><br><span class=\"line\"><span class=\"comment\"># returned by Authelia for the backends which can consume them.</span></span><br><span class=\"line\"><span class=\"comment\"># This is not safe, as the backend must make sure that they come from the</span></span><br><span class=\"line\"><span class=\"comment\"># proxy. In the future, it&#x27;s gonna be safe to just use OAuth.</span></span><br><span class=\"line\">auth_request_set <span class=\"variable\">$user</span> <span class=\"variable\">$upstream_http_remote_user</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$groups</span> <span class=\"variable\">$upstream_http_remote_groups</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$name</span> <span class=\"variable\">$upstream_http_remote_name</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$email</span> <span class=\"variable\">$upstream_http_remote_email</span>;</span><br><span class=\"line\">proxy_set_header Remote-User <span class=\"variable\">$user</span>;</span><br><span class=\"line\">proxy_set_header Remote-Groups <span class=\"variable\">$groups</span>;</span><br><span class=\"line\">proxy_set_header Remote-Name <span class=\"variable\">$name</span>;</span><br><span class=\"line\">proxy_set_header Remote-Email <span class=\"variable\">$email</span>;</span><br><span class=\"line\"><span class=\"comment\"># If Authelia returns 401, then nginx redirects the user to the login portal.</span></span><br><span class=\"line\"><span class=\"comment\"># If it returns 200, then the request pass through to the backend.</span></span><br><span class=\"line\"><span class=\"comment\"># For other type of errors, nginx will handle them as usual.</span></span><br><span class=\"line\">error_page 401 =302 https://auth.alidaodao.com/?rd=<span class=\"variable\">$target_url</span>;</span><br></pre></td></tr></table></figure>\n<p>**proxy.conf **文件内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client_body_buffer_size 128k;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Timeout if the real server is dead</span></span><br><span class=\"line\">proxy_next_upstream error <span class=\"built_in\">timeout</span> invalid_header http_500 http_502 http_503;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Advanced Proxy Config</span></span><br><span class=\"line\">send_timeout 5m;</span><br><span class=\"line\">proxy_read_timeout 360;</span><br><span class=\"line\">proxy_send_timeout 360;</span><br><span class=\"line\">proxy_connect_timeout 360;</span><br><span class=\"line\"><span class=\"comment\"># Basic Proxy Config</span></span><br><span class=\"line\">proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Uri <span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Ssl on;</span><br><span class=\"line\">proxy_redirect  http://  <span class=\"variable\">$scheme</span>://;</span><br><span class=\"line\"><span class=\"comment\">#proxy_http_version 1.1;</span></span><br><span class=\"line\">proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">proxy_cache_bypass <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">proxy_no_cache <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">proxy_buffers 64 256k;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If behind reverse proxy, forwards the correct IP</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 10.0.0.0/8;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 172.16.0.0/12;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 192.168.0.0/16;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from fc00::/7;</span></span><br><span class=\"line\"><span class=\"comment\">#real_ip_header X-Forwarded-For;</span></span><br><span class=\"line\"><span class=\"comment\">#real_ip_recursive on;</span></span><br></pre></td></tr></table></figure>\n<p><strong>注意：</strong></p>\n</li>\n<li><p><strong>auth.conf</strong>、<strong>proxy.conf</strong> 文件不需要进行改动，直接保存放入文件夹中即可</p>\n</li>\n<li><p><strong>authelia.conf</strong> <strong>upstream_authelia</strong> 如果authelia使用的是远程的服务，则修改为对应远程地址即可，其他的不用改动</p>\n<h4 id=\"6、使用nginx配置auth-abcd-com-域名\"><a href=\"#6、使用nginx配置auth-abcd-com-域名\" class=\"headerlink\" title=\"6、使用nginx配置auth.abcd.com 域名\"></a>6、使用nginx配置auth.abcd.com 域名</h4><p>文件配置阶段结束了，可以进行实际的应用，除了配置auth的服务域名之外，另外配置一个demo域名来验证auth的sso服务是否可用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream authelia &#123;</span><br><span class=\"line\">  server localhost:9999;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name auth.abcd.com;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 301 https://$server_name<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 443 ssl;</span><br><span class=\"line\">        server_name auth.abcd.com;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        ssl_certificate   cert/authelia.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/authelia.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        access_log  logs/authelia_access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://authelia;</span><br><span class=\"line\">        include /data/nginx/authelia/proxy.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用以上配置来使auth域名对应的服务生效，可以访问<strong>auth.abcd.com</strong>来验证服务是否正常对外提供服务。</p>\n<h4 id=\"7、配置demo-abcd-com域名\"><a href=\"#7、配置demo-abcd-com域名\" class=\"headerlink\" title=\"7、配置demo.abcd.com域名\"></a>7、配置demo.abcd.com域名</h4><p>给<strong>demo.abcd.com</strong>域名配置上SSO服务，在访问<strong>demo.abcd.com</strong>时，如果未进行登录则会跳转到<strong>auth.abcd.com</strong>进行登录，登录成功后会重定向回<strong>demo.abcd.com</strong>，配置文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream demo &#123;</span><br><span class=\"line\">  server localhost:8880;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name demo.abcd.com;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 301 https://$server_name<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 443 ssl;</span><br><span class=\"line\">        server_name demo.abcd.com;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        <span class=\"comment\">#ssl on;</span></span><br><span class=\"line\">        ssl_certificate   cert/demo.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/demo.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        access_log  logs/demo_access.log  main;</span><br><span class=\"line\">        <span class=\"comment\">#将authelia.conf配置在此处</span></span><br><span class=\"line\">        include /data/nginx/authelia/authelia.conf;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://demo;</span><br><span class=\"line\">        <span class=\"comment\">#配置auth和代理</span></span><br><span class=\"line\">        include /data/nginx/authelia/auth.conf;</span><br><span class=\"line\">        include /data/nginx/authelia/proxy.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用以上配置即可成功让<strong>demo.abcd.com</strong>网站接入sso服务，来保障<strong>demo.abcd.com</strong>对应的服务不被匿名访问到</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>没有十全十美的工具，只看怎么使用，在使用<a href=\"https://github.com/authelia/authelia\">authelia</a>的过程中也发现了很多的不足：</p>\n</li>\n<li><p>非ldap模式下配置用户比较麻烦，修改完文件后还需要进行重启</p>\n</li>\n<li><p>如果出现如下警告: <strong>nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: 512 or proxy_headers_hash_bucket_size: 64; ignoring proxy_headers_hash_bucket_size 在nginx.conf 配置文件中加上 以下配置即可。</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proxy_headers_hash_max_size 51200;</span><br><span class=\"line\">proxy_headers_hash_bucket_size 6400;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>这篇文章是自己根据实际经验编写的，如果有错漏之处可以参考<a href=\"https://www.authelia.com/docs/\">官方文档</a></p>\n</li>\n</ul>\n\n","more":"<h3 id=\"关于authelia\"><a href=\"#关于authelia\" class=\"headerlink\" title=\"关于authelia\"></a>关于authelia</h3><p><strong>Authelia</strong>是一个开源身份验证和授权服务器，可通过Web门户为您的应用程序提供2要素身份验证和单点登录（SSO）。它充当反向代理（如<a href=\"https://www.nginx.com/\">nginx</a>，<a href=\"https://traefik.io/\">Traefik</a>或<a href=\"https://www.haproxy.org/\">HAProxy）</a>的伴侣，以使他们知道查询是否应该通过。未经身份验证的用户将重定向到Authelia登录门户。<br>目前主要可用<strong>功能</strong></p>\n<ul>\n<li><p>几种第二因素方法：</p>\n<ul>\n<li>带有<a href=\"https://www.yubico.com/products/yubikey-hardware/yubikey4/\">Yubikey的</a><a href=\"https://www.authelia.com/docs/features/2fa/security-key\">安全密钥（U2F）</a>。</li>\n<li>使用<a href=\"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en\">Google Authenticator</a><a href=\"https://www.authelia.com/docs/features/2fa/one-time-password\">的基于时间的一次性密码</a>。</li>\n<li>带有<a href=\"https://duo.com/\">Duo的</a><a href=\"https://www.authelia.com/docs/features/2fa/push-notifications\">移动推送通知</a>。</li>\n</ul>\n</li>\n<li><p>使用电子邮件确认通过身份验证重置密码。</p>\n</li>\n<li><p>仅单因素身份验证方法可用。</p>\n</li>\n<li><p>尝试过多身份验证后的访问限制。</p>\n</li>\n<li><p>每个子域，用户，资源和网络的细粒度访问控制。</p>\n</li>\n<li><p>支持受单一因素保护的端点的基本身份验证。</p>\n</li>\n<li><p>Beta对<a href=\"https://www.authelia.com/docs/configuration/identity-providers/oidc.html\">OpenID Connect的</a>支持。</p>\n</li>\n<li><p>使用远程数据库具有很高的可用性，Redis可作为高可用性KV存储使用。</p>\n</li>\n<li><p>开箱即用与Kubernetes<a href=\"https://github.com/kubernetes/ingress-nginx\">ingress-nginx</a>控制器兼容。</p>\n<h3 id=\"最佳实践-部署\"><a href=\"#最佳实践-部署\" class=\"headerlink\" title=\"最佳实践-部署\"></a>最佳实践-部署</h3><p>使用容器化部署<strong>Authelia是</strong>比较简单快捷的方法，可以直接拉取对应的镜像，编辑自定义配置文件即可完成部署，超简单的哦。</p>\n<h4 id=\"1、拉取authelia镜像：\"><a href=\"#1、拉取authelia镜像：\" class=\"headerlink\" title=\"1、拉取authelia镜像：\"></a>1、拉取authelia镜像：</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull authelia/authelia</span><br></pre></td></tr></table></figure>\n<p>如果存在国内拉取镜像过慢的方法，可以使用以下的命令拉取,是直接使用github actions拉取到国内来的</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull registry.cn-shanghai.aliyuncs.com/bosong/autheli</span><br></pre></td></tr></table></figure>\n<h4 id=\"2、编写docker-compose文件\"><a href=\"#2、编写docker-compose文件\" class=\"headerlink\" title=\"2、编写docker compose文件\"></a>2、编写docker compose文件</h4><p>docker-compose.yaml文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">version: <span class=\"string\">&#x27;3.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  authelia:</span><br><span class=\"line\">    image: registry.cn-shanghai.aliyuncs.com/bosong/authelia</span><br><span class=\"line\">    container_name: authelia</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - /data-colum/authelia:/config</span><br><span class=\"line\">    healthcheck:</span><br><span class=\"line\">      <span class=\"built_in\">disable</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      - TZ=Asia/Shanghai</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 9999:9091</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：</p>\n</li>\n<li><p><code>/data-colum/authelia:/config</code> 此处是直接使用docker部署的配置，需要提前将对应配置放入到对应的文件夹中</p>\n<h4 id=\"3、配置authelia\"><a href=\"#3、配置authelia\" class=\"headerlink\" title=\"3、配置authelia\"></a>3、配置authelia</h4><p>具体的文件排列如下，以 文件夹为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── /data-colum/authelia/</span><br><span class=\"line\">│   ├── configuration.yml  <span class=\"comment\">#配置文件</span></span><br><span class=\"line\">│   └── users_database.yml <span class=\"comment\">#用户数据文件</span></span><br><span class=\"line\">└── docker-compose.yaml</span><br></pre></td></tr></table></figure>\n<p>configuration.yml模板文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\">###############################################################</span></span><br><span class=\"line\"><span class=\"comment\">#                   Authelia configuration                    #</span></span><br><span class=\"line\"><span class=\"comment\">###############################################################</span></span><br><span class=\"line\"><span class=\"comment\">#基本配置：配置端口、jwt秘钥、默认的跳转地址、totp对应的域名</span></span><br><span class=\"line\">host: 0.0.0.0</span><br><span class=\"line\">port: 9091</span><br><span class=\"line\">log_level: debug</span><br><span class=\"line\"><span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_JWT_SECRET_FILE</span></span><br><span class=\"line\">jwt_secret: adakusdhhadsk</span><br><span class=\"line\">default_redirection_url: https://www.abcd.com</span><br><span class=\"line\">totp:</span><br><span class=\"line\">  issuer: abcd.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># duo_api:</span></span><br><span class=\"line\"><span class=\"comment\">#  hostname: api-123456789.example.com</span></span><br><span class=\"line\"><span class=\"comment\">#  integration_key: ABCDEF</span></span><br><span class=\"line\"><span class=\"comment\">#  # This secret can also be set using the env variables AUTHELIA_DUO_API_SECRET_KEY_FILE</span></span><br><span class=\"line\"><span class=\"comment\">#  secret_key: 1234567890abcdefghifjkl</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用户文件配置：目前Authelia只支持ldap和使用文件形式的用户列表</span></span><br><span class=\"line\">authentication_backend:</span><br><span class=\"line\">  file:</span><br><span class=\"line\">    path: /config/users_database.yml</span><br><span class=\"line\"></span><br><span class=\"line\">access_control:</span><br><span class=\"line\">  default_policy: one_factor</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    <span class=\"comment\"># Rules applied to everyone</span></span><br><span class=\"line\">    - domain: abcd.abcd.com</span><br><span class=\"line\">      policy: one_factor</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#seesion 配置</span></span><br><span class=\"line\">session:</span><br><span class=\"line\">  name: authelia</span><br><span class=\"line\">  <span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_SESSION_SECRET_FILE</span></span><br><span class=\"line\">  secret: asdasfjjhas</span><br><span class=\"line\">  expiration: 3600  <span class=\"comment\"># 1 hour</span></span><br><span class=\"line\">  inactivity: 300  <span class=\"comment\"># 5 minutes</span></span><br><span class=\"line\">  domain: abcd.com  <span class=\"comment\"># Should match whatever your root protected domain is</span></span><br><span class=\"line\"></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    host: redis.xxxx.com</span><br><span class=\"line\">    port: 6379</span><br><span class=\"line\">    password: abcdhasd</span><br><span class=\"line\">    database_index: 5</span><br><span class=\"line\">    maximum_active_connections: 100</span><br><span class=\"line\">    minimum_idle_connections: 0</span><br><span class=\"line\"></span><br><span class=\"line\">regulation:</span><br><span class=\"line\">  max_retries: 3</span><br><span class=\"line\">  find_time: 120</span><br><span class=\"line\">  ban_time: 300</span><br><span class=\"line\"><span class=\"comment\">#存储配置</span></span><br><span class=\"line\">storage:</span><br><span class=\"line\">  mysql:</span><br><span class=\"line\">    host: mysql.abcd.com</span><br><span class=\"line\">    port: 3306</span><br><span class=\"line\">    database: authelia</span><br><span class=\"line\">    username: authelia</span><br><span class=\"line\">    <span class=\"comment\">## Password can also be set using a secret: https://www.authelia.com/docs/configuration/secrets.html</span></span><br><span class=\"line\">    password: 123456</span><br><span class=\"line\"><span class=\"comment\">#邮件发件配置，主要用于修改密码等操作</span></span><br><span class=\"line\">notifier:</span><br><span class=\"line\">  smtp:</span><br><span class=\"line\">    username: noreply@abcd.com</span><br><span class=\"line\">    <span class=\"comment\"># This secret can also be set using the env variables AUTHELIA_NOTIFIER_SMTP_PASSWORD_FILE</span></span><br><span class=\"line\">    password: abcdaklfdj</span><br><span class=\"line\">    host: smtp.exmail.qq.com</span><br><span class=\"line\">    port: 465</span><br><span class=\"line\">    sender: noreply@abcd.com</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n<p>用户文件模板文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">  authelia:</span><br><span class=\"line\">    password: $argon2id<span class=\"variable\">$v</span>=19<span class=\"variable\">$m</span>=65536,t=1,p=8$RUFuRGFEY291UGdaU0Jxqwqe<span class=\"variable\">$zqTCjJKc2Ka0MDA3OMQ8rX6HAMyLOppFQl1HPmN8mMI</span></span><br><span class=\"line\">    displayname: Authelia</span><br><span class=\"line\">    email: abcd@abcd.com</span><br><span class=\"line\">    <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">    - admins</span><br><span class=\"line\">    - dev</span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：</p>\n</li>\n<li><p><code>default_redirection_url</code> 是直接在<strong>auth.abcd.com登录后默认跳转的地址</strong></p>\n</li>\n<li><p>存储数据库可支持 mysql、sqlite等，结合<a href=\"https://www.authelia.com/docs/\">官方文档</a>来看即可</p>\n</li>\n<li><p>邮件发送配置如果使用即配置，不使用不配置。</p>\n</li>\n<li><p>如果需要修改对应的密码，使用<code>docker exec -it 容器名 sh </code> 后执行 <code>authelia hash-password 123456</code> 即可修改密码再进行填充</p>\n</li>\n<li><p>对应的<code>jwt_secret</code>、<code>session.secret</code> 一定记得更换</p>\n<h4 id=\"4、部署启动authelia\"><a href=\"#4、部署启动authelia\" class=\"headerlink\" title=\"4、部署启动authelia\"></a>4、部署启动authelia</h4><p>在3中已经给出了对应的文件层级，直接根据使用docker-compose执行执行对应命令即可启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-comose -f docker-compose.yaml up -d</span><br></pre></td></tr></table></figure>\n<h4 id=\"5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\"><a href=\"#5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\" class=\"headerlink\" title=\"5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：\"></a>5、按照文档编写对应nginx的配置文件，以nginx为例，需要编写三个文件：</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">├── /authelia/</span><br><span class=\"line\">│   ├── authelia.conf authelia文件</span><br><span class=\"line\">|\t\t├── auth.conf auth文件</span><br><span class=\"line\">│   └── proxy.conf 代理文件</span><br><span class=\"line\">└── nginx.conf</span><br></pre></td></tr></table></figure>\n<p><strong>authelia.conf</strong>文件内容如下<strong>：</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">set</span> <span class=\"variable\">$upstream_authelia</span> http://127.0.0.1:9999/api/verify;</span><br><span class=\"line\"><span class=\"comment\"># Virtual endpoint created by nginx to forward auth requests.</span></span><br><span class=\"line\">location /authelia &#123;</span><br><span class=\"line\">    internal;</span><br><span class=\"line\">    proxy_pass_request_body off;</span><br><span class=\"line\">    proxy_pass <span class=\"variable\">$upstream_authelia</span>;</span><br><span class=\"line\">    proxy_set_header Content-Length <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Timeout if the real server is dead</span></span><br><span class=\"line\">    proxy_next_upstream error <span class=\"built_in\">timeout</span> invalid_header http_500 http_502 http_503;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># [REQUIRED] Needed by Authelia to check authorizations of the resource.</span></span><br><span class=\"line\">    <span class=\"comment\"># Provide either X-Original-URL and X-Forwarded-Proto or</span></span><br><span class=\"line\">    <span class=\"comment\"># X-Forwarded-Proto, X-Forwarded-Host and X-Forwarded-Uri or both.</span></span><br><span class=\"line\">    <span class=\"comment\"># Those headers will be used by Authelia to deduce the target url of the user.</span></span><br><span class=\"line\">    <span class=\"comment\"># Basic Proxy Config</span></span><br><span class=\"line\">    client_body_buffer_size 128k;</span><br><span class=\"line\">    proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">    proxy_set_header X-Original-URL <span class=\"variable\">$scheme</span>://$http_host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Method <span class=\"variable\">$request_method</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Uri <span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-For <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">    proxy_set_header X-Forwarded-Ssl on;</span><br><span class=\"line\">    proxy_redirect  http://  <span class=\"variable\">$scheme</span>://;</span><br><span class=\"line\">    proxy_http_version 1.1;</span><br><span class=\"line\">    proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">    proxy_cache_bypass <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">    proxy_no_cache <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">    proxy_buffers 4 32k;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Advanced Proxy Config</span></span><br><span class=\"line\">    send_timeout 5m;</span><br><span class=\"line\">    proxy_read_timeout 240;</span><br><span class=\"line\">    proxy_send_timeout 240;</span><br><span class=\"line\">    proxy_connect_timeout 240;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>auth.conf</strong>文件内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Basic Authelia Config</span></span><br><span class=\"line\"><span class=\"comment\"># Send a subsequent request to Authelia to verify if the user is authenticated</span></span><br><span class=\"line\"><span class=\"comment\"># and has the right permissions to access the resource.</span></span><br><span class=\"line\">auth_request /authelia;</span><br><span class=\"line\"><span class=\"comment\"># Set the `target_url` variable based on the request. It will be used to build the portal</span></span><br><span class=\"line\"><span class=\"comment\"># URL with the correct redirection parameter.</span></span><br><span class=\"line\">auth_request_set <span class=\"variable\">$target_url</span> <span class=\"variable\">$scheme</span>://$http_host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\"><span class=\"comment\"># Set the X-Forwarded-User and X-Forwarded-Groups with the headers</span></span><br><span class=\"line\"><span class=\"comment\"># returned by Authelia for the backends which can consume them.</span></span><br><span class=\"line\"><span class=\"comment\"># This is not safe, as the backend must make sure that they come from the</span></span><br><span class=\"line\"><span class=\"comment\"># proxy. In the future, it&#x27;s gonna be safe to just use OAuth.</span></span><br><span class=\"line\">auth_request_set <span class=\"variable\">$user</span> <span class=\"variable\">$upstream_http_remote_user</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$groups</span> <span class=\"variable\">$upstream_http_remote_groups</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$name</span> <span class=\"variable\">$upstream_http_remote_name</span>;</span><br><span class=\"line\">auth_request_set <span class=\"variable\">$email</span> <span class=\"variable\">$upstream_http_remote_email</span>;</span><br><span class=\"line\">proxy_set_header Remote-User <span class=\"variable\">$user</span>;</span><br><span class=\"line\">proxy_set_header Remote-Groups <span class=\"variable\">$groups</span>;</span><br><span class=\"line\">proxy_set_header Remote-Name <span class=\"variable\">$name</span>;</span><br><span class=\"line\">proxy_set_header Remote-Email <span class=\"variable\">$email</span>;</span><br><span class=\"line\"><span class=\"comment\"># If Authelia returns 401, then nginx redirects the user to the login portal.</span></span><br><span class=\"line\"><span class=\"comment\"># If it returns 200, then the request pass through to the backend.</span></span><br><span class=\"line\"><span class=\"comment\"># For other type of errors, nginx will handle them as usual.</span></span><br><span class=\"line\">error_page 401 =302 https://auth.alidaodao.com/?rd=<span class=\"variable\">$target_url</span>;</span><br></pre></td></tr></table></figure>\n<p>**proxy.conf **文件内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">client_body_buffer_size 128k;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Timeout if the real server is dead</span></span><br><span class=\"line\">proxy_next_upstream error <span class=\"built_in\">timeout</span> invalid_header http_500 http_502 http_503;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Advanced Proxy Config</span></span><br><span class=\"line\">send_timeout 5m;</span><br><span class=\"line\">proxy_read_timeout 360;</span><br><span class=\"line\">proxy_send_timeout 360;</span><br><span class=\"line\">proxy_connect_timeout 360;</span><br><span class=\"line\"><span class=\"comment\"># Basic Proxy Config</span></span><br><span class=\"line\">proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Uri <span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">proxy_set_header X-Forwarded-Ssl on;</span><br><span class=\"line\">proxy_redirect  http://  <span class=\"variable\">$scheme</span>://;</span><br><span class=\"line\"><span class=\"comment\">#proxy_http_version 1.1;</span></span><br><span class=\"line\">proxy_set_header Connection <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">proxy_cache_bypass <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">proxy_no_cache <span class=\"variable\">$cookie_session</span>;</span><br><span class=\"line\">proxy_buffers 64 256k;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If behind reverse proxy, forwards the correct IP</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 10.0.0.0/8;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 172.16.0.0/12;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from 192.168.0.0/16;</span></span><br><span class=\"line\"><span class=\"comment\">#set_real_ip_from fc00::/7;</span></span><br><span class=\"line\"><span class=\"comment\">#real_ip_header X-Forwarded-For;</span></span><br><span class=\"line\"><span class=\"comment\">#real_ip_recursive on;</span></span><br></pre></td></tr></table></figure>\n<p><strong>注意：</strong></p>\n</li>\n<li><p><strong>auth.conf</strong>、<strong>proxy.conf</strong> 文件不需要进行改动，直接保存放入文件夹中即可</p>\n</li>\n<li><p><strong>authelia.conf</strong> <strong>upstream_authelia</strong> 如果authelia使用的是远程的服务，则修改为对应远程地址即可，其他的不用改动</p>\n<h4 id=\"6、使用nginx配置auth-abcd-com-域名\"><a href=\"#6、使用nginx配置auth-abcd-com-域名\" class=\"headerlink\" title=\"6、使用nginx配置auth.abcd.com 域名\"></a>6、使用nginx配置auth.abcd.com 域名</h4><p>文件配置阶段结束了，可以进行实际的应用，除了配置auth的服务域名之外，另外配置一个demo域名来验证auth的sso服务是否可用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream authelia &#123;</span><br><span class=\"line\">  server localhost:9999;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name auth.abcd.com;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 301 https://$server_name<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 443 ssl;</span><br><span class=\"line\">        server_name auth.abcd.com;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        ssl_certificate   cert/authelia.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/authelia.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        access_log  logs/authelia_access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://authelia;</span><br><span class=\"line\">        include /data/nginx/authelia/proxy.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用以上配置来使auth域名对应的服务生效，可以访问<strong>auth.abcd.com</strong>来验证服务是否正常对外提供服务。</p>\n<h4 id=\"7、配置demo-abcd-com域名\"><a href=\"#7、配置demo-abcd-com域名\" class=\"headerlink\" title=\"7、配置demo.abcd.com域名\"></a>7、配置demo.abcd.com域名</h4><p>给<strong>demo.abcd.com</strong>域名配置上SSO服务，在访问<strong>demo.abcd.com</strong>时，如果未进行登录则会跳转到<strong>auth.abcd.com</strong>进行登录，登录成功后会重定向回<strong>demo.abcd.com</strong>，配置文件如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream demo &#123;</span><br><span class=\"line\">  server localhost:8880;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name demo.abcd.com;</span><br><span class=\"line\">        <span class=\"built_in\">return</span> 301 https://$server_name<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 443 ssl;</span><br><span class=\"line\">        server_name demo.abcd.com;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        <span class=\"comment\">#ssl on;</span></span><br><span class=\"line\">        ssl_certificate   cert/demo.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/demo.key;</span><br><span class=\"line\">        ssl_session_timeout 5m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        access_log  logs/demo_access.log  main;</span><br><span class=\"line\">        <span class=\"comment\">#将authelia.conf配置在此处</span></span><br><span class=\"line\">        include /data/nginx/authelia/authelia.conf;</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://demo;</span><br><span class=\"line\">        <span class=\"comment\">#配置auth和代理</span></span><br><span class=\"line\">        include /data/nginx/authelia/auth.conf;</span><br><span class=\"line\">        include /data/nginx/authelia/proxy.conf;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用以上配置即可成功让<strong>demo.abcd.com</strong>网站接入sso服务，来保障<strong>demo.abcd.com</strong>对应的服务不被匿名访问到</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>没有十全十美的工具，只看怎么使用，在使用<a href=\"https://github.com/authelia/authelia\">authelia</a>的过程中也发现了很多的不足：</p>\n</li>\n<li><p>非ldap模式下配置用户比较麻烦，修改完文件后还需要进行重启</p>\n</li>\n<li><p>如果出现如下警告: <strong>nginx: [warn] could not build optimal proxy_headers_hash, you should increase either proxy_headers_hash_max_size: 512 or proxy_headers_hash_bucket_size: 64; ignoring proxy_headers_hash_bucket_size 在nginx.conf 配置文件中加上 以下配置即可。</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proxy_headers_hash_max_size 51200;</span><br><span class=\"line\">proxy_headers_hash_bucket_size 6400;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>这篇文章是自己根据实际经验编写的，如果有错漏之处可以参考<a href=\"https://www.authelia.com/docs/\">官方文档</a></p>\n</li>\n</ul>","categories":[{"name":"SSO","path":"api/categories/SSO.json"}],"tags":[{"name":"LINUX","path":"api/tags/LINUX.json"},{"name":"SSO","path":"api/tags/SSO.json"}]}