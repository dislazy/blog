{"title":"clickhouse和mysql的不同用法之陷入误区","slug":"clickhouse和mysql的不同用法之陷入误区","date":"2021-07-19T14:25:31.000Z","updated":"2022-06-02T01:05:59.615Z","comments":true,"path":"api/articles/clickhouse和mysql的不同用法之陷入误区.json","excerpt":"前言我们的数据计算式基于clickhouse的，由于接触clickhouse不久，看官网介绍语法和mysql是类似的，就放心大胆的使用mysql的大量语法，然后遇到了一个很奇怪的问题，也是这个奇怪的问题让我对列式数据库有了更深入的了解。","covers":["https://imagecdn.bosong.online/blog/column-oriented.gif","https://imagecdn.bosong.online/blog/row-oriented.gif"],"content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>我们的数据计算式基于clickhouse的，由于接触clickhouse不久，看官网介绍语法和mysql是类似的，就放心大胆的使用mysql的大量语法，然后遇到了一个很奇怪的问题，也是这个奇怪的问题让我对列式数据库有了更深入的了解。</p>\n<h3 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h3><p>先了解一下clickhouse对列式数据库的图表述：<br><img src=\"https://imagecdn.bosong.online/blog/column-oriented.gif\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/column-oriented.gif\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"列式数据库\"></p>\n<p>再了解一下mysql的行式数据库的图表述：<br><img src=\"https://imagecdn.bosong.online/blog/row-oriented.gif\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/row-oriented.gif\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"行式数据库\"></p>\n<p>然后下面这样一段sql:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select a,0 as b,0 as c</span><br><span class=\"line\">from tbl_xxx</span><br><span class=\"line\">where del = 1 </span><br><span class=\"line\">and (1&gt;1 or b in (1,2,3) or c in (4,5,6))</span><br><span class=\"line\">group by a,b,c</span><br><span class=\"line\">order by a desc</span><br></pre></td></tr></table></figure>\n<p>这样一段很简单的sql，在clickhouse中却无论如何都查询不出结果，明明在where条件在数据库中满足条件的数据量非常的多，却出现这样奇怪的现象。</p>\n<h3 id=\"排查问题\"><a href=\"#排查问题\" class=\"headerlink\" title=\"排查问题\"></a>排查问题</h3><ul>\n<li>排查到的问题1：以为是<code> 1&gt;1</code>这个语句导致了数据库无法查询出数据，所以将<code>1&gt;1</code> 改成了 <code>2&gt;1</code>，然而能查询出数据了，但是查询出的是全量的数据，所以经过验证后发现该问题无解</li>\n<li>排查到的问题2：突然想到会不会是由于对clikhouse不熟悉导致了相关的问题出现，所以将同样的表在mysql中创建好，并导入一部分数据，这时……，令人惊奇的事情发生了，mysql可以查出对应的数据</li>\n</ul>\n<p>其实通过两个方法就定位到了问题所在，还是比较幸运的，接下来就是解决方案了。</p>\n<h3 id=\"解决问题\"><a href=\"#解决问题\" class=\"headerlink\" title=\"解决问题\"></a>解决问题</h3><p>在经过现象验证后，发现行式数据库是这样的规则，当你查询的数据被你赋值了，其实where中的语句如果有相同的字段，那么直接就是对你赋值的值的查询了，所以 <code>1，2，3</code>怎么可以匹配上<code>0</code>这个数呢。<br>既然发现了问题，解决问题也很简单，有个最简单的方案：</p>\n<ul>\n<li>将b&#x2F;c的select中的列名和group&#x2F;order by中的列名都进行修改，修改为<code>b_tmp</code>,<code>c_tmp</code>即可解决问题了，因为这条sql使用了好几个<code>union all</code>，所以是无法舍弃对应的字段的，否则会报错。</li>\n</ul>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>遇到不熟悉的组件还是要多多查看文档，工欲善其事必先利其器，多看文档，了解一下不同的话也是不会出现这样很简单但是有时候也能让人摸不着头脑的问题了，吃一堑长一智，也让我对列式数据库有了更深的理解。</p>\n\n","more":"\n<h3 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h3><p>先了解一下clickhouse对列式数据库的图表述：<br><img src=\"https://imagecdn.bosong.online/blog/column-oriented.gif\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/column-oriented.gif\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"列式数据库\"></p>\n<p>再了解一下mysql的行式数据库的图表述：<br><img src=\"https://imagecdn.bosong.online/blog/row-oriented.gif\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/row-oriented.gif\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"行式数据库\"></p>\n<p>然后下面这样一段sql:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select a,0 as b,0 as c</span><br><span class=\"line\">from tbl_xxx</span><br><span class=\"line\">where del = 1 </span><br><span class=\"line\">and (1&gt;1 or b in (1,2,3) or c in (4,5,6))</span><br><span class=\"line\">group by a,b,c</span><br><span class=\"line\">order by a desc</span><br></pre></td></tr></table></figure>\n<p>这样一段很简单的sql，在clickhouse中却无论如何都查询不出结果，明明在where条件在数据库中满足条件的数据量非常的多，却出现这样奇怪的现象。</p>\n<h3 id=\"排查问题\"><a href=\"#排查问题\" class=\"headerlink\" title=\"排查问题\"></a>排查问题</h3><ul>\n<li>排查到的问题1：以为是<code> 1&gt;1</code>这个语句导致了数据库无法查询出数据，所以将<code>1&gt;1</code> 改成了 <code>2&gt;1</code>，然而能查询出数据了，但是查询出的是全量的数据，所以经过验证后发现该问题无解</li>\n<li>排查到的问题2：突然想到会不会是由于对clikhouse不熟悉导致了相关的问题出现，所以将同样的表在mysql中创建好，并导入一部分数据，这时……，令人惊奇的事情发生了，mysql可以查出对应的数据</li>\n</ul>\n<p>其实通过两个方法就定位到了问题所在，还是比较幸运的，接下来就是解决方案了。</p>\n<h3 id=\"解决问题\"><a href=\"#解决问题\" class=\"headerlink\" title=\"解决问题\"></a>解决问题</h3><p>在经过现象验证后，发现行式数据库是这样的规则，当你查询的数据被你赋值了，其实where中的语句如果有相同的字段，那么直接就是对你赋值的值的查询了，所以 <code>1，2，3</code>怎么可以匹配上<code>0</code>这个数呢。<br>既然发现了问题，解决问题也很简单，有个最简单的方案：</p>\n<ul>\n<li>将b&#x2F;c的select中的列名和group&#x2F;order by中的列名都进行修改，修改为<code>b_tmp</code>,<code>c_tmp</code>即可解决问题了，因为这条sql使用了好几个<code>union all</code>，所以是无法舍弃对应的字段的，否则会报错。</li>\n</ul>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>遇到不熟悉的组件还是要多多查看文档，工欲善其事必先利其器，多看文档，了解一下不同的话也是不会出现这样很简单但是有时候也能让人摸不着头脑的问题了，吃一堑长一智，也让我对列式数据库有了更深的理解。</p>\n\n","categories":[{"name":"ClickHouse","path":"api/categories/ClickHouse.json"}],"tags":[{"name":"ClickHouse","path":"api/tags/ClickHouse.json"},{"name":"Mysql","path":"api/tags/Mysql.json"}]}