{"title":"mysql中间件-Atlas初步试用","slug":"mysql中间件-Atlas初步试用","date":"2018-10-12T02:10:42.000Z","updated":"2022-06-02T01:05:59.616Z","comments":true,"path":"api/articles/mysql中间件-Atlas初步试用.json","excerpt":"前言Atlas是360开源的mysql数据库中间件，主要致力于读写分离，分片等操作，降低数据库与后端耦合性。","covers":null,"content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>Atlas是360开源的mysql数据库中间件，主要致力于读写分离，分片等操作，降低数据库与后端耦合性。</p>\n<h3 id=\"踩坑过程\"><a href=\"#踩坑过程\" class=\"headerlink\" title=\"踩坑过程\"></a>踩坑过程</h3><p>下载地址 <code>https://github.com/Qihoo360/Atlas/releases</code></p>\n<p>下载rpm 版本 直接 rpm -i 文件.rpm进行安装即可</p>\n<p>安装好之后文件在&#x2F;usr&#x2F;local&#x2F;mysql-proxy文件夹中</p>\n<p>配置conf&#x2F;test.cnf </p>\n<p>如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[mysql-proxy]</span><br><span class=\"line\"></span><br><span class=\"line\">#带#号的为非必需的配置项目</span><br><span class=\"line\">#模块名称</span><br><span class=\"line\">plugins = admin, proxy</span><br><span class=\"line\"></span><br><span class=\"line\">#管理接口的用户名</span><br><span class=\"line\">admin-username = root</span><br><span class=\"line\"></span><br><span class=\"line\">#管理接口的密码</span><br><span class=\"line\">admin-password = password</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#实现管理接口的Lua脚本所在路径</span><br><span class=\"line\">admin-lua-script = /usr/local/mysql-proxy/lib/mysql-proxy/lua/admin.lua</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas后端连接的MySQL主库的IP和端口，可设置多项，用逗号分隔</span><br><span class=\"line\">proxy-backend-addresses = 192.168.1.1:3306</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas后端连接的MySQL从库的IP和端口，@后面的数字代表权重，用来作负载均衡，若省略则默认为1，可设置多项，用逗号分隔</span><br><span class=\"line\">proxy-read-only-backend-addresses = 192.168.1.2:3306@1</span><br><span class=\"line\"></span><br><span class=\"line\">#用户名与其对应的加密过的MySQL密码，密码使用PREFIX/bin目录下的加密程序encrypt加密，下行的user1和user2为示例，将其替换为你的MySQL的用户名和加密密码！</span><br><span class=\"line\">pwds = root:m+06L1D7s0r4BeIIXLqb3w==,  root:m+06L1D7s0r4BeIIXLqb3w==</span><br><span class=\"line\"></span><br><span class=\"line\">#设置Atlas的运行方式，设为true时为守护进程方式，设为false时为前台方式，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class=\"line\">daemon = true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置Atlas的运行方式，设为true时Atlas会启动两个进程，一个为monitor，一个为worker，monitor在worker意外退出后会自动将其重启，设为false时只有worker，没有monitor，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class=\"line\">keepalive = true</span><br><span class=\"line\"></span><br><span class=\"line\">#工作线程数，对Atlas的性能有很大影响，可根据情况适当设置</span><br><span class=\"line\">event-threads = 4</span><br><span class=\"line\"></span><br><span class=\"line\">#日志级别，分为message、warning、critical、error、debug五个级别</span><br><span class=\"line\">log-level = debug</span><br><span class=\"line\"></span><br><span class=\"line\">#日志存放的路径</span><br><span class=\"line\">log-path = /usr/local/mysql-proxy/log</span><br><span class=\"line\"></span><br><span class=\"line\">#SQL日志的开关，可设置为OFF、ON、REALTIME，OFF代表不记录SQL日志，ON代表记录SQL日志，REALTIME代表记录SQL日志且实时写入磁盘，默认为OFF</span><br><span class=\"line\">sql-log = ON</span><br><span class=\"line\"></span><br><span class=\"line\">#慢日志输出设置。当设置了该参数时，则日志只输出执行时间超过sql-log-slow（单位：ms)的日志记录。不设置该参数则输出全部日志。</span><br><span class=\"line\">sql-log-slow = 10</span><br><span class=\"line\"></span><br><span class=\"line\">#实例名称，用于同一台机器上多个Atlas实例间的区分</span><br><span class=\"line\">#instance = test</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas监听的工作接口IP和端口</span><br><span class=\"line\">proxy-address = 0.0.0.0:31523</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas监听的管理接口IP和端口</span><br><span class=\"line\">admin-address = 0.0.0.0:31524</span><br><span class=\"line\"></span><br><span class=\"line\">#分表设置，此例中person为库名，mt为表名，id为分表字段，3为子表数量，可设置多项，以逗号分隔，若不分表则不需要设置该项</span><br><span class=\"line\">#tables = person.mt.id.3</span><br><span class=\"line\"></span><br><span class=\"line\">#默认字符集，设置该项后客户端不再需要执行SET NAMES语句</span><br><span class=\"line\">#charset = utf8</span><br><span class=\"line\"></span><br><span class=\"line\">#允许连接Atlas的客户端的IP，可以是精确IP，也可以是IP段，以逗号分隔，若不设置该项则允许所有IP连接，否则只允许列表中的IP连接</span><br><span class=\"line\">#client-ips = 127.0.0.1, 192.168.1</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas前面挂接的LVS的物理网卡的IP(注意不是虚IP)，若有LVS且设置了client-ips则此项必须设置，否则可以不设置</span><br><span class=\"line\">#lvs-ips = 192.168.1.1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>启动方式有两种 一种是官方介绍的<code> /usr/local/mysql-proxy/bin/mycat start</code>   或者<code>/usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</code></p>\n<p>哪个能用用哪个，中间件配好以后，直接使用Navicat连接，连接数据库后可显示两台机器的综合库，数据为两库数据重合部分与不重合部分数据。</p>\n<p>使用java-druid连接后，中文乱码，给mysql连接加上<code>characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true</code>参数即可，读写分离明显。</p>\n<p>以上，现阶段还在学习中，后续。</p>\n\n","more":"\n<h3 id=\"踩坑过程\"><a href=\"#踩坑过程\" class=\"headerlink\" title=\"踩坑过程\"></a>踩坑过程</h3><p>下载地址 <code>https://github.com/Qihoo360/Atlas/releases</code></p>\n<p>下载rpm 版本 直接 rpm -i 文件.rpm进行安装即可</p>\n<p>安装好之后文件在&#x2F;usr&#x2F;local&#x2F;mysql-proxy文件夹中</p>\n<p>配置conf&#x2F;test.cnf </p>\n<p>如下所示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[mysql-proxy]</span><br><span class=\"line\"></span><br><span class=\"line\">#带#号的为非必需的配置项目</span><br><span class=\"line\">#模块名称</span><br><span class=\"line\">plugins = admin, proxy</span><br><span class=\"line\"></span><br><span class=\"line\">#管理接口的用户名</span><br><span class=\"line\">admin-username = root</span><br><span class=\"line\"></span><br><span class=\"line\">#管理接口的密码</span><br><span class=\"line\">admin-password = password</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#实现管理接口的Lua脚本所在路径</span><br><span class=\"line\">admin-lua-script = /usr/local/mysql-proxy/lib/mysql-proxy/lua/admin.lua</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas后端连接的MySQL主库的IP和端口，可设置多项，用逗号分隔</span><br><span class=\"line\">proxy-backend-addresses = 192.168.1.1:3306</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas后端连接的MySQL从库的IP和端口，@后面的数字代表权重，用来作负载均衡，若省略则默认为1，可设置多项，用逗号分隔</span><br><span class=\"line\">proxy-read-only-backend-addresses = 192.168.1.2:3306@1</span><br><span class=\"line\"></span><br><span class=\"line\">#用户名与其对应的加密过的MySQL密码，密码使用PREFIX/bin目录下的加密程序encrypt加密，下行的user1和user2为示例，将其替换为你的MySQL的用户名和加密密码！</span><br><span class=\"line\">pwds = root:m+06L1D7s0r4BeIIXLqb3w==,  root:m+06L1D7s0r4BeIIXLqb3w==</span><br><span class=\"line\"></span><br><span class=\"line\">#设置Atlas的运行方式，设为true时为守护进程方式，设为false时为前台方式，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class=\"line\">daemon = true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置Atlas的运行方式，设为true时Atlas会启动两个进程，一个为monitor，一个为worker，monitor在worker意外退出后会自动将其重启，设为false时只有worker，没有monitor，一般开发调试时设为false，线上运行时设为true,true后面不能有空格。</span><br><span class=\"line\">keepalive = true</span><br><span class=\"line\"></span><br><span class=\"line\">#工作线程数，对Atlas的性能有很大影响，可根据情况适当设置</span><br><span class=\"line\">event-threads = 4</span><br><span class=\"line\"></span><br><span class=\"line\">#日志级别，分为message、warning、critical、error、debug五个级别</span><br><span class=\"line\">log-level = debug</span><br><span class=\"line\"></span><br><span class=\"line\">#日志存放的路径</span><br><span class=\"line\">log-path = /usr/local/mysql-proxy/log</span><br><span class=\"line\"></span><br><span class=\"line\">#SQL日志的开关，可设置为OFF、ON、REALTIME，OFF代表不记录SQL日志，ON代表记录SQL日志，REALTIME代表记录SQL日志且实时写入磁盘，默认为OFF</span><br><span class=\"line\">sql-log = ON</span><br><span class=\"line\"></span><br><span class=\"line\">#慢日志输出设置。当设置了该参数时，则日志只输出执行时间超过sql-log-slow（单位：ms)的日志记录。不设置该参数则输出全部日志。</span><br><span class=\"line\">sql-log-slow = 10</span><br><span class=\"line\"></span><br><span class=\"line\">#实例名称，用于同一台机器上多个Atlas实例间的区分</span><br><span class=\"line\">#instance = test</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas监听的工作接口IP和端口</span><br><span class=\"line\">proxy-address = 0.0.0.0:31523</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas监听的管理接口IP和端口</span><br><span class=\"line\">admin-address = 0.0.0.0:31524</span><br><span class=\"line\"></span><br><span class=\"line\">#分表设置，此例中person为库名，mt为表名，id为分表字段，3为子表数量，可设置多项，以逗号分隔，若不分表则不需要设置该项</span><br><span class=\"line\">#tables = person.mt.id.3</span><br><span class=\"line\"></span><br><span class=\"line\">#默认字符集，设置该项后客户端不再需要执行SET NAMES语句</span><br><span class=\"line\">#charset = utf8</span><br><span class=\"line\"></span><br><span class=\"line\">#允许连接Atlas的客户端的IP，可以是精确IP，也可以是IP段，以逗号分隔，若不设置该项则允许所有IP连接，否则只允许列表中的IP连接</span><br><span class=\"line\">#client-ips = 127.0.0.1, 192.168.1</span><br><span class=\"line\"></span><br><span class=\"line\">#Atlas前面挂接的LVS的物理网卡的IP(注意不是虚IP)，若有LVS且设置了client-ips则此项必须设置，否则可以不设置</span><br><span class=\"line\">#lvs-ips = 192.168.1.1</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>启动方式有两种 一种是官方介绍的<code> /usr/local/mysql-proxy/bin/mycat start</code>   或者<code>/usr/local/mysql-proxy/bin/mysql-proxy --defaults-file=/usr/local/mysql-proxy/conf/test.cnf</code></p>\n<p>哪个能用用哪个，中间件配好以后，直接使用Navicat连接，连接数据库后可显示两台机器的综合库，数据为两库数据重合部分与不重合部分数据。</p>\n<p>使用java-druid连接后，中文乱码，给mysql连接加上<code>characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true</code>参数即可，读写分离明显。</p>\n<p>以上，现阶段还在学习中，后续。</p>\n\n","categories":[{"name":"中间件","path":"api/categories/中间件.json"}],"tags":[{"name":"数据库中间件","path":"api/tags/数据库中间件.json"}]}