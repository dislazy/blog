{"title":"线上事故记录-docker与Java的恩怨情仇","slug":"线上事故记录-docker与Java的恩怨情仇","date":"2020-04-01T13:30:30.000Z","updated":"2022-06-02T01:05:59.618Z","comments":true,"path":"api/articles/线上事故记录-docker与Java的恩怨情仇.json","excerpt":"起因上周五新建了一个项目，在开发完成后，和运维沟通准备上到生产环境中，套用了现有服务的通用启动命名行：","covers":["https://imagecdn.bosong.online/blog/1585746996556.png"],"content":"<h3 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h3><p>上周五新建了一个项目，在开发完成后，和运维沟通准备上到生产环境中，套用了现有服务的通用启动命名行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar Xms3072m -Xmx8192m app.jar &amp; 2&gt;1</span><br></pre></td></tr></table></figure>\n\n<p>然后一切准备就绪，jenkins打包一切顺利，然后顺利部署到生产环境，由于前端项目暂未部署，k8s使用的内网集群通信，暂时没有办法调用接口进行服务部署成功验证，但是在测试环境进行了充分测试，一切OK 。</p>\n<p>在周五即将下班的时候，运维给我这边发消息，说我的服务没有部署成功,然后把日志给我发了过来，内容大致如下：</p>\n<p><img src=\"https://imagecdn.bosong.online/blog/1585746996556.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/1585746996556.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"日志\"></p>\n<p>服务启动日志并没有出现JVM的字样，日志一直没有打下去</p>\n<h3 id=\"经过\"><a href=\"#经过\" class=\"headerlink\" title=\"经过\"></a>经过</h3><p>经过排查，发现服务没启动完成，突然想起来前几天碰到一个问题，就是当内存不足时，docker会自动kill掉容器。最终确认是服务的相关资源配置没给到位，被docker给强制关闭了。</p>\n<p>询问运维给的相关配置内存为1G,但是我启动时设置的最小初始化内存为3G，此时被k8s认为资源不足，给kill掉，导致服务无限重启</p>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>调整了启动参数为1G，服务顺利启动。</p>\n<h3 id=\"反思\"><a href=\"#反思\" class=\"headerlink\" title=\"反思\"></a>反思</h3><p>该问题其实是一个非常简单的启动参数设置不合理导致的服务无法启动问题，也引申到了docker容器当内存不足时会自动kill掉相关容器的坑，所以需要记住合理配置服务的启动参数，另外尽量合理分配资源，让服务平稳安全运行。</p>\n\n","more":"\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar Xms3072m -Xmx8192m app.jar &amp; 2&gt;1</span><br></pre></td></tr></table></figure>\n\n<p>然后一切准备就绪，jenkins打包一切顺利，然后顺利部署到生产环境，由于前端项目暂未部署，k8s使用的内网集群通信，暂时没有办法调用接口进行服务部署成功验证，但是在测试环境进行了充分测试，一切OK 。</p>\n<p>在周五即将下班的时候，运维给我这边发消息，说我的服务没有部署成功,然后把日志给我发了过来，内容大致如下：</p>\n<p><img src=\"https://imagecdn.bosong.online/blog/1585746996556.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/blog/1585746996556.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"日志\"></p>\n<p>服务启动日志并没有出现JVM的字样，日志一直没有打下去</p>\n<h3 id=\"经过\"><a href=\"#经过\" class=\"headerlink\" title=\"经过\"></a>经过</h3><p>经过排查，发现服务没启动完成，突然想起来前几天碰到一个问题，就是当内存不足时，docker会自动kill掉容器。最终确认是服务的相关资源配置没给到位，被docker给强制关闭了。</p>\n<p>询问运维给的相关配置内存为1G,但是我启动时设置的最小初始化内存为3G，此时被k8s认为资源不足，给kill掉，导致服务无限重启</p>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>调整了启动参数为1G，服务顺利启动。</p>\n<h3 id=\"反思\"><a href=\"#反思\" class=\"headerlink\" title=\"反思\"></a>反思</h3><p>该问题其实是一个非常简单的启动参数设置不合理导致的服务无法启动问题，也引申到了docker容器当内存不足时会自动kill掉相关容器的坑，所以需要记住合理配置服务的启动参数，另外尽量合理分配资源，让服务平稳安全运行。</p>\n\n","categories":[{"name":"Java","path":"api/categories/Java.json"}],"tags":[{"name":"Java","path":"api/tags/Java.json"}]}