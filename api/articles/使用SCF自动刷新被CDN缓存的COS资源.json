{"title":"使用 SCF 自动刷新被 CDN 缓存的 COS 资源","slug":"使用SCF自动刷新被CDN缓存的COS资源","date":"2019-01-16T10:45:26.000Z","updated":"2022-06-02T01:05:59.617Z","comments":true,"path":"api/articles/使用SCF自动刷新被CDN缓存的COS资源.json","excerpt":"背景当静态内容需要更新时，通常会往 COS 覆盖上传一个更新版本的资源或删除该资源。当重新部署时，则 CDN 的某些边缘节点可能会仍然缓存旧资源。缓存过期时间太短，则会影响到加速的效果。","covers":["https://imagecdn.bosong.online/image/332edc2828575a4c802a9af9cb233b08.png","https://imagecdn.bosong.online/image/70e9dbae0471dd8cd50ffa724eb089f4.png","https://imagecdn.bosong.online/image/b2b0eba560e3229fc402490f0737712b.png","https://imagecdn.bosong.online/image/01D98E79-449B-4253-9041-1CA2F0C63844.png","https://imagecdn.bosong.online/image/9672da05b98748a5ef06da393ec64d04.png","https://imagecdn.bosong.online/image/8f3b5efab6a30b008fd1b8e12eafb1e0.png"],"content":"<h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p>当静态内容需要更新时，通常会往 COS 覆盖上传一个更新版本的资源或删除该资源。当重新部署时，则 CDN 的某些边缘节点可能会仍然缓存旧资源。缓存过期时间太短，则会影响到加速的效果。</p>\n<p>根据上述情况，需要使用 CDN 控制台上的 缓存刷新 功能，对指定 URL 进行手动刷新操作，实现删除无效缓存文件或者更新资源。</p>\n<p>在此将结合 COS 和 SCF 的功能特性，在 COS 文件更新时，实现自动刷新 CDN 缓存的效果。</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><ol>\n<li>腾讯云账户，需具备 COS、CDN、SCF 等产品的访问权限。</li>\n<li>创建存储桶，并在该存储桶上绑定了 CDN 加速域名。</li>\n<li>确保 COS 的存储桶的所属地域支持 SCF 产品功能，暂不支持跨地域调用。</li>\n<li>准备好可调用 CDN 刷新接口的云 API 密钥，以及下载 SCF 刷新 CDN 示例代码。</li>\n</ol>\n<h3 id=\"工作步骤\"><a href=\"#工作步骤\" class=\"headerlink\" title=\"工作步骤\"></a>工作步骤</h3><h4 id=\"创建SCF函数\"><a href=\"#创建SCF函数\" class=\"headerlink\" title=\"创建SCF函数\"></a>创建SCF函数</h4><ol>\n<li>登录 SCF 控制台，单击函数服务，选择与静态内容相同的地域并创建函数。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/332edc2828575a4c802a9af9cb233b08.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/332edc2828575a4c802a9af9cb233b08.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>在 “新建函数” 页面，选择 “空白函数”，输入函数名称（如 refresh_cdn），设置运行环境（示例代码使用 Node.js 语言，因此运行环境设置为 Nodejs 6.10）。确认配置无误后单击【完成】即可。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/70e9dbae0471dd8cd50ffa724eb089f4.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/70e9dbae0471dd8cd50ffa724eb089f4.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"><h4 id=\"配置函数\"><a href=\"#配置函数\" class=\"headerlink\" title=\"配置函数\"></a>配置函数</h4>空白函数创建完成后，需添加对应的函数代码，并设定触发方式，使函数可以正常工作。</li>\n</ol>\n<h5 id=\"配置函数代码\"><a href=\"#配置函数代码\" class=\"headerlink\" title=\"配置函数代码\"></a>配置函数代码</h5><ol>\n<li>下载 <a href=\"https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip\">SCF 刷新 CDN 示例代码</a>。</li>\n<li>解压所有文件，找到其中的 index.js 文件并打开。</li>\n<li>在代码里修改替换成您的具备调用 CDN 刷新接口权限的 SecretId、SecretKey 和需要刷新的域名。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/b2b0eba560e3229fc402490f0737712b.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/b2b0eba560e3229fc402490f0737712b.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>如需调用刷新绑定在腾讯云海外 CDN 上的域名，请将代码中的 RefreshCdnUrl 修改为 RefreshCdnOverSeaUrl。<h5 id=\"上传函数代码\"><a href=\"#上传函数代码\" class=\"headerlink\" title=\"上传函数代码\"></a>上传函数代码</h5></li>\n<li>将修改好的代码和其他文件重新压缩打包为 zip 格式文件。zip结构如下所示：<br><img src=\"https://imagecdn.bosong.online/image/01D98E79-449B-4253-9041-1CA2F0C63844.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/01D98E79-449B-4253-9041-1CA2F0C63844.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>在 SCF 控制台中，选择 “函数代码” 页签，将 “提交方法” 设置为 “本地上传 zip 包”，并选择刚压缩的 zip 格式文件，单击【上传】。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/9672da05b98748a5ef06da393ec64d04.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/9672da05b98748a5ef06da393ec64d04.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n</ol>\n<h5 id=\"添加触发方式\"><a href=\"#添加触发方式\" class=\"headerlink\" title=\"添加触发方式\"></a>添加触发方式</h5><ol>\n<li>在 SCF 控制台中，选择 “触发方式” 页签，单击【添加触发方式】。</li>\n<li>将 “触发方式” 设置为 “COS 触发”，并选择需刷新 COS 资源的存储桶。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/8f3b5efab6a30b008fd1b8e12eafb1e0.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/8f3b5efab6a30b008fd1b8e12eafb1e0.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>根据实际需求，设置事件类型。<ul>\n<li>如果仅需要自动刷新 CDN 访问覆盖上传到 COS 的对象，则需将 “事件类型” 设置为 “文件上传”。</li>\n<li>如果同时需要对删除行为也进行自动刷新，则需再添加一种触发方式，并将 “事件类型” 设置为 “文件删除”</li>\n</ul>\n</li>\n<li>勾选立即启用。</li>\n<li>最后确认配置信息无误后，单击【保存】。</li>\n</ol>\n<h3 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h3><p>上传一个新文件后再次访问即可验证。</p>\n\n","more":"\n<p>根据上述情况，需要使用 CDN 控制台上的 缓存刷新 功能，对指定 URL 进行手动刷新操作，实现删除无效缓存文件或者更新资源。</p>\n<p>在此将结合 COS 和 SCF 的功能特性，在 COS 文件更新时，实现自动刷新 CDN 缓存的效果。</p>\n<h3 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h3><ol>\n<li>腾讯云账户，需具备 COS、CDN、SCF 等产品的访问权限。</li>\n<li>创建存储桶，并在该存储桶上绑定了 CDN 加速域名。</li>\n<li>确保 COS 的存储桶的所属地域支持 SCF 产品功能，暂不支持跨地域调用。</li>\n<li>准备好可调用 CDN 刷新接口的云 API 密钥，以及下载 SCF 刷新 CDN 示例代码。</li>\n</ol>\n<h3 id=\"工作步骤\"><a href=\"#工作步骤\" class=\"headerlink\" title=\"工作步骤\"></a>工作步骤</h3><h4 id=\"创建SCF函数\"><a href=\"#创建SCF函数\" class=\"headerlink\" title=\"创建SCF函数\"></a>创建SCF函数</h4><ol>\n<li>登录 SCF 控制台，单击函数服务，选择与静态内容相同的地域并创建函数。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/332edc2828575a4c802a9af9cb233b08.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/332edc2828575a4c802a9af9cb233b08.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>在 “新建函数” 页面，选择 “空白函数”，输入函数名称（如 refresh_cdn），设置运行环境（示例代码使用 Node.js 语言，因此运行环境设置为 Nodejs 6.10）。确认配置无误后单击【完成】即可。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/70e9dbae0471dd8cd50ffa724eb089f4.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/70e9dbae0471dd8cd50ffa724eb089f4.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"><h4 id=\"配置函数\"><a href=\"#配置函数\" class=\"headerlink\" title=\"配置函数\"></a>配置函数</h4>空白函数创建完成后，需添加对应的函数代码，并设定触发方式，使函数可以正常工作。</li>\n</ol>\n<h5 id=\"配置函数代码\"><a href=\"#配置函数代码\" class=\"headerlink\" title=\"配置函数代码\"></a>配置函数代码</h5><ol>\n<li>下载 <a href=\"https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip\">SCF 刷新 CDN 示例代码</a>。</li>\n<li>解压所有文件，找到其中的 index.js 文件并打开。</li>\n<li>在代码里修改替换成您的具备调用 CDN 刷新接口权限的 SecretId、SecretKey 和需要刷新的域名。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/b2b0eba560e3229fc402490f0737712b.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/b2b0eba560e3229fc402490f0737712b.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>如需调用刷新绑定在腾讯云海外 CDN 上的域名，请将代码中的 RefreshCdnUrl 修改为 RefreshCdnOverSeaUrl。<h5 id=\"上传函数代码\"><a href=\"#上传函数代码\" class=\"headerlink\" title=\"上传函数代码\"></a>上传函数代码</h5></li>\n<li>将修改好的代码和其他文件重新压缩打包为 zip 格式文件。zip结构如下所示：<br><img src=\"https://imagecdn.bosong.online/image/01D98E79-449B-4253-9041-1CA2F0C63844.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/01D98E79-449B-4253-9041-1CA2F0C63844.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>在 SCF 控制台中，选择 “函数代码” 页签，将 “提交方法” 设置为 “本地上传 zip 包”，并选择刚压缩的 zip 格式文件，单击【上传】。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/9672da05b98748a5ef06da393ec64d04.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/9672da05b98748a5ef06da393ec64d04.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n</ol>\n<h5 id=\"添加触发方式\"><a href=\"#添加触发方式\" class=\"headerlink\" title=\"添加触发方式\"></a>添加触发方式</h5><ol>\n<li>在 SCF 控制台中，选择 “触发方式” 页签，单击【添加触发方式】。</li>\n<li>将 “触发方式” 设置为 “COS 触发”，并选择需刷新 COS 资源的存储桶。如下图所示：<br><img src=\"https://imagecdn.bosong.online/image/8f3b5efab6a30b008fd1b8e12eafb1e0.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/8f3b5efab6a30b008fd1b8e12eafb1e0.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\"></li>\n<li>根据实际需求，设置事件类型。<ul>\n<li>如果仅需要自动刷新 CDN 访问覆盖上传到 COS 的对象，则需将 “事件类型” 设置为 “文件上传”。</li>\n<li>如果同时需要对删除行为也进行自动刷新，则需再添加一种触发方式，并将 “事件类型” 设置为 “文件删除”</li>\n</ul>\n</li>\n<li>勾选立即启用。</li>\n<li>最后确认配置信息无误后，单击【保存】。</li>\n</ol>\n<h3 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h3><p>上传一个新文件后再次访问即可验证。</p>\n\n","categories":[{"name":"技术手册","path":"api/categories/技术手册.json"}],"tags":[{"name":"cdn","path":"api/tags/cdn.json"}]}