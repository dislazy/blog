{"title":"nginx配置https和跨域设置","slug":"Nginx配置https和跨域设置","date":"2020-04-19T00:11:53.000Z","updated":"2022-06-02T01:05:59.614Z","comments":true,"path":"api/articles/Nginx配置https和跨域设置.json","excerpt":"为了网站快速响应，经常需要将前端页面放在cdn上，此时就需要后端服务支持跨域访问，所以记录一下在tengine上的配置，用于集中管理多个服务和支持服务的跨域访问设置。关于nginx的安装可以参照 https://blog.bosong.online/Linux%E5%AE%89%E8%A3%85Nginx.html","covers":null,"content":"<p>为了网站快速响应，经常需要将前端页面放在cdn上，此时就需要后端服务支持跨域访问，所以</p>\n<p>记录一下在tengine上的配置，用于集中管理多个服务和支持服务的跨域访问设置。关于nginx的安装可以参照 <a href=\"https://blog.bosong.online/Linux%E5%AE%89%E8%A3%85Nginx.html\">https://blog.bosong.online/Linux%E5%AE%89%E8%A3%85Nginx.html</a></p>\n<h3 id=\"第一步-将配置文件进行分离\"><a href=\"#第一步-将配置文件进行分离\" class=\"headerlink\" title=\"第一步 将配置文件进行分离\"></a>第一步 将配置文件进行分离</h3><p>使用<code>vi nginx.conf</code>编辑<code>nginx</code>的配置文件，改成如下配置</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#user  nobody;</span><br><span class=\"line\">worker_processes  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>;</span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>  notice;</span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>  info;</span><br><span class=\"line\">error_log  <span class=\"string\">&quot;pipe:rollback logs/error_log interval=1d baknum=7 maxsize=2G&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">pid        logs/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  <span class=\"number\">1024</span>; #根据实际情况进行修改</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">\t#设置日志格式</span><br><span class=\"line\">    log_format  main  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\">\t//对日志进行设置</span><br><span class=\"line\">    access_log  <span class=\"string\">&quot;pipe:rollback logs/access_log interval=1d baknum=7 maxsize=2G&quot;</span>  main;</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    keepalive_timeout  <span class=\"number\">65</span>;</span><br><span class=\"line\">    server_names_hash_bucket_size <span class=\"number\">128</span>;</span><br><span class=\"line\">    client_header_buffer_size <span class=\"number\">32</span>k;</span><br><span class=\"line\">    large_client_header_buffers <span class=\"number\">4</span> <span class=\"number\">32</span>k;</span><br><span class=\"line\">    client_max_body_size <span class=\"number\">8</span>m;</span><br><span class=\"line\">    tcp_nopush     on;</span><br><span class=\"line\">    gzip  on;</span><br><span class=\"line\">    //将所有的后端服务的配置都放在domain文件夹中管理</span><br><span class=\"line\">    include domain/*.conf;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"第二步-创建单独的配置文件，以nacos-conf为例\"><a href=\"#第二步-创建单独的配置文件，以nacos-conf为例\" class=\"headerlink\" title=\"第二步 创建单独的配置文件，以nacos.conf为例\"></a>第二步 创建单独的配置文件，以<code>nacos.conf</code>为例</h3><p>在<code>nginx/conf</code>文件夹下创建<code>domain</code> 和 <code>cert</code>文件夹<code>，然后将nacos.conf放入</code>domain&#96;文件夹中</p>\n<ul>\n<li>domain 存放单个服务的配置文件</li>\n<li>cert 如果网站是<code>https</code>，将相关证书放入<code>cert</code>文件夹中</li>\n</ul>\n<p><code>nacos.conf</code>配置如下</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream nacos_server &#123;</span><br><span class=\"line\">        server <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">8448</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">        server <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">8449</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># http 强制跳转https</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen <span class=\"number\">80</span>;</span><br><span class=\"line\">        server_name nacos.bosong.online;</span><br><span class=\"line\">        rewrite ^ https://$http_host$request_uri? permanent;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">        server_name nacos.bosong.online;</span><br><span class=\"line\">        charset utf<span class=\"number\">-8</span>;</span><br><span class=\"line\">    \t#单独的域名访问日志</span><br><span class=\"line\">        access_log  logs/<span class=\"built_in\">config</span>.access.<span class=\"built_in\">log</span>  main;</span><br><span class=\"line\">\t#放置证书文件</span><br><span class=\"line\">        ssl_certificate   cert/<span class=\"built_in\">config</span>.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/<span class=\"built_in\">config</span>.key;</span><br><span class=\"line\">        ssl_session_timeout <span class=\"number\">5</span>m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1<span class=\"number\">.1</span> TLSv1<span class=\"number\">.2</span>;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">        \t\t#跨域配置-允许当前的域名访问</span><br><span class=\"line\">                add_header Access-Control-Allow-Origin <span class=\"string\">&#x27;$http_origin&#x27;</span>;</span><br><span class=\"line\">        \t\t#允许携带凭证</span><br><span class=\"line\">                add_header Access-Control-Allow-Credentials <span class=\"string\">&#x27;true&#x27;</span>;</span><br><span class=\"line\">        \t\t#允许请求类型-根据实际情况自定义</span><br><span class=\"line\">                add_header Access-Control-Allow-Methods <span class=\"string\">&#x27;GET, POST, OPTIONS, PUT, DELETE&#x27;</span>;\t</span><br><span class=\"line\">        \t\t#允许携带的请求头，根据网站实际情况修改</span><br><span class=\"line\">                add_header Access-Control-Allow-Headers <span class=\"string\">&#x27;Cookie,Set-Cookie,x-requested-with,content-type,Authorization,accessToken,authorization,accesstoken&#x27;</span>;</span><br><span class=\"line\">        \t\t#需要代理的后端服务，可负载均衡 </span><br><span class=\"line\">                proxy_pass http://nacos_server;</span><br><span class=\"line\">       \t\t\t#OPTIONS请求直接返回<span class=\"number\">200</span>或者<span class=\"number\">204</span>即可</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ($request_method = <span class=\"string\">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"更加深入的探索\"><a href=\"#更加深入的探索\" class=\"headerlink\" title=\"更加深入的探索\"></a>更加深入的探索</h3><p>在这里没有对安全性方面进行加强，如果网站需要更高安全性，可以根据实际需要在配置中增加安全性的相关配置。</p>\n\n","more":"\n<h3 id=\"第一步-将配置文件进行分离\"><a href=\"#第一步-将配置文件进行分离\" class=\"headerlink\" title=\"第一步 将配置文件进行分离\"></a>第一步 将配置文件进行分离</h3><p>使用<code>vi nginx.conf</code>编辑<code>nginx</code>的配置文件，改成如下配置</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#user  nobody;</span><br><span class=\"line\">worker_processes  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>;</span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>  notice;</span><br><span class=\"line\">error_log  logs/<span class=\"built_in\">error</span>.<span class=\"built_in\">log</span>  info;</span><br><span class=\"line\">error_log  <span class=\"string\">&quot;pipe:rollback logs/error_log interval=1d baknum=7 maxsize=2G&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">pid        logs/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections  <span class=\"number\">1024</span>; #根据实际情况进行修改</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    default_type  application/octet-stream;</span><br><span class=\"line\">\t#设置日志格式</span><br><span class=\"line\">    log_format  main  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\">\t//对日志进行设置</span><br><span class=\"line\">    access_log  <span class=\"string\">&quot;pipe:rollback logs/access_log interval=1d baknum=7 maxsize=2G&quot;</span>  main;</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    keepalive_timeout  <span class=\"number\">65</span>;</span><br><span class=\"line\">    server_names_hash_bucket_size <span class=\"number\">128</span>;</span><br><span class=\"line\">    client_header_buffer_size <span class=\"number\">32</span>k;</span><br><span class=\"line\">    large_client_header_buffers <span class=\"number\">4</span> <span class=\"number\">32</span>k;</span><br><span class=\"line\">    client_max_body_size <span class=\"number\">8</span>m;</span><br><span class=\"line\">    tcp_nopush     on;</span><br><span class=\"line\">    gzip  on;</span><br><span class=\"line\">    //将所有的后端服务的配置都放在domain文件夹中管理</span><br><span class=\"line\">    include domain/*.conf;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"第二步-创建单独的配置文件，以nacos-conf为例\"><a href=\"#第二步-创建单独的配置文件，以nacos-conf为例\" class=\"headerlink\" title=\"第二步 创建单独的配置文件，以nacos.conf为例\"></a>第二步 创建单独的配置文件，以<code>nacos.conf</code>为例</h3><p>在<code>nginx/conf</code>文件夹下创建<code>domain</code> 和 <code>cert</code>文件夹<code>，然后将nacos.conf放入</code>domain&#96;文件夹中</p>\n<ul>\n<li>domain 存放单个服务的配置文件</li>\n<li>cert 如果网站是<code>https</code>，将相关证书放入<code>cert</code>文件夹中</li>\n</ul>\n<p><code>nacos.conf</code>配置如下</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">upstream nacos_server &#123;</span><br><span class=\"line\">        server <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">8448</span> weight=<span class=\"number\">1</span>;</span><br><span class=\"line\">        server <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">8449</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># http 强制跳转https</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen <span class=\"number\">80</span>;</span><br><span class=\"line\">        server_name nacos.bosong.online;</span><br><span class=\"line\">        rewrite ^ https://$http_host$request_uri? permanent;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">        server_name nacos.bosong.online;</span><br><span class=\"line\">        charset utf<span class=\"number\">-8</span>;</span><br><span class=\"line\">    \t#单独的域名访问日志</span><br><span class=\"line\">        access_log  logs/<span class=\"built_in\">config</span>.access.<span class=\"built_in\">log</span>  main;</span><br><span class=\"line\">\t#放置证书文件</span><br><span class=\"line\">        ssl_certificate   cert/<span class=\"built_in\">config</span>.pem;</span><br><span class=\"line\">        ssl_certificate_key  cert/<span class=\"built_in\">config</span>.key;</span><br><span class=\"line\">        ssl_session_timeout <span class=\"number\">5</span>m;</span><br><span class=\"line\">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class=\"line\">        ssl_protocols TLSv1 TLSv1<span class=\"number\">.1</span> TLSv1<span class=\"number\">.2</span>;</span><br><span class=\"line\">        ssl_prefer_server_ciphers on;</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">        \t\t#跨域配置-允许当前的域名访问</span><br><span class=\"line\">                add_header Access-Control-Allow-Origin <span class=\"string\">&#x27;$http_origin&#x27;</span>;</span><br><span class=\"line\">        \t\t#允许携带凭证</span><br><span class=\"line\">                add_header Access-Control-Allow-Credentials <span class=\"string\">&#x27;true&#x27;</span>;</span><br><span class=\"line\">        \t\t#允许请求类型-根据实际情况自定义</span><br><span class=\"line\">                add_header Access-Control-Allow-Methods <span class=\"string\">&#x27;GET, POST, OPTIONS, PUT, DELETE&#x27;</span>;\t</span><br><span class=\"line\">        \t\t#允许携带的请求头，根据网站实际情况修改</span><br><span class=\"line\">                add_header Access-Control-Allow-Headers <span class=\"string\">&#x27;Cookie,Set-Cookie,x-requested-with,content-type,Authorization,accessToken,authorization,accesstoken&#x27;</span>;</span><br><span class=\"line\">        \t\t#需要代理的后端服务，可负载均衡 </span><br><span class=\"line\">                proxy_pass http://nacos_server;</span><br><span class=\"line\">       \t\t\t#OPTIONS请求直接返回<span class=\"number\">200</span>或者<span class=\"number\">204</span>即可</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ($request_method = <span class=\"string\">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"更加深入的探索\"><a href=\"#更加深入的探索\" class=\"headerlink\" title=\"更加深入的探索\"></a>更加深入的探索</h3><p>在这里没有对安全性方面进行加强，如果网站需要更高安全性，可以根据实际需要在配置中增加安全性的相关配置。</p>\n\n","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"nginx","path":"api/tags/nginx.json"}]}