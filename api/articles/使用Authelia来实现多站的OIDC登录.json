{"title":"使用Authelia来实现多站的OIDC登录","slug":"使用Authelia来实现多站的OIDC登录","date":"2022-06-02T00:58:35.000Z","updated":"2022-06-02T01:05:59.617Z","comments":true,"path":"api/articles/使用Authelia来实现多站的OIDC登录.json","excerpt":"  [Figure] 简单说说什么是OIDC简单来说，OIDC是一个OAuth2上层的简单身份层协议。它允许客户端验证用户的身份并获取基本的用户配置信息。OIDC使用JSON Web Token（JWT）作为信息返回，通过符合OAuth2的流程来获取对应的TOKEN信息。它的作用是为多个不同的站点提供登录功能（和SSO类似）。每次需要使用OIDC登录网站时，都会被重定向到登录的OpenID网站，然后再回到该网站。例如，如果选择使用Github帐户登录Grafana，这就使用了OIDC。成功通过Github身份验证并授权Grafana访问您的信息后，Github会将有关用户和执行的身份验证的信息发送回Grafana。此信息在JWT中返回，包含ID Token或者Access Token。这样就实现了简单的登录流程，OIDC主要有以下几个作用：1、OIDC的协议简化了登录的流程开发工作，在支持OIDC的应用简单配置即可使用2、OIDC的协议有组别概念，可以限制用户可访问的资源内容3、一个账号根据不同的资源权限访问不同的站点内容","covers":["https://imagecdn.bosong.online/uPic/61_1654131271466.jpeg","https://imagecdn.bosong.online/uPic/grafana_login_1654130801482.jpg"],"content":"<p> <img src=\"https://imagecdn.bosong.online/uPic/61_1654131271466.jpeg\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/61_1654131271466.jpeg\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"61_1654131271466\"></p>\n<div class=\"story post-story\"><h2 id=\"简单说说什么是OIDC\"><a href=\"#简单说说什么是OIDC\" class=\"headerlink\" title=\"简单说说什么是OIDC\"></a>简单说说什么是OIDC</h2><p>简单来说，OIDC是一个OAuth2上层的简单身份层协议。它允许客户端验证用户的身份并获取基本的用户配置信息。OIDC使用JSON Web Token（JWT）作为信息返回，通过符合OAuth2的流程来获取对应的TOKEN信息。</p>\n<p>它的作用是为多个不同的站点提供登录功能（和SSO类似）。每次需要使用OIDC登录网站时，都会被重定向到登录的OpenID网站，然后再回到该网站。例如，如果选择使用Github帐户登录Grafana，这就使用了OIDC。成功通过Github身份验证并授权Grafana访问您的信息后，Github会将有关用户和执行的身份验证的信息发送回Grafana。此信息在JWT中返回，包含ID Token或者Access Token。</p>\n<p>这样就实现了简单的登录流程，OIDC主要有以下几个作用：</p>\n<p>1、OIDC的协议简化了登录的流程开发工作，在支持OIDC的应用简单配置即可使用</p>\n<p>2、OIDC的协议有组别概念，可以限制用户可访问的资源内容</p>\n<p>3、一个账号根据不同的资源权限访问不同的站点内容</p>\n</div><div class=\"story post-story\"><h2 id=\"如何配置Authelia来支持grafana通过OIDC登录\"><a href=\"#如何配置Authelia来支持grafana通过OIDC登录\" class=\"headerlink\" title=\"如何配置Authelia来支持grafana通过OIDC登录\"></a>如何配置Authelia来支持grafana通过OIDC登录</h2><p>先看<a href=\"https://www.authelia.com/docs/configuration/identity-providers/oidc.html\">官方文档</a> ，官方文档写的还是比较详细的，创建一个OIDC应用，只需要在<code>configuration.yml</code>的后面加上对应的配置即可,在本文中我以grafana配置为例，简单说明grafana使用Authelia来进行登录</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">identity_providers:</span></span><br><span class=\"line\">  <span class=\"attr\">oidc:</span></span><br><span class=\"line\">    <span class=\"attr\">hmac_secret:</span> <span class=\"string\">rc9uqHMWXf69M9TXrEfa2XoAtbXsbSGMvqWC</span></span><br><span class=\"line\">    <span class=\"comment\"># issuer_private_key 这个字段的内容我直接用docker-compose里面的env来替代，减少yaml中的配置长度和保护机密</span></span><br><span class=\"line\">    <span class=\"comment\">#AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE=/config/key.pem</span></span><br><span class=\"line\">    <span class=\"comment\">#issuer_private_key:</span></span><br><span class=\"line\">    <span class=\"attr\">access_token_lifespan:</span> <span class=\"string\">1h</span></span><br><span class=\"line\">    <span class=\"attr\">authorize_code_lifespan:</span> <span class=\"string\">1m</span></span><br><span class=\"line\">    <span class=\"attr\">id_token_lifespan:</span> <span class=\"string\">1h</span></span><br><span class=\"line\">    <span class=\"attr\">refresh_token_lifespan:</span> <span class=\"string\">90m</span></span><br><span class=\"line\">    <span class=\"attr\">enable_client_debug_messages:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">enforce_pkce:</span> <span class=\"string\">public_clients_only</span></span><br><span class=\"line\">    <span class=\"attr\">cors:</span></span><br><span class=\"line\">      <span class=\"attr\">endpoints:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">authorization</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">token</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">revocation</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">introspection</span></span><br><span class=\"line\">      <span class=\"comment\">#这里允许配置为`*`,代表全部网站</span></span><br><span class=\"line\">      <span class=\"attr\">allowed_origins:</span> <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\">      <span class=\"comment\">#  - https://example.com</span></span><br><span class=\"line\">      <span class=\"attr\">allowed_origins_from_client_redirect_uris:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">clients:</span></span><br><span class=\"line\">      <span class=\"comment\">#如果多个应用，复制下面同样的一大串进行具体配置即可</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">        <span class=\"attr\">description:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">        <span class=\"attr\">secret:</span> <span class=\"string\">GzPji9HrYbLQEX</span></span><br><span class=\"line\">        <span class=\"attr\">sector_identifier:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">public:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"comment\">#校验的级别，可以是one_factor等</span></span><br><span class=\"line\">        <span class=\"attr\">authorization_policy:</span> <span class=\"string\">two_factor</span></span><br><span class=\"line\">        <span class=\"attr\">pre_configured_consent_duration:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">audience:</span> []</span><br><span class=\"line\">        <span class=\"comment\">#可以访问到的用户信息，具体有哪些，可以直接看官方文档的说明</span></span><br><span class=\"line\">        <span class=\"attr\">scopes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">openid</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">groups</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">email</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">profile</span></span><br><span class=\"line\">        <span class=\"comment\">#在auth登录成功后需要重定向的接口地址，不同的应用需要根据实际情况配置</span></span><br><span class=\"line\">        <span class=\"attr\">redirect_uris:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">https://grafana.abc.com/login/generic_oauth</span></span><br><span class=\"line\">        <span class=\"attr\">grant_types:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">refresh_token</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">authorization_code</span></span><br><span class=\"line\">        <span class=\"attr\">response_types:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">code</span></span><br><span class=\"line\">        <span class=\"attr\">response_modes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">form_post</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">query</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">fragment</span></span><br><span class=\"line\">        <span class=\"attr\">userinfo_signing_algorithm:</span> <span class=\"string\">none</span></span><br></pre></td></tr></table></figure>\n\n\n<p>这样一个很简单的配置，就让Authelia实现了自身作为OIDC的身份提供商供 grafana 这个应用登录访问。</p>\n<p>我们可以直接访问到你的authelia的地址来查看登录需要配置的端点信息：<code>https://auth.example.com/.well-known/openid-configuration</code> 将对应的<code>auth.example.com</code> 换成你自己的域名。</p>\n</div><div class=\"story post-story\"><h2 id=\"如何配置Grafana来使用Authelia提供的OIDC进行登录\"><a href=\"#如何配置Grafana来使用Authelia提供的OIDC进行登录\" class=\"headerlink\" title=\"如何配置Grafana来使用Authelia提供的OIDC进行登录\"></a>如何配置Grafana来使用Authelia提供的OIDC进行登录</h2><p>grafana 配置OIDC的登录官方也有完善的文档，但是我也遇到了一些小的坑点，所以我会在贴配置的同时，说明我遇到的坑点（其实是我菜）。</p>\n<p>使用开源项目的对应功能，肯定第一步是看<a href=\"https://grafana.com/docs/grafana/latest/auth/generic-oauth/\">官方文档</a> ，官方文档还是写的比较详细，但是它是一个通用文档，我们需要根据实际情况做一下小的变更。</p>\n<h3 id=\"grafana使用docker-compose启动\"><a href=\"#grafana使用docker-compose启动\" class=\"headerlink\" title=\"grafana使用docker-compose启动\"></a>grafana使用docker-compose启动</h3><p>我的grafana是使用docker-compose启动的，它的配置很简单：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana-oss:$&#123;grafana_version&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">gateway</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;grafana-server --config /etc/grafana/grafana.ini&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">env_file:</span> <span class=\"string\">.env</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./grafana.ini:/etc/grafana/grafana.ini</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/data/grafana:/var/lib/grafana</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span></span><br><span class=\"line\">      <span class=\"attr\">disable:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">4000</span><span class=\"string\">:3000</span></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gateway:</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>这时候需要复制grafana的<a href=\"https://github.com/grafana/grafana/blob/main/conf/sample.ini\">默认配置文件</a> 来写到<code>grafana.ini</code> 文件中了，数据库信息什么的配置。</p>\n<p>注意我在这里碰到了一个坑点：当你需要启用对应的配置时候，需要将 <code>;</code>去掉，这样配置才能生效。（惯性思维是<code>#</code>，突然来个<code>;</code>号有点懵）。</p>\n<h3 id=\"grafana支持Authelia登录访问\"><a href=\"#grafana支持Authelia登录访问\" class=\"headerlink\" title=\"grafana支持Authelia登录访问\"></a>grafana支持Authelia登录访问</h3><p>grafana 的配置写的比较简单命令，其他配置忽略的情况下，以下几个配置就能支持到authelia的登录访问了。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The full public facing url you use in browser, used for redirects and emails</span></span><br><span class=\"line\"><span class=\"comment\"># 这个配置为你的grafana地址，需要进行配置</span></span><br><span class=\"line\"><span class=\"string\">root_url</span> <span class=\"string\">=</span> <span class=\"string\">https://grafana.abc.com</span></span><br><span class=\"line\"><span class=\"comment\"># 如果仅限OAuth仅限登录的话设置为true（建议先设置为false，待修改OIDC的权限配置为admin之后再关闭）</span></span><br><span class=\"line\"><span class=\"string\">disable_login_form</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#################################### Generic OAuth ##########################</span></span><br><span class=\"line\">[<span class=\"string\">auth.generic_oauth</span>]</span><br><span class=\"line\"><span class=\"string\">enabled</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">name</span> <span class=\"string\">=</span> <span class=\"string\">authelia</span></span><br><span class=\"line\"><span class=\"string\">allow_sign_up</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">client_id</span> <span class=\"string\">=</span> <span class=\"string\">grafana</span></span><br><span class=\"line\"><span class=\"string\">client_secret</span> <span class=\"string\">=</span> <span class=\"string\">GzPji9HrYbLQEX</span></span><br><span class=\"line\"><span class=\"string\">scopes</span> <span class=\"string\">=</span> <span class=\"string\">openid</span> <span class=\"string\">profile</span> <span class=\"string\">groups</span> <span class=\"string\">email</span></span><br><span class=\"line\"><span class=\"string\">empty_scopes</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">auth_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/api/oidc/authorization</span></span><br><span class=\"line\"><span class=\"string\">token_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/api/oidc/token</span></span><br><span class=\"line\"><span class=\"string\">api_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/oidc/userinfo</span></span><br><span class=\"line\"><span class=\"string\">use_pkce</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n\n<p>配置完成后重启grafana之后，再次访问grafana就可以看到你配置的authelia登录框了，成果如下：</p>\n<p> <img src=\"https://imagecdn.bosong.online/uPic/grafana_login_1654130801482.jpg\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/grafana_login_1654130801482.jpg\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"grafana_login_1654130801482\"></p>\n</div><div class=\"story post-story\"><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>实际上我总共配置了三个client: <a href=\"https://github.com/outline/outline\">outline</a>、<a href=\"https://github.com/portainer/portainer\">portainer</a>  这个参考<a href=\"https://www.authelia.com/docs/community/oidc-integrations/portainer.html\">官方文档</a>即可配置成功、grafana，除了grafana花费了些许时间之外（主要是我菜，配置没有去掉<code>;</code>），其他两个配置都很简单。</p>\n<p>现在authelia这个服务已经为我的数个网站提供登录保护支持，如果你有兴趣，可以与我一起交流探索更多的有趣的玩法，如果有遇到的一些问题欢迎一起探讨。</p>\n\n</div>","more":"<div class=\"story post-story\"><h2 id=\"如何配置Authelia来支持grafana通过OIDC登录\"><a href=\"#如何配置Authelia来支持grafana通过OIDC登录\" class=\"headerlink\" title=\"如何配置Authelia来支持grafana通过OIDC登录\"></a>如何配置Authelia来支持grafana通过OIDC登录</h2><p>先看<a href=\"https://www.authelia.com/docs/configuration/identity-providers/oidc.html\">官方文档</a> ，官方文档写的还是比较详细的，创建一个OIDC应用，只需要在<code>configuration.yml</code>的后面加上对应的配置即可,在本文中我以grafana配置为例，简单说明grafana使用Authelia来进行登录</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">identity_providers:</span></span><br><span class=\"line\">  <span class=\"attr\">oidc:</span></span><br><span class=\"line\">    <span class=\"attr\">hmac_secret:</span> <span class=\"string\">rc9uqHMWXf69M9TXrEfa2XoAtbXsbSGMvqWC</span></span><br><span class=\"line\">    <span class=\"comment\"># issuer_private_key 这个字段的内容我直接用docker-compose里面的env来替代，减少yaml中的配置长度和保护机密</span></span><br><span class=\"line\">    <span class=\"comment\">#AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE=/config/key.pem</span></span><br><span class=\"line\">    <span class=\"comment\">#issuer_private_key:</span></span><br><span class=\"line\">    <span class=\"attr\">access_token_lifespan:</span> <span class=\"string\">1h</span></span><br><span class=\"line\">    <span class=\"attr\">authorize_code_lifespan:</span> <span class=\"string\">1m</span></span><br><span class=\"line\">    <span class=\"attr\">id_token_lifespan:</span> <span class=\"string\">1h</span></span><br><span class=\"line\">    <span class=\"attr\">refresh_token_lifespan:</span> <span class=\"string\">90m</span></span><br><span class=\"line\">    <span class=\"attr\">enable_client_debug_messages:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">enforce_pkce:</span> <span class=\"string\">public_clients_only</span></span><br><span class=\"line\">    <span class=\"attr\">cors:</span></span><br><span class=\"line\">      <span class=\"attr\">endpoints:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">authorization</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">token</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">revocation</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">introspection</span></span><br><span class=\"line\">      <span class=\"comment\">#这里允许配置为`*`,代表全部网站</span></span><br><span class=\"line\">      <span class=\"attr\">allowed_origins:</span> <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\">      <span class=\"comment\">#  - https://example.com</span></span><br><span class=\"line\">      <span class=\"attr\">allowed_origins_from_client_redirect_uris:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">clients:</span></span><br><span class=\"line\">      <span class=\"comment\">#如果多个应用，复制下面同样的一大串进行具体配置即可</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">        <span class=\"attr\">description:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">        <span class=\"attr\">secret:</span> <span class=\"string\">GzPji9HrYbLQEX</span></span><br><span class=\"line\">        <span class=\"attr\">sector_identifier:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">public:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"comment\">#校验的级别，可以是one_factor等</span></span><br><span class=\"line\">        <span class=\"attr\">authorization_policy:</span> <span class=\"string\">two_factor</span></span><br><span class=\"line\">        <span class=\"attr\">pre_configured_consent_duration:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">audience:</span> []</span><br><span class=\"line\">        <span class=\"comment\">#可以访问到的用户信息，具体有哪些，可以直接看官方文档的说明</span></span><br><span class=\"line\">        <span class=\"attr\">scopes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">openid</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">groups</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">email</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">profile</span></span><br><span class=\"line\">        <span class=\"comment\">#在auth登录成功后需要重定向的接口地址，不同的应用需要根据实际情况配置</span></span><br><span class=\"line\">        <span class=\"attr\">redirect_uris:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">https://grafana.abc.com/login/generic_oauth</span></span><br><span class=\"line\">        <span class=\"attr\">grant_types:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">refresh_token</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">authorization_code</span></span><br><span class=\"line\">        <span class=\"attr\">response_types:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">code</span></span><br><span class=\"line\">        <span class=\"attr\">response_modes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">form_post</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">query</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">fragment</span></span><br><span class=\"line\">        <span class=\"attr\">userinfo_signing_algorithm:</span> <span class=\"string\">none</span></span><br></pre></td></tr></table></figure>\n\n\n<p>这样一个很简单的配置，就让Authelia实现了自身作为OIDC的身份提供商供 grafana 这个应用登录访问。</p>\n<p>我们可以直接访问到你的authelia的地址来查看登录需要配置的端点信息：<code>https://auth.example.com/.well-known/openid-configuration</code> 将对应的<code>auth.example.com</code> 换成你自己的域名。</p>\n</div><div class=\"story post-story\"><h2 id=\"如何配置Grafana来使用Authelia提供的OIDC进行登录\"><a href=\"#如何配置Grafana来使用Authelia提供的OIDC进行登录\" class=\"headerlink\" title=\"如何配置Grafana来使用Authelia提供的OIDC进行登录\"></a>如何配置Grafana来使用Authelia提供的OIDC进行登录</h2><p>grafana 配置OIDC的登录官方也有完善的文档，但是我也遇到了一些小的坑点，所以我会在贴配置的同时，说明我遇到的坑点（其实是我菜）。</p>\n<p>使用开源项目的对应功能，肯定第一步是看<a href=\"https://grafana.com/docs/grafana/latest/auth/generic-oauth/\">官方文档</a> ，官方文档还是写的比较详细，但是它是一个通用文档，我们需要根据实际情况做一下小的变更。</p>\n<h3 id=\"grafana使用docker-compose启动\"><a href=\"#grafana使用docker-compose启动\" class=\"headerlink\" title=\"grafana使用docker-compose启动\"></a>grafana使用docker-compose启动</h3><p>我的grafana是使用docker-compose启动的，它的配置很简单：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana-oss:$&#123;grafana_version&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">gateway</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;grafana-server --config /etc/grafana/grafana.ini&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">env_file:</span> <span class=\"string\">.env</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./grafana.ini:/etc/grafana/grafana.ini</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/data/grafana:/var/lib/grafana</span></span><br><span class=\"line\">    <span class=\"attr\">healthcheck:</span></span><br><span class=\"line\">      <span class=\"attr\">disable:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">TZ=Asia/Shanghai</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">4000</span><span class=\"string\">:3000</span></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">gateway:</span></span><br><span class=\"line\">    <span class=\"attr\">external:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br></pre></td></tr></table></figure>\n\n<p>这时候需要复制grafana的<a href=\"https://github.com/grafana/grafana/blob/main/conf/sample.ini\">默认配置文件</a> 来写到<code>grafana.ini</code> 文件中了，数据库信息什么的配置。</p>\n<p>注意我在这里碰到了一个坑点：当你需要启用对应的配置时候，需要将 <code>;</code>去掉，这样配置才能生效。（惯性思维是<code>#</code>，突然来个<code>;</code>号有点懵）。</p>\n<h3 id=\"grafana支持Authelia登录访问\"><a href=\"#grafana支持Authelia登录访问\" class=\"headerlink\" title=\"grafana支持Authelia登录访问\"></a>grafana支持Authelia登录访问</h3><p>grafana 的配置写的比较简单命令，其他配置忽略的情况下，以下几个配置就能支持到authelia的登录访问了。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The full public facing url you use in browser, used for redirects and emails</span></span><br><span class=\"line\"><span class=\"comment\"># 这个配置为你的grafana地址，需要进行配置</span></span><br><span class=\"line\"><span class=\"string\">root_url</span> <span class=\"string\">=</span> <span class=\"string\">https://grafana.abc.com</span></span><br><span class=\"line\"><span class=\"comment\"># 如果仅限OAuth仅限登录的话设置为true（建议先设置为false，待修改OIDC的权限配置为admin之后再关闭）</span></span><br><span class=\"line\"><span class=\"string\">disable_login_form</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#################################### Generic OAuth ##########################</span></span><br><span class=\"line\">[<span class=\"string\">auth.generic_oauth</span>]</span><br><span class=\"line\"><span class=\"string\">enabled</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">name</span> <span class=\"string\">=</span> <span class=\"string\">authelia</span></span><br><span class=\"line\"><span class=\"string\">allow_sign_up</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"string\">client_id</span> <span class=\"string\">=</span> <span class=\"string\">grafana</span></span><br><span class=\"line\"><span class=\"string\">client_secret</span> <span class=\"string\">=</span> <span class=\"string\">GzPji9HrYbLQEX</span></span><br><span class=\"line\"><span class=\"string\">scopes</span> <span class=\"string\">=</span> <span class=\"string\">openid</span> <span class=\"string\">profile</span> <span class=\"string\">groups</span> <span class=\"string\">email</span></span><br><span class=\"line\"><span class=\"string\">empty_scopes</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"string\">auth_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/api/oidc/authorization</span></span><br><span class=\"line\"><span class=\"string\">token_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/api/oidc/token</span></span><br><span class=\"line\"><span class=\"string\">api_url</span> <span class=\"string\">=</span> <span class=\"string\">https://auth.example.com/oidc/userinfo</span></span><br><span class=\"line\"><span class=\"string\">use_pkce</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n\n<p>配置完成后重启grafana之后，再次访问grafana就可以看到你配置的authelia登录框了，成果如下：</p>\n<p> <img src=\"https://imagecdn.bosong.online/uPic/grafana_login_1654130801482.jpg\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/grafana_login_1654130801482.jpg\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"grafana_login_1654130801482\"></p>\n</div><div class=\"story post-story\"><h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>实际上我总共配置了三个client: <a href=\"https://github.com/outline/outline\">outline</a>、<a href=\"https://github.com/portainer/portainer\">portainer</a>  这个参考<a href=\"https://www.authelia.com/docs/community/oidc-integrations/portainer.html\">官方文档</a>即可配置成功、grafana，除了grafana花费了些许时间之外（主要是我菜，配置没有去掉<code>;</code>），其他两个配置都很简单。</p>\n<p>现在authelia这个服务已经为我的数个网站提供登录保护支持，如果你有兴趣，可以与我一起交流探索更多的有趣的玩法，如果有遇到的一些问题欢迎一起探讨。</p>\n\n</div>","categories":[{"name":"技术手册","path":"api/categories/技术手册.json"}],"tags":[{"name":"oidc","path":"api/tags/oidc.json"},{"name":"authelia","path":"api/tags/authelia.json"},{"name":"grafana","path":"api/tags/grafana.json"}]}