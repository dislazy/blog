{"title":"Springboot集成druid数据库连接池","slug":"Springboot集成druid数据库连接池","date":"2018-10-14T11:35:52.000Z","updated":"2022-06-02T01:05:59.615Z","comments":true,"path":"api/articles/Springboot集成druid数据库连接池.json","excerpt":"1.使用http://start.spring.io/ 新建web项目，选择springboot版本为1.5.13选择mysql，mybatis，web依赖，下载好生成的demo2.导入idea，然后写导入druid依赖","covers":null,"content":"<p>1.使用<a href=\"http://start.spring.io/\">http://start.spring.io/</a> 新建web项目，选择springboot版本为1.5.13选择mysql，mybatis，web依赖，下载好生成的demo</p>\n<p>2.导入idea，然后写导入druid依赖</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class=\"line\">  &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class=\"line\">  &lt;version&gt;1.0.23&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>2.设置druid</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package com.my.blog.website.config;</span><br><span class=\"line\">import com.alibaba.druid.filter.Filter;</span><br><span class=\"line\">import com.alibaba.druid.filter.logging.Slf4jLogFilter;</span><br><span class=\"line\">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class=\"line\">import com.alibaba.druid.support.http.StatViewServlet;</span><br><span class=\"line\">import com.alibaba.druid.support.http.WebStatFilter;</span><br><span class=\"line\">import com.github.pagehelper.PageHelper;</span><br><span class=\"line\">import org.apache.ibatis.plugin.Interceptor;</span><br><span class=\"line\">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class=\"line\">import org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class=\"line\">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class=\"line\">import org.slf4j.Logger;</span><br><span class=\"line\">import org.slf4j.LoggerFactory;</span><br><span class=\"line\">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class=\"line\">import org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class=\"line\">import org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class=\"line\">import org.springframework.context.annotation.Bean;</span><br><span class=\"line\">import org.springframework.context.annotation.Configuration;</span><br><span class=\"line\">import org.springframework.context.annotation.Primary;</span><br><span class=\"line\">import org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class=\"line\">import org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class=\"line\">import org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class=\"line\">import org.springframework.transaction.PlatformTransactionManager;</span><br><span class=\"line\">import javax.sql.DataSource;</span><br><span class=\"line\">import java.sql.SQLException;</span><br><span class=\"line\">import java.util.ArrayList;</span><br><span class=\"line\">import java.util.List;</span><br><span class=\"line\">import java.util.Properties;</span><br><span class=\"line\">/**</span><br><span class=\"line\"> * cn.sparrowx.druid.conf</span><br><span class=\"line\"> *</span><br><span class=\"line\"> * @author bosong</span><br><span class=\"line\"> * @since 2018/6/11 15:30.</span><br><span class=\"line\"> */</span><br><span class=\"line\">@Configuration</span><br><span class=\"line\">public class DruidConfiguration &#123;</span><br><span class=\"line\">    private static final Logger logger = LoggerFactory.getLogger(DruidConfiguration.class);</span><br><span class=\"line\">    private static final String DB_PREFIX = &quot;spring.datasource&quot;;</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    public ServletRegistrationBean druidServlet() &#123;</span><br><span class=\"line\">        logger.info(&quot;init Druid Servlet Configuration &quot;);</span><br><span class=\"line\">        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean(new StatViewServlet(), &quot;/druid/*&quot;);</span><br><span class=\"line\">        // IP白名单</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;allow&quot;, &quot;&quot;);</span><br><span class=\"line\">        // IP黑名单(共同存在时，deny优先于allow)</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;deny&quot;, &quot;&quot;);</span><br><span class=\"line\">        //控制台管理用户</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;loginUsername&quot;, &quot;bosong&quot;);</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;loginPassword&quot;, &quot;qwe13579QWE&quot;);</span><br><span class=\"line\">        //是否能够重置数据 禁用HTML页面上的“Reset All”功能</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;resetEnable&quot;, &quot;true&quot;);</span><br><span class=\"line\">        return servletRegistrationBean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    public FilterRegistrationBean filterRegistrationBean() &#123;</span><br><span class=\"line\">        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());</span><br><span class=\"line\">        filterRegistrationBean.addUrlPatterns(&quot;/*&quot;);</span><br><span class=\"line\">        filterRegistrationBean.addInitParameter(&quot;exclusions&quot;, &quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;);</span><br><span class=\"line\">        return filterRegistrationBean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    List&lt;Filter&gt; list=new ArrayList&lt;&gt;();</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    Slf4jLogFilter logfilter()&#123;</span><br><span class=\"line\">        Slf4jLogFilter slf4jLogFilter=new Slf4jLogFilter();</span><br><span class=\"line\">        slf4jLogFilter.setConnectionLogEnabled(false);</span><br><span class=\"line\">        slf4jLogFilter.setStatementLogEnabled(false);</span><br><span class=\"line\">        slf4jLogFilter.setStatementExecutableSqlLogEnable(true);</span><br><span class=\"line\">        slf4jLogFilter.setResultSetLogEnabled(true);</span><br><span class=\"line\">        list.add(slf4jLogFilter);</span><br><span class=\"line\">        return slf4jLogFilter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //解决 spring.datasource.filters=stat,wall,log4j 无法正常注册进去</span><br><span class=\"line\">    @ConfigurationProperties(prefix = DB_PREFIX)</span><br><span class=\"line\">    class IDataSourceProperties &#123;</span><br><span class=\"line\">        private String url;</span><br><span class=\"line\">        private String username;</span><br><span class=\"line\">        private String password;</span><br><span class=\"line\">        private String filters;</span><br><span class=\"line\">        private String connectionProperties;</span><br><span class=\"line\">        @Bean     //声明其为Bean实例</span><br><span class=\"line\">        @Primary  //在同样的DataSource中，首先使用被标注的DataSource</span><br><span class=\"line\">        public DataSource dataSource() &#123;</span><br><span class=\"line\">            DruidDataSource datasource = new DruidDataSource();</span><br><span class=\"line\">            datasource.setName(&quot;blog-onlie&quot;);</span><br><span class=\"line\">            datasource.setUrl(url);</span><br><span class=\"line\">            datasource.setUsername(username);</span><br><span class=\"line\">            datasource.setPassword(password);</span><br><span class=\"line\">            //configuration</span><br><span class=\"line\">            datasource.setInitialSize(1);</span><br><span class=\"line\">            datasource.setMinIdle(1);</span><br><span class=\"line\">            datasource.setMaxActive(20);</span><br><span class=\"line\">            datasource.setMaxWait(60000);</span><br><span class=\"line\">            datasource.setTimeBetweenLogStatsMillis(300000);</span><br><span class=\"line\">            datasource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class=\"line\">            datasource.setMinEvictableIdleTimeMillis(300000);</span><br><span class=\"line\">            datasource.setTestWhileIdle(true);</span><br><span class=\"line\">            datasource.setTestOnBorrow(false);</span><br><span class=\"line\">            datasource.setTestOnReturn(false);</span><br><span class=\"line\">            datasource.setPoolPreparedStatements(true);</span><br><span class=\"line\">            datasource.setMaxPoolPreparedStatementPerConnectionSize(20);</span><br><span class=\"line\">            datasource.setAsyncInit(true);</span><br><span class=\"line\">            datasource.setProxyFilters(list);</span><br><span class=\"line\">            datasource.setValidationQuery(&quot;select &#x27;x&#x27;&quot;);</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                datasource.setFilters(filters);</span><br><span class=\"line\">            &#125; catch (SQLException e) &#123;</span><br><span class=\"line\">                System.err.println(&quot;druid configuration initialization filter: &quot; + e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            datasource.setConnectionProperties(connectionProperties);</span><br><span class=\"line\">            return datasource;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean(name = &quot;sqlSessionFactory&quot;)</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public SqlSessionFactory sqlSessionFactoryBean() &#123;</span><br><span class=\"line\">            SqlSessionFactoryBean bean = new SqlSessionFactoryBean();</span><br><span class=\"line\">            bean.setDataSource(dataSource());</span><br><span class=\"line\">            bean.setTypeAliasesPackage(&quot;com.my.blog.website.model.Vo&quot;);</span><br><span class=\"line\">            // 分页插件</span><br><span class=\"line\">            PageHelper pageHelper = new PageHelper();</span><br><span class=\"line\">            Properties properties = new Properties();</span><br><span class=\"line\">            properties.setProperty(&quot;reasonable&quot;, &quot;true&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;supportMethodsArguments&quot;, &quot;true&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;returnPageInfo&quot;, &quot;check&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;params&quot;, &quot;count=countSql&quot;);</span><br><span class=\"line\">            pageHelper.setProperties(properties);</span><br><span class=\"line\">            // 添加插件</span><br><span class=\"line\">            bean.setPlugins(new Interceptor[] &#123;pageHelper&#125;);</span><br><span class=\"line\">            // 添加XML目录</span><br><span class=\"line\">            ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                bean.setMapperLocations(resolver.getResources(&quot;classpath:mapper/*.xml&quot;));</span><br><span class=\"line\">                return bean.getObject();</span><br><span class=\"line\">            &#125; catch (Exception e) &#123;</span><br><span class=\"line\">                throw new RuntimeException(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public SqlSessionTemplate sqlSessionTemplate(</span><br><span class=\"line\">                SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class=\"line\">            return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public PlatformTransactionManager annotationDrivenTransactionManager() &#123;</span><br><span class=\"line\">            return new DataSourceTransactionManager(dataSource());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getUrl() &#123;</span><br><span class=\"line\">            return url;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setUrl(String url) &#123;</span><br><span class=\"line\">            this.url = url;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getUsername() &#123;</span><br><span class=\"line\">            return username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setUsername(String username) &#123;</span><br><span class=\"line\">            this.username = username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getPassword() &#123;</span><br><span class=\"line\">            return password;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setPassword(String password) &#123;</span><br><span class=\"line\">            this.password = password;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getFilters() &#123;</span><br><span class=\"line\">            return filters;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setFilters(String filters) &#123;</span><br><span class=\"line\">            this.filters = filters;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getConnectionProperties() &#123;</span><br><span class=\"line\">            return connectionProperties;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setConnectionProperties(String connectionProperties) &#123;</span><br><span class=\"line\">            this.connectionProperties = connectionProperties;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>6.配置application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  datasource:</span><br><span class=\"line\">    type: com.alibaba.druid.pool.DruidDataSource</span><br><span class=\"line\">    url: jdbc:mysql://xxxxxx:3306/teaching?useSSL=false</span><br><span class=\"line\">    username: root</span><br><span class=\"line\">    password: SK7q1NJTgWERV924WLnm7IcxBHjDNJ81UMo10EuFzjcXwblNte68QyxAHpoaV57KHRob7Rle+syYyvaGE2Fa7Q==</span><br><span class=\"line\">    # 下面为连接池的补充设置，应用到上面所有数据源中</span><br><span class=\"line\">    # 配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#x27;wall&#x27;用于防火墙</span><br><span class=\"line\">    filters: config,stat,wall,slf4j</span><br><span class=\"line\">    # 通过connectProperties属性来打开mergeSql功能；慢SQL记录</span><br><span class=\"line\">    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000;config.decrypt=true;config.decrypt.key=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAItGtxZCgxe9j3hEBJtW46xjlm6doeYY0/VvOEqcs3VQG5pcA3Tyv0SjjMXAq0zOQdI6nGMXUhtqrMG41Yk7RgMCAwEAAQ==</span><br><span class=\"line\">    # mybatis配置</span><br><span class=\"line\">mybatis:</span><br><span class=\"line\">  mapper-locations: classpath*:/mapper/*Mapper.xml</span><br><span class=\"line\">server:</span><br><span class=\"line\">  port: 10086</span><br><span class=\"line\">logging:</span><br><span class=\"line\">  level: debug</span><br><span class=\"line\">  file: logs/spring.log</span><br></pre></td></tr></table></figure>\n<p>7.数据库密码可以经过加密，加密方法可以直接在网上查询,配置好数据库的查询语句 就可以了 。登录到<a href=\"http://localhost:10086/druid/login.html%E4%BD%BF%E7%94%A8%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E8%BF%9B%E5%8E%BB%E5%8D%B3%E5%8F%AF%E6%88%90%E5%8A%9F\">http://localhost:10086/druid/login.html使用账号密码登录进去即可成功</a></p>\n\n","more":"\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependency&gt;</span><br><span class=\"line\">  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class=\"line\">  &lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class=\"line\">  &lt;version&gt;1.0.23&lt;/version&gt;</span><br><span class=\"line\">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>\n<p>2.设置druid</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package com.my.blog.website.config;</span><br><span class=\"line\">import com.alibaba.druid.filter.Filter;</span><br><span class=\"line\">import com.alibaba.druid.filter.logging.Slf4jLogFilter;</span><br><span class=\"line\">import com.alibaba.druid.pool.DruidDataSource;</span><br><span class=\"line\">import com.alibaba.druid.support.http.StatViewServlet;</span><br><span class=\"line\">import com.alibaba.druid.support.http.WebStatFilter;</span><br><span class=\"line\">import com.github.pagehelper.PageHelper;</span><br><span class=\"line\">import org.apache.ibatis.plugin.Interceptor;</span><br><span class=\"line\">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class=\"line\">import org.mybatis.spring.SqlSessionFactoryBean;</span><br><span class=\"line\">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class=\"line\">import org.slf4j.Logger;</span><br><span class=\"line\">import org.slf4j.LoggerFactory;</span><br><span class=\"line\">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class=\"line\">import org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class=\"line\">import org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class=\"line\">import org.springframework.context.annotation.Bean;</span><br><span class=\"line\">import org.springframework.context.annotation.Configuration;</span><br><span class=\"line\">import org.springframework.context.annotation.Primary;</span><br><span class=\"line\">import org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class=\"line\">import org.springframework.core.io.support.ResourcePatternResolver;</span><br><span class=\"line\">import org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class=\"line\">import org.springframework.transaction.PlatformTransactionManager;</span><br><span class=\"line\">import javax.sql.DataSource;</span><br><span class=\"line\">import java.sql.SQLException;</span><br><span class=\"line\">import java.util.ArrayList;</span><br><span class=\"line\">import java.util.List;</span><br><span class=\"line\">import java.util.Properties;</span><br><span class=\"line\">/**</span><br><span class=\"line\"> * cn.sparrowx.druid.conf</span><br><span class=\"line\"> *</span><br><span class=\"line\"> * @author bosong</span><br><span class=\"line\"> * @since 2018/6/11 15:30.</span><br><span class=\"line\"> */</span><br><span class=\"line\">@Configuration</span><br><span class=\"line\">public class DruidConfiguration &#123;</span><br><span class=\"line\">    private static final Logger logger = LoggerFactory.getLogger(DruidConfiguration.class);</span><br><span class=\"line\">    private static final String DB_PREFIX = &quot;spring.datasource&quot;;</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    public ServletRegistrationBean druidServlet() &#123;</span><br><span class=\"line\">        logger.info(&quot;init Druid Servlet Configuration &quot;);</span><br><span class=\"line\">        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean(new StatViewServlet(), &quot;/druid/*&quot;);</span><br><span class=\"line\">        // IP白名单</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;allow&quot;, &quot;&quot;);</span><br><span class=\"line\">        // IP黑名单(共同存在时，deny优先于allow)</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;deny&quot;, &quot;&quot;);</span><br><span class=\"line\">        //控制台管理用户</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;loginUsername&quot;, &quot;bosong&quot;);</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;loginPassword&quot;, &quot;qwe13579QWE&quot;);</span><br><span class=\"line\">        //是否能够重置数据 禁用HTML页面上的“Reset All”功能</span><br><span class=\"line\">        servletRegistrationBean.addInitParameter(&quot;resetEnable&quot;, &quot;true&quot;);</span><br><span class=\"line\">        return servletRegistrationBean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    public FilterRegistrationBean filterRegistrationBean() &#123;</span><br><span class=\"line\">        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());</span><br><span class=\"line\">        filterRegistrationBean.addUrlPatterns(&quot;/*&quot;);</span><br><span class=\"line\">        filterRegistrationBean.addInitParameter(&quot;exclusions&quot;, &quot;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&quot;);</span><br><span class=\"line\">        return filterRegistrationBean;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    List&lt;Filter&gt; list=new ArrayList&lt;&gt;();</span><br><span class=\"line\">    @Bean</span><br><span class=\"line\">    Slf4jLogFilter logfilter()&#123;</span><br><span class=\"line\">        Slf4jLogFilter slf4jLogFilter=new Slf4jLogFilter();</span><br><span class=\"line\">        slf4jLogFilter.setConnectionLogEnabled(false);</span><br><span class=\"line\">        slf4jLogFilter.setStatementLogEnabled(false);</span><br><span class=\"line\">        slf4jLogFilter.setStatementExecutableSqlLogEnable(true);</span><br><span class=\"line\">        slf4jLogFilter.setResultSetLogEnabled(true);</span><br><span class=\"line\">        list.add(slf4jLogFilter);</span><br><span class=\"line\">        return slf4jLogFilter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    //解决 spring.datasource.filters=stat,wall,log4j 无法正常注册进去</span><br><span class=\"line\">    @ConfigurationProperties(prefix = DB_PREFIX)</span><br><span class=\"line\">    class IDataSourceProperties &#123;</span><br><span class=\"line\">        private String url;</span><br><span class=\"line\">        private String username;</span><br><span class=\"line\">        private String password;</span><br><span class=\"line\">        private String filters;</span><br><span class=\"line\">        private String connectionProperties;</span><br><span class=\"line\">        @Bean     //声明其为Bean实例</span><br><span class=\"line\">        @Primary  //在同样的DataSource中，首先使用被标注的DataSource</span><br><span class=\"line\">        public DataSource dataSource() &#123;</span><br><span class=\"line\">            DruidDataSource datasource = new DruidDataSource();</span><br><span class=\"line\">            datasource.setName(&quot;blog-onlie&quot;);</span><br><span class=\"line\">            datasource.setUrl(url);</span><br><span class=\"line\">            datasource.setUsername(username);</span><br><span class=\"line\">            datasource.setPassword(password);</span><br><span class=\"line\">            //configuration</span><br><span class=\"line\">            datasource.setInitialSize(1);</span><br><span class=\"line\">            datasource.setMinIdle(1);</span><br><span class=\"line\">            datasource.setMaxActive(20);</span><br><span class=\"line\">            datasource.setMaxWait(60000);</span><br><span class=\"line\">            datasource.setTimeBetweenLogStatsMillis(300000);</span><br><span class=\"line\">            datasource.setTimeBetweenEvictionRunsMillis(60000);</span><br><span class=\"line\">            datasource.setMinEvictableIdleTimeMillis(300000);</span><br><span class=\"line\">            datasource.setTestWhileIdle(true);</span><br><span class=\"line\">            datasource.setTestOnBorrow(false);</span><br><span class=\"line\">            datasource.setTestOnReturn(false);</span><br><span class=\"line\">            datasource.setPoolPreparedStatements(true);</span><br><span class=\"line\">            datasource.setMaxPoolPreparedStatementPerConnectionSize(20);</span><br><span class=\"line\">            datasource.setAsyncInit(true);</span><br><span class=\"line\">            datasource.setProxyFilters(list);</span><br><span class=\"line\">            datasource.setValidationQuery(&quot;select &#x27;x&#x27;&quot;);</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                datasource.setFilters(filters);</span><br><span class=\"line\">            &#125; catch (SQLException e) &#123;</span><br><span class=\"line\">                System.err.println(&quot;druid configuration initialization filter: &quot; + e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            datasource.setConnectionProperties(connectionProperties);</span><br><span class=\"line\">            return datasource;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean(name = &quot;sqlSessionFactory&quot;)</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public SqlSessionFactory sqlSessionFactoryBean() &#123;</span><br><span class=\"line\">            SqlSessionFactoryBean bean = new SqlSessionFactoryBean();</span><br><span class=\"line\">            bean.setDataSource(dataSource());</span><br><span class=\"line\">            bean.setTypeAliasesPackage(&quot;com.my.blog.website.model.Vo&quot;);</span><br><span class=\"line\">            // 分页插件</span><br><span class=\"line\">            PageHelper pageHelper = new PageHelper();</span><br><span class=\"line\">            Properties properties = new Properties();</span><br><span class=\"line\">            properties.setProperty(&quot;reasonable&quot;, &quot;true&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;supportMethodsArguments&quot;, &quot;true&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;returnPageInfo&quot;, &quot;check&quot;);</span><br><span class=\"line\">            properties.setProperty(&quot;params&quot;, &quot;count=countSql&quot;);</span><br><span class=\"line\">            pageHelper.setProperties(properties);</span><br><span class=\"line\">            // 添加插件</span><br><span class=\"line\">            bean.setPlugins(new Interceptor[] &#123;pageHelper&#125;);</span><br><span class=\"line\">            // 添加XML目录</span><br><span class=\"line\">            ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                bean.setMapperLocations(resolver.getResources(&quot;classpath:mapper/*.xml&quot;));</span><br><span class=\"line\">                return bean.getObject();</span><br><span class=\"line\">            &#125; catch (Exception e) &#123;</span><br><span class=\"line\">                throw new RuntimeException(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public SqlSessionTemplate sqlSessionTemplate(</span><br><span class=\"line\">                SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class=\"line\">            return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @Bean</span><br><span class=\"line\">        @Primary</span><br><span class=\"line\">        public PlatformTransactionManager annotationDrivenTransactionManager() &#123;</span><br><span class=\"line\">            return new DataSourceTransactionManager(dataSource());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getUrl() &#123;</span><br><span class=\"line\">            return url;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setUrl(String url) &#123;</span><br><span class=\"line\">            this.url = url;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getUsername() &#123;</span><br><span class=\"line\">            return username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setUsername(String username) &#123;</span><br><span class=\"line\">            this.username = username;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getPassword() &#123;</span><br><span class=\"line\">            return password;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setPassword(String password) &#123;</span><br><span class=\"line\">            this.password = password;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getFilters() &#123;</span><br><span class=\"line\">            return filters;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setFilters(String filters) &#123;</span><br><span class=\"line\">            this.filters = filters;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public String getConnectionProperties() &#123;</span><br><span class=\"line\">            return connectionProperties;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public void setConnectionProperties(String connectionProperties) &#123;</span><br><span class=\"line\">            this.connectionProperties = connectionProperties;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>6.配置application.yml</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring:</span><br><span class=\"line\">  datasource:</span><br><span class=\"line\">    type: com.alibaba.druid.pool.DruidDataSource</span><br><span class=\"line\">    url: jdbc:mysql://xxxxxx:3306/teaching?useSSL=false</span><br><span class=\"line\">    username: root</span><br><span class=\"line\">    password: SK7q1NJTgWERV924WLnm7IcxBHjDNJ81UMo10EuFzjcXwblNte68QyxAHpoaV57KHRob7Rle+syYyvaGE2Fa7Q==</span><br><span class=\"line\">    # 下面为连接池的补充设置，应用到上面所有数据源中</span><br><span class=\"line\">    # 配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#x27;wall&#x27;用于防火墙</span><br><span class=\"line\">    filters: config,stat,wall,slf4j</span><br><span class=\"line\">    # 通过connectProperties属性来打开mergeSql功能；慢SQL记录</span><br><span class=\"line\">    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000;config.decrypt=true;config.decrypt.key=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAItGtxZCgxe9j3hEBJtW46xjlm6doeYY0/VvOEqcs3VQG5pcA3Tyv0SjjMXAq0zOQdI6nGMXUhtqrMG41Yk7RgMCAwEAAQ==</span><br><span class=\"line\">    # mybatis配置</span><br><span class=\"line\">mybatis:</span><br><span class=\"line\">  mapper-locations: classpath*:/mapper/*Mapper.xml</span><br><span class=\"line\">server:</span><br><span class=\"line\">  port: 10086</span><br><span class=\"line\">logging:</span><br><span class=\"line\">  level: debug</span><br><span class=\"line\">  file: logs/spring.log</span><br></pre></td></tr></table></figure>\n<p>7.数据库密码可以经过加密，加密方法可以直接在网上查询,配置好数据库的查询语句 就可以了 。登录到<a href=\"http://localhost:10086/druid/login.html%E4%BD%BF%E7%94%A8%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E8%BF%9B%E5%8E%BB%E5%8D%B3%E5%8F%AF%E6%88%90%E5%8A%9F\">http://localhost:10086/druid/login.html使用账号密码登录进去即可成功</a></p>\n\n","categories":[{"name":"Java","path":"api/categories/Java.json"}],"tags":[{"name":"Java","path":"api/tags/Java.json"}]}