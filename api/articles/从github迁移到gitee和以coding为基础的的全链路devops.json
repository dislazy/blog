{"title":"从github迁移到gitee和以coding为基础的的全链路devops","slug":"从github迁移到gitee和以coding为基础的的全链路devops","date":"2022-03-13T05:39:19.000Z","updated":"2022-06-02T01:05:59.616Z","comments":true,"path":"api/articles/从github迁移到gitee和以coding为基础的的全链路devops.json","excerpt":"前言文章的标题起的比较长，实际上这篇文章将以我的hugo-blog项目为例，讲述一下我将代码提交到github，然后自动同步到gitee，再根据gitee的webhook通过coding的持续集成部署的整个过程。感谢github、gitee的给我们个人开发者提供足够的资源来完成这一系列的数据存储过程，也感谢coding提供的在我认为目前足够使用的持续集成功能，关键是这整个过程都是不需要付费的，需要的是灵快的小脑筋以及网上前人的经验罢了（文章中会用一些英文单词，避免敏感词汇，敬请原谅）。为什么迁移事情的起因由俄乌战争引起，我认为没有战争是正义或者邪恶的，因为史诗是由胜利者书写的。一直以来秉承一个原则：技术是自由的，它不能也不应该掺和到politics中去。然而真实的情况是：技术必须与politics共存，它是在保证politics下才有的产物。从这次俄乌战争中就可以看出来，以USA为首的西方国家彻底粉碎了技术是自由的谎言，甚至开源也不是自由的，由人主导的所谓的开源并非自由，从React到Github等一系列国外的开源软件的官网就能看出来很多现实：当我们的国家发生战争时，甚至是收复TW时，我们<br>将受到从金融、政治、外交、贸易、技术等一系列的和不能预知的威胁。由此，为保障个人的权益，我决定将自己的代码库逐渐迁移到gitee中来，以预防未来可能发生的某些事情。","covers":["https://imagecdn.bosong.online/uPic/gitee-home_1647152067844.png","https://imagecdn.bosong.online/uPic/gitee-repo_1647152429308.png","https://imagecdn.bosong.online/uPic/gihub-secrets_1647153632395.png","https://imagecdn.bosong.online/uPic/github-action_1647153612114.png","https://imagecdn.bosong.online/uPic/github-action-result_1647153859714.png","https://imagecdn.bosong.online/uPic/coding-deploy_1647154646788.png","https://imagecdn.bosong.online/uPic/coding-host_1647154660760.png"],"content":"<div class=\"story post-story\"><h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>文章的标题起的比较长，实际上这篇文章将以我的hugo-blog项目为例，讲述一下我将代码提交到github，然后自动同步到gitee，再根据gitee的webhook通过coding的持续集成部署的整个过程。</p>\n<p>感谢github、gitee的给我们个人开发者提供足够的资源来完成这一系列的数据存储过程，也感谢coding提供的在我认为目前足够使用的持续集成功能，关键是这整个过程都是不需要付费的，需要的是灵快的小脑筋以及网上前人的经验罢了（文章中会用一些英文单词，避免敏感词汇，敬请原谅）。</p>\n</div><div class=\"story post-story\"><h2 id=\"为什么迁移\"><a href=\"#为什么迁移\" class=\"headerlink\" title=\"为什么迁移\"></a>为什么迁移</h2><p>事情的起因由俄乌战争引起，我认为没有战争是正义或者邪恶的，因为史诗是由胜利者书写的。</p>\n<p>一直以来秉承一个原则：技术是自由的，它不能也不应该掺和到politics中去。</p>\n<p>然而真实的情况是：技术必须与politics共存，它是在保证politics下才有的产物。</p>\n<p>从这次俄乌战争中就可以看出来，以USA为首的西方国家彻底粉碎了技术是自由的谎言，甚至开源也不是自由的，由人主导的所谓的开源并非自由，从React到Github等一系列国外的开源软件的官网就能看出来很多现实：当我们的国家发生战争时，甚至是收复TW时，我们<br>将受到从金融、政治、外交、贸易、技术等一系列的和不能预知的威胁。</p>\n<p>由此，为保障个人的权益，我决定将自己的代码库逐渐迁移到gitee中来，以预防未来可能发生的某些事情。</p>\n</div><div class=\"story post-story\"><h2 id=\"迁移的步骤\"><a href=\"#迁移的步骤\" class=\"headerlink\" title=\"迁移的步骤\"></a>迁移的步骤</h2><p>得益于github和gitee的用户群体都同样的大，绝大部分的坑都已经被前人趟过，我们只要稍加整理就好了。</p>\n<p>从github迁移到gitee主要分为两步走：</p>\n<ul>\n<li>将github的所有个人仓库全量迁移到gitee</li>\n<li>将github的相关代码提交使用自动化的方式提交到gitee，保持仓库同步</li>\n</ul>\n<p>以上的方案是不是很熟悉：完全就是数据库的数据热迁移步骤。下面我将详细说明以上两个步骤的具体情况：</p>\n<h3 id=\"数据仓库的全量迁移\"><a href=\"#数据仓库的全量迁移\" class=\"headerlink\" title=\"数据仓库的全量迁移\"></a>数据仓库的全量迁移</h3><p>感谢gitee提供的数据全量迁移功能，让我如此没有障碍的快速进行数据迁移，不得不说软件国产化做的越来越好，越来越贴近中国人的使用习惯。</p>\n<ol>\n<li>先登录到gitee进入主页，点击+号，然后可以看到<strong>从 GitHub &#x2F; GitLab 导入仓库</strong> 按钮，如果没有授权及时授权,如图: <img src=\"https://imagecdn.bosong.online/uPic/gitee-home_1647152067844.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gitee-home_1647152067844.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gitee-home_1647152067844\"></li>\n<li>进入菜单以后，可以看到你的github仓库列表（及时授权），然后选择你要导入的仓库导入就可以了，这样就完成了数据的全量迁移过程，非常简单。如图：<img src=\"https://imagecdn.bosong.online/uPic/gitee-repo_1647152429308.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gitee-repo_1647152429308.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gitee-repo_1647152429308\"></li>\n</ol>\n<h3 id=\"数据仓库的增量同步\"><a href=\"#数据仓库的增量同步\" class=\"headerlink\" title=\"数据仓库的增量同步\"></a>数据仓库的增量同步</h3><p>全量迁移进行的非常顺利，接下来是对你需要经常写入的仓库进行数据的增量同步了，可以慢慢来，先将关键步骤记录下来，然后逐步逐个迁移，这样能将大量的工作分散开来。</p>\n<p>迁移的技术方案：使用github的actions将当前仓库的提交记录同步到gitee中，个人免费版每个月有2000分钟的actions使用时间，相对来说还是比较富余的，大概1-2分钟可以同步一次commit，能同步一千来个commit，基本上够用。</p>\n<p>迁移的步骤：</p>\n<ol>\n<li>准备github和gitee需要的秘钥，例如github和gitee对应的专用ssh秘钥、gitee的个人token、gitee的用户名</li>\n<li>编写github action的action.yml文件，按照实际情况进行跳转，我使用的是: <a href=\"https://github.com/Yikun/hub-mirror-action\">Yikun&#x2F;hub-mirror-action</a>，一点开进去就是对应的说明介绍，我就不作多说</li>\n<li>提交commit 查看对应的gitee仓库是否更新到了最新的commit</li>\n</ol>\n<p>需要注意的点：</p>\n<ul>\n<li>我在action中拉取代码和提交代码都使用的是ssh方式，所以需要自己创建一对ssh秘钥，可以点击<a href=\"https://gitee.com/help/articles/4181#article-header0\">此处</a>查看教程，此时github、gitee都需要配置这个ssh公钥。</li>\n<li>在此过程中，如果是新创建的仓库需要同步，可以不在gitee那创建对应的仓库，action会自动创建，此时需要gitee的token，可以点击<a href=\"https://gitee.com/profile/personal_access_tokens/new\">此处</a>生成token（实测发现gitee的企业版有坑，注意）。</li>\n<li>注意源仓库（github）对应的用户属性，设置<code>src_account_type</code>为<code>user or org</code> ，目标仓库（gitee）的参数是<code>dst_account_type</code> ，设置也同样如此。</li>\n<li>将<code>GITEE_PRIVATE_KEY</code>、<code>GITEE_TOKEN</code> 、<code>GITEE_USER</code> 都配置到github的<strong>Actions secrets</strong>中去,然后再编写如下所示的action。</li>\n</ul>\n<p>配置<strong>Actions secrets</strong></p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/gihub-secrets_1647153632395.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gihub-secrets_1647153632395.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gihub-secrets_1647153632395\"></p>\n<p>创建github action 入口<br><img src=\"https://imagecdn.bosong.online/uPic/github-action_1647153612114.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/github-action_1647153612114.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"github-action_1647153612114\"></p>\n<p>对应的yml文件：</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This is a basic workflow to help you get started with Actions</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">CI</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Controls when the workflow will run</span></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"comment\"># Triggers the workflow on push or pull request events but only for the main branch</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span> [ <span class=\"string\">main</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Allows you to run this workflow manually from the Actions tab</span></span><br><span class=\"line\">  <span class=\"attr\">workflow_dispatch:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">repo-sync:</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">      <span class=\"attr\">dst_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PRIVATE_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">dst_token:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">gitee_user:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_USER</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"attr\">persist-credentials:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">sync</span> <span class=\"string\">github</span> <span class=\"number\">2</span> <span class=\"string\">gitee</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">Yikun/hub-mirror-action@master</span></span><br><span class=\"line\">        <span class=\"attr\">if:</span> <span class=\"string\">env.dst_key</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">env.dst_token</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">env.gitee_user</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，需要同步的 Github 用户（源）</span></span><br><span class=\"line\">          <span class=\"attr\">src:</span> <span class=\"string\">&#x27;github/$<span class=\"template-variable\">&#123;&#123; github.repository_owner &#125;&#125;</span>&#x27;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，需要同步到的 Gitee 用户（目的）</span></span><br><span class=\"line\">          <span class=\"attr\">dst:</span> <span class=\"string\">&#x27;gitee/$<span class=\"template-variable\">&#123;&#123; secrets.GITEE_USER &#125;&#125;</span>&#x27;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，Gitee公钥对应的私钥，https://gitee.com/profile/sshkeys</span></span><br><span class=\"line\">          <span class=\"attr\">dst_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PRIVATE_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，Gitee对应的用于创建仓库的token，https://gitee.com/profile/personal_access_tokens</span></span><br><span class=\"line\">          <span class=\"attr\">dst_token:</span>  <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果是组织，指定组织即可，默认为用户 user</span></span><br><span class=\"line\">          <span class=\"comment\"># account_type: org</span></span><br><span class=\"line\">          <span class=\"comment\"># 直接取当前项目的仓库名</span></span><br><span class=\"line\">          <span class=\"attr\">static_list:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.repository.name</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\">#启用git push -f强制同步，注意：开启后，会强制覆盖目的端仓库。</span></span><br><span class=\"line\">          <span class=\"attr\">clone_style:</span> <span class=\"string\">ssh</span></span><br><span class=\"line\">          <span class=\"comment\">#默认为https，可以设置为ssh或者https。当设置为ssh时，你需要将dst_key所对应的公钥同时配置到源端和目的端</span></span><br><span class=\"line\">          <span class=\"attr\">force_update:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"comment\">#配置cache</span></span><br><span class=\"line\">          <span class=\"attr\">cache_path:</span> <span class=\"string\">/github/workspace/hub-mirror-cache</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">#源账户的类型：user or org</span></span><br><span class=\"line\">          <span class=\"attr\">src_account_type:</span> <span class=\"string\">user</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">#目标账户的类型：user or org</span></span><br><span class=\"line\">          <span class=\"attr\">dst_account_type:</span> <span class=\"string\">org</span></span><br></pre></td></tr></table></figure>\n<p>直接按照以上配置进行修改即可，开箱即用，配置好了之后，可以提交一条commit 试试效果，job执行结果如下：</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/github-action-result_1647153859714.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/github-action-result_1647153859714.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"github-action-result_1647153859714\"></p>\n<h3 id=\"查看源仓库和目标仓库的记录是否对应\"><a href=\"#查看源仓库和目标仓库的记录是否对应\" class=\"headerlink\" title=\"查看源仓库和目标仓库的记录是否对应\"></a>查看源仓库和目标仓库的记录是否对应</h3><p>检查一下源仓库（github）和目标仓库（gitee）对应的提交记录是否对应，如果对应上了就没啥问题，不然就再看看actions的执行情况。</p>\n<p>到这就完成了从github到gitee的迁移过程了，标准的数据库数据迁移做法：全量迁移+增量同步，如果有啥情况，随时可以无损迁移到gitee。</p>\n</div><div class=\"story post-story\"><h2 id=\"codng的devops\"><a href=\"#codng的devops\" class=\"headerlink\" title=\"codng的devops\"></a>codng的devops</h2><p>其实从github迁移到gitee不仅仅是代码数据库的迁移，还有后面的一系列的devops对应的地址改变，我这边主要就是在coding的持续集成,由于我的Jenkinsfile全部都是写在代码仓库里的，这时候切换就非常方便了，直接将对应的代码源从github切换成gitee的同名仓库即可，基本没有代价。</p>\n<p>可能会有人问gitee也有对应的持续集成 <strong>gitee go</strong> 为啥不直接在gitee中生态圈使用，主要还是因为不能和coding一样我直接在自己的主机上执行任务，这样就不计算它的免费时间了，而且coding每个月会给1000分钟的免费时间，基本上也是用不完的。（主要是省钱和合理资源利用）。</p>\n<p>直接将github的源代码仓库修改为gitee：</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/coding-deploy_1647154646788.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/coding-deploy_1647154646788.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"coding-deploy_1647154646788\"></p>\n<p>如果有自有云主机，可以配置在coding的资源池中使用，这样还不占用coding的免费时间，达到资源合理利用的目的</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/coding-host_1647154660760.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/coding-host_1647154660760.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"coding-host_1647154660760\"></p>\n<p>其实从github迁移到gitee 还有一层大的好处：不需要考虑你的国内云服务器拉不下来github代码的问题了，我的云主机十次有九次拉不下来github的代码，所以我一直使用coding自带的资源池。</p>\n<p>另外一部分还有就是如何使用coding的持续集成功能部署<strong>hugo</strong> 项目，我会出一篇文章详细说明。</p>\n</div><div class=\"story post-story\"><h2 id=\"结果和想法\"><a href=\"#结果和想法\" class=\"headerlink\" title=\"结果和想法\"></a>结果和想法</h2><p>有些事想想觉得还挺费劲，但是一旦深入了解后做起来，发现还是挺简单，有时候就需要突破思维定势，你理解的难是建立在你固有的思维体系中的，如果要说难，先详细的去了解过整个过程后再去说难。</p>\n<p>迁移和部署都出乎我想象的顺利，整个过程几个小时就完成了，支持重要的软件国产化，自有化，这样才能不被卡脖子。只要你足够强大，那么别人的制裁就只是个笑话了。</p>\n\n</div>","more":"<div class=\"story post-story\"><h2 id=\"迁移的步骤\"><a href=\"#迁移的步骤\" class=\"headerlink\" title=\"迁移的步骤\"></a>迁移的步骤</h2><p>得益于github和gitee的用户群体都同样的大，绝大部分的坑都已经被前人趟过，我们只要稍加整理就好了。</p>\n<p>从github迁移到gitee主要分为两步走：</p>\n<ul>\n<li>将github的所有个人仓库全量迁移到gitee</li>\n<li>将github的相关代码提交使用自动化的方式提交到gitee，保持仓库同步</li>\n</ul>\n<p>以上的方案是不是很熟悉：完全就是数据库的数据热迁移步骤。下面我将详细说明以上两个步骤的具体情况：</p>\n<h3 id=\"数据仓库的全量迁移\"><a href=\"#数据仓库的全量迁移\" class=\"headerlink\" title=\"数据仓库的全量迁移\"></a>数据仓库的全量迁移</h3><p>感谢gitee提供的数据全量迁移功能，让我如此没有障碍的快速进行数据迁移，不得不说软件国产化做的越来越好，越来越贴近中国人的使用习惯。</p>\n<ol>\n<li>先登录到gitee进入主页，点击+号，然后可以看到<strong>从 GitHub &#x2F; GitLab 导入仓库</strong> 按钮，如果没有授权及时授权,如图: <img src=\"https://imagecdn.bosong.online/uPic/gitee-home_1647152067844.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gitee-home_1647152067844.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gitee-home_1647152067844\"></li>\n<li>进入菜单以后，可以看到你的github仓库列表（及时授权），然后选择你要导入的仓库导入就可以了，这样就完成了数据的全量迁移过程，非常简单。如图：<img src=\"https://imagecdn.bosong.online/uPic/gitee-repo_1647152429308.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gitee-repo_1647152429308.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gitee-repo_1647152429308\"></li>\n</ol>\n<h3 id=\"数据仓库的增量同步\"><a href=\"#数据仓库的增量同步\" class=\"headerlink\" title=\"数据仓库的增量同步\"></a>数据仓库的增量同步</h3><p>全量迁移进行的非常顺利，接下来是对你需要经常写入的仓库进行数据的增量同步了，可以慢慢来，先将关键步骤记录下来，然后逐步逐个迁移，这样能将大量的工作分散开来。</p>\n<p>迁移的技术方案：使用github的actions将当前仓库的提交记录同步到gitee中，个人免费版每个月有2000分钟的actions使用时间，相对来说还是比较富余的，大概1-2分钟可以同步一次commit，能同步一千来个commit，基本上够用。</p>\n<p>迁移的步骤：</p>\n<ol>\n<li>准备github和gitee需要的秘钥，例如github和gitee对应的专用ssh秘钥、gitee的个人token、gitee的用户名</li>\n<li>编写github action的action.yml文件，按照实际情况进行跳转，我使用的是: <a href=\"https://github.com/Yikun/hub-mirror-action\">Yikun&#x2F;hub-mirror-action</a>，一点开进去就是对应的说明介绍，我就不作多说</li>\n<li>提交commit 查看对应的gitee仓库是否更新到了最新的commit</li>\n</ol>\n<p>需要注意的点：</p>\n<ul>\n<li>我在action中拉取代码和提交代码都使用的是ssh方式，所以需要自己创建一对ssh秘钥，可以点击<a href=\"https://gitee.com/help/articles/4181#article-header0\">此处</a>查看教程，此时github、gitee都需要配置这个ssh公钥。</li>\n<li>在此过程中，如果是新创建的仓库需要同步，可以不在gitee那创建对应的仓库，action会自动创建，此时需要gitee的token，可以点击<a href=\"https://gitee.com/profile/personal_access_tokens/new\">此处</a>生成token（实测发现gitee的企业版有坑，注意）。</li>\n<li>注意源仓库（github）对应的用户属性，设置<code>src_account_type</code>为<code>user or org</code> ，目标仓库（gitee）的参数是<code>dst_account_type</code> ，设置也同样如此。</li>\n<li>将<code>GITEE_PRIVATE_KEY</code>、<code>GITEE_TOKEN</code> 、<code>GITEE_USER</code> 都配置到github的<strong>Actions secrets</strong>中去,然后再编写如下所示的action。</li>\n</ul>\n<p>配置<strong>Actions secrets</strong></p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/gihub-secrets_1647153632395.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/gihub-secrets_1647153632395.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"gihub-secrets_1647153632395\"></p>\n<p>创建github action 入口<br><img src=\"https://imagecdn.bosong.online/uPic/github-action_1647153612114.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/github-action_1647153612114.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"github-action_1647153612114\"></p>\n<p>对应的yml文件：</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># This is a basic workflow to help you get started with Actions</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">name:</span> <span class=\"string\">CI</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Controls when the workflow will run</span></span><br><span class=\"line\"><span class=\"attr\">on:</span></span><br><span class=\"line\">  <span class=\"comment\"># Triggers the workflow on push or pull request events but only for the main branch</span></span><br><span class=\"line\">  <span class=\"attr\">push:</span></span><br><span class=\"line\">    <span class=\"attr\">branches:</span> [ <span class=\"string\">main</span> ]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Allows you to run this workflow manually from the Actions tab</span></span><br><span class=\"line\">  <span class=\"attr\">workflow_dispatch:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span><br><span class=\"line\"><span class=\"attr\">jobs:</span></span><br><span class=\"line\">  <span class=\"attr\">repo-sync:</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">      <span class=\"attr\">dst_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PRIVATE_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">dst_token:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">gitee_user:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_USER</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">runs-on:</span> <span class=\"string\">ubuntu-latest</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"attr\">persist-credentials:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">sync</span> <span class=\"string\">github</span> <span class=\"number\">2</span> <span class=\"string\">gitee</span></span><br><span class=\"line\">        <span class=\"attr\">uses:</span> <span class=\"string\">Yikun/hub-mirror-action@master</span></span><br><span class=\"line\">        <span class=\"attr\">if:</span> <span class=\"string\">env.dst_key</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">env.dst_token</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">env.gitee_user</span></span><br><span class=\"line\">        <span class=\"attr\">with:</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，需要同步的 Github 用户（源）</span></span><br><span class=\"line\">          <span class=\"attr\">src:</span> <span class=\"string\">&#x27;github/$<span class=\"template-variable\">&#123;&#123; github.repository_owner &#125;&#125;</span>&#x27;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，需要同步到的 Gitee 用户（目的）</span></span><br><span class=\"line\">          <span class=\"attr\">dst:</span> <span class=\"string\">&#x27;gitee/$<span class=\"template-variable\">&#123;&#123; secrets.GITEE_USER &#125;&#125;</span>&#x27;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，Gitee公钥对应的私钥，https://gitee.com/profile/sshkeys</span></span><br><span class=\"line\">          <span class=\"attr\">dst_key:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_PRIVATE_KEY</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># 必选，Gitee对应的用于创建仓库的token，https://gitee.com/profile/personal_access_tokens</span></span><br><span class=\"line\">          <span class=\"attr\">dst_token:</span>  <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">secrets.GITEE_TOKEN</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果是组织，指定组织即可，默认为用户 user</span></span><br><span class=\"line\">          <span class=\"comment\"># account_type: org</span></span><br><span class=\"line\">          <span class=\"comment\"># 直接取当前项目的仓库名</span></span><br><span class=\"line\">          <span class=\"attr\">static_list:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.repository.name</span> <span class=\"string\">&#125;&#125;</span></span><br><span class=\"line\">          <span class=\"comment\">#启用git push -f强制同步，注意：开启后，会强制覆盖目的端仓库。</span></span><br><span class=\"line\">          <span class=\"attr\">clone_style:</span> <span class=\"string\">ssh</span></span><br><span class=\"line\">          <span class=\"comment\">#默认为https，可以设置为ssh或者https。当设置为ssh时，你需要将dst_key所对应的公钥同时配置到源端和目的端</span></span><br><span class=\"line\">          <span class=\"attr\">force_update:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"comment\">#配置cache</span></span><br><span class=\"line\">          <span class=\"attr\">cache_path:</span> <span class=\"string\">/github/workspace/hub-mirror-cache</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">#源账户的类型：user or org</span></span><br><span class=\"line\">          <span class=\"attr\">src_account_type:</span> <span class=\"string\">user</span></span><br><span class=\"line\">\t\t\t\t\t<span class=\"comment\">#目标账户的类型：user or org</span></span><br><span class=\"line\">          <span class=\"attr\">dst_account_type:</span> <span class=\"string\">org</span></span><br></pre></td></tr></table></figure>\n<p>直接按照以上配置进行修改即可，开箱即用，配置好了之后，可以提交一条commit 试试效果，job执行结果如下：</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/github-action-result_1647153859714.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/github-action-result_1647153859714.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"github-action-result_1647153859714\"></p>\n<h3 id=\"查看源仓库和目标仓库的记录是否对应\"><a href=\"#查看源仓库和目标仓库的记录是否对应\" class=\"headerlink\" title=\"查看源仓库和目标仓库的记录是否对应\"></a>查看源仓库和目标仓库的记录是否对应</h3><p>检查一下源仓库（github）和目标仓库（gitee）对应的提交记录是否对应，如果对应上了就没啥问题，不然就再看看actions的执行情况。</p>\n<p>到这就完成了从github到gitee的迁移过程了，标准的数据库数据迁移做法：全量迁移+增量同步，如果有啥情况，随时可以无损迁移到gitee。</p>\n</div><div class=\"story post-story\"><h2 id=\"codng的devops\"><a href=\"#codng的devops\" class=\"headerlink\" title=\"codng的devops\"></a>codng的devops</h2><p>其实从github迁移到gitee不仅仅是代码数据库的迁移，还有后面的一系列的devops对应的地址改变，我这边主要就是在coding的持续集成,由于我的Jenkinsfile全部都是写在代码仓库里的，这时候切换就非常方便了，直接将对应的代码源从github切换成gitee的同名仓库即可，基本没有代价。</p>\n<p>可能会有人问gitee也有对应的持续集成 <strong>gitee go</strong> 为啥不直接在gitee中生态圈使用，主要还是因为不能和coding一样我直接在自己的主机上执行任务，这样就不计算它的免费时间了，而且coding每个月会给1000分钟的免费时间，基本上也是用不完的。（主要是省钱和合理资源利用）。</p>\n<p>直接将github的源代码仓库修改为gitee：</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/coding-deploy_1647154646788.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/coding-deploy_1647154646788.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"coding-deploy_1647154646788\"></p>\n<p>如果有自有云主机，可以配置在coding的资源池中使用，这样还不占用coding的免费时间，达到资源合理利用的目的</p>\n<p><img src=\"https://imagecdn.bosong.online/uPic/coding-host_1647154660760.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/uPic/coding-host_1647154660760.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"coding-host_1647154660760\"></p>\n<p>其实从github迁移到gitee 还有一层大的好处：不需要考虑你的国内云服务器拉不下来github代码的问题了，我的云主机十次有九次拉不下来github的代码，所以我一直使用coding自带的资源池。</p>\n<p>另外一部分还有就是如何使用coding的持续集成功能部署<strong>hugo</strong> 项目，我会出一篇文章详细说明。</p>\n</div><div class=\"story post-story\"><h2 id=\"结果和想法\"><a href=\"#结果和想法\" class=\"headerlink\" title=\"结果和想法\"></a>结果和想法</h2><p>有些事想想觉得还挺费劲，但是一旦深入了解后做起来，发现还是挺简单，有时候就需要突破思维定势，你理解的难是建立在你固有的思维体系中的，如果要说难，先详细的去了解过整个过程后再去说难。</p>\n<p>迁移和部署都出乎我想象的顺利，整个过程几个小时就完成了，支持重要的软件国产化，自有化，这样才能不被卡脖子。只要你足够强大，那么别人的制裁就只是个笑话了。</p>\n\n</div>","categories":[{"name":"技术手册","path":"api/categories/技术手册.json"}],"tags":[{"name":"github","path":"api/tags/github.json"},{"name":"gitee","path":"api/tags/gitee.json"},{"name":"devops","path":"api/tags/devops.json"},{"name":"coding","path":"api/tags/coding.json"}]}