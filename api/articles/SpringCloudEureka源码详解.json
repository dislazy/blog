{"title":"SpringCloudEureka源码详解","slug":"SpringCloudEureka源码详解","date":"2018-12-09T12:20:57.000Z","updated":"2022-06-02T01:05:59.615Z","comments":true,"path":"api/articles/SpringCloudEureka源码详解.json","excerpt":"概述Spring Cloud Eureka是Spring Cloud Netflix项目下的服务治理模块。由于微服务概念的引入，使大型服务在一定程度上彻底的解耦，当服务集群足够庞大的时候，服务治理成为了微服务的痛点之一。Eureka是Spring Could中服务发现的推荐组件，保证服务的高可用性，它有着丰富的API，使得Eureka作为服务发现与治理都比较方便。架构与原理 [Figure] 原理：服务启动后向Eureka注册，Eureka Server会将注册信息向其他Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，然后会将服务提供者地址缓存在本地，下次再调用时，则直接从本地缓存中取，完成一次调用。当服务注册中心Eureka  Server检测到服务提供者因为宕机、网络原因不可用时，则在服务注册中心将服务置为DOWN状态，并把当前服务提供者状态向订阅者发布，订阅过的服务消费者更新本地缓存。服务提供者在启动后，周期性（默认30秒）向Eureka Server发送心跳，以证明当前服务是可用状态。Eureka Server在一定的时间（默认90秒）未收到客户端的心跳，则认为服务宕机，注销该实例。源码解读：eureka主体实现方式：ApplicationResource类接收Http服务请求，调用PeerAwareInstanceRegistryImpl的register方法，PeerAwareInstanceRegistryImpl完成服务注册后，调用replicateToPeers向其它Eureka Server节点（Peer）做状态同步。eureka client启动时候会创建一个定时任务，定时任务会将本地的服务配置信息，也就是注册到远端的服务信息自动刷新到注册服务器上，实现了服务注册以及缓存更新的机制。1、com.netflix.discovery.DiscoveryClient.java中的可以看到initScheduledTasks方法，它封装了一个instanceInfoReplicator的定时任务，以一定的时间（默认30秒）来刷新服务的缓存和心跳信息。2、instanceInfoReplicator中的run方法调用register来实现注册功能，start方法实现了定时刷新调用,定时注册到eurekaeureka server1、com.netflix.eureka.resources.ApplicationResource 中使用addInstance方法接收来自client的请求消息，然后进行处理，最终的注册信息缓存在ConcurrentHashMap中，实现服务缓存。Eureka的自我保护机制：在默认情况下，Eureka Server在默认90s时间内没有收到服务端的心跳（默认30秒一次心跳，三次心跳），会将该服务注销。在一般情况下，网络通信的故障率较高，在网络通信出现异常时，Eureka Server如果正常注销服务，将会导致大部分服务不可用，这违背了微服务高可用的初衷，在这种情况下，Eureka Server有自我保护机制，当它在短时间内丢失过多的客户端时（默认15分钟内低于85%），该节点将进入自我保护模式，不再注销服务，并且同时继续提供新服务的注册，当网络故障修复之后，该节点能自动的退出自我保护模式。总之一句话：不管好数据坏数据，一个不落。","covers":["https://imagecdn.bosong.online/image/jiagoutu.png","https://imagecdn.bosong.online/image/eureka.jpeg","https://imagecdn.bosong.online/image/duibi.png","https://imagecdn.bosong.online/image/zhuceguocheng.png","https://imagecdn.bosong.online/image/gaokeyong.png","https://imagecdn.bosong.online/image/hystrix.png","https://imagecdn.bosong.online/image/hysit2.png","https://imagecdn.bosong.online/image/hystic3.png"],"content":"<div class=\"story post-story\"><h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><p>Spring Cloud Eureka是Spring Cloud Netflix项目下的服务治理模块。</p>\n<p>由于微服务概念的引入，使大型服务在一定程度上彻底的解耦，当服务集群足够庞大的时候，服务治理成为了微服务的痛点之一。</p>\n<p>Eureka是Spring Could中服务发现的推荐组件，保证服务的高可用性，它有着丰富的API，使得Eureka作为服务发现与治理都比较方便。</p>\n</div><div class=\"story post-story\"><h2 id=\"架构与原理\"><a href=\"#架构与原理\" class=\"headerlink\" title=\"架构与原理\"></a>架构与原理</h2><p><img src=\"https://imagecdn.bosong.online/image/jiagoutu.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/jiagoutu.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"架构图\"></p>\n<ul>\n<li>Eureka Server：服务的注册中心，负责维护注册的服务列表。</li>\n<li>Service Provider：服务提供方，作为一个Eureka Client，向Eureka Server做服务注册、续约和下线等操作，注册的主要数据包括服务名、机器ip、端口号、域名等等。</li>\n<li>Service Consumer：服务消费方，作为一个Eureka Client，向Eureka Server获取Service Provider的注册信息，并通过远程调用与Service Provider进行通信</li>\n</ul>\n<p>Eureka Server作为一个独立的部署单元，以REST API的形式为服务实例提供了注册、管理和查询等操作。同时，Eureka Server也为我们提供了可视化的监控页面，可以直观地看到各个Eureka  Server当前的运行状态和所有已注册服务的情况。如图:</p>\n<p><img src=\"https://imagecdn.bosong.online/image/eureka.jpeg\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/eureka.jpeg\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"eureka\"></p>\n<h3 id=\"原理：\"><a href=\"#原理：\" class=\"headerlink\" title=\"原理：\"></a>原理：</h3><p>服务启动后向Eureka注册，Eureka Server会将注册信息向其他Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，</p>\n<p>然后会将服务提供者地址缓存在本地，下次再调用时，则直接从本地缓存中取，完成一次调用。</p>\n<p>当服务注册中心Eureka  Server检测到服务提供者因为宕机、网络原因不可用时，则在服务注册中心将服务置为DOWN状态，并把当前服务提供者状态向订阅者发布，订阅过的服务消费者更新本地缓存。</p>\n<p>服务提供者在启动后，周期性（默认30秒）向Eureka Server发送心跳，以证明当前服务是可用状态。Eureka Server在一定的时间（默认90秒）未收到客户端的心跳，则认为服务宕机，注销该实例。</p>\n<h3 id=\"源码解读：\"><a href=\"#源码解读：\" class=\"headerlink\" title=\"源码解读：\"></a>源码解读：</h3><p>eureka主体实现方式：</p>\n<p>ApplicationResource类接收Http服务请求，调用PeerAwareInstanceRegistryImpl的register方法，PeerAwareInstanceRegistryImpl完成服务注册后，调用replicateToPeers向其它Eureka Server节点（Peer）做状态同步。</p>\n<h4 id=\"eureka-client\"><a href=\"#eureka-client\" class=\"headerlink\" title=\"eureka client\"></a>eureka client</h4><p>启动时候会创建一个定时任务，定时任务会将本地的服务配置信息，也就是注册到远端的服务信息自动刷新到注册服务器上，实现了服务注册以及缓存更新的机制。</p>\n<p>1、com.netflix.discovery.DiscoveryClient.java中的可以看到initScheduledTasks方法，它封装了一个instanceInfoReplicator的定时任务，以一定的时间（默认30秒）来刷新服务的缓存和心跳信息。</p>\n<p>2、instanceInfoReplicator中的run方法调用register来实现注册功能，start方法实现了定时刷新调用,定时注册到eureka</p>\n<h4 id=\"eureka-server\"><a href=\"#eureka-server\" class=\"headerlink\" title=\"eureka server\"></a>eureka server</h4><p>1、com.netflix.eureka.resources.ApplicationResource 中使用addInstance方法接收来自client的请求消息，然后进行处理，最终的注册信息缓存在ConcurrentHashMap中，实现服务缓存。</p>\n<h4 id=\"Eureka的自我保护机制：\"><a href=\"#Eureka的自我保护机制：\" class=\"headerlink\" title=\"Eureka的自我保护机制：\"></a>Eureka的自我保护机制：</h4><p>在默认情况下，Eureka Server在默认90s时间内没有收到服务端的心跳（默认30秒一次心跳，三次心跳），会将该服务注销。在一般情况下，网络通信的故障率较高，在网络通信出现异常时，Eureka Server如果正常注销服务，</p>\n<p>将会导致大部分服务不可用，这违背了微服务高可用的初衷，在这种情况下，Eureka Server有自我保护机制，当它在短时间内丢失过多的客户端时（默认15分钟内低于85%），该节点将进入自我保护模式，不再注销服务，并且同时继续提供新服务的注册，当网络故障修复之后，该节点能自动的退出自我保护模式。</p>\n<p>总之一句话：不管好数据坏数据，一个不落。</p>\n</div><div class=\"story post-story\"><h2 id=\"核心特性\"><a href=\"#核心特性\" class=\"headerlink\" title=\"核心特性\"></a>核心特性</h2><ul>\n<li>Eureka通过相互注册与复制支持高可用</li>\n<li>Eureka支持用户认证</li>\n<li>Eureka Client支持注册表缓存</li>\n<li>Eureka提供保护模式以解决网络分区故障</li>\n<li>Eureka提供健康检查</li>\n<li>Eureka支持RESTful API</li>\n</ul>\n<p>为什么选择Eureka而非Zookeeper作为服务发现组件，以下对比：</p>\n<p><img src=\"https://imagecdn.bosong.online/image/duibi.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/duibi.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"对比图\"></p>\n</div><div class=\"story post-story\"><h2 id=\"使用方法\"><a href=\"#使用方法\" class=\"headerlink\" title=\"使用方法\"></a>使用方法</h2><h3 id=\"服务注册过程：\"><a href=\"#服务注册过程：\" class=\"headerlink\" title=\"服务注册过程：\"></a>服务注册过程：</h3><p><img src=\"https://imagecdn.bosong.online/image/zhuceguocheng.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/zhuceguocheng.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"对比图\"></p>\n<p>当实例状态发生变化时（上线Or下线），都会请求到eureka-server发送一个状态，在一定的时间后，eureka会对该服务进行加入或者删除，然后进行eureka集群的缓存复制。</p>\n<h4 id=\"创建Eureka-Sever服务\"><a href=\"#创建Eureka-Sever服务\" class=\"headerlink\" title=\"创建Eureka Sever服务\"></a>创建Eureka Sever服务</h4><p>1.创建一个Spring Boot工程，命名问Eureka-Server，并在pom文件中引入依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class=\"line\">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </span><br><span class=\"line\">        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;dependencyManagement&gt;</span><br><span class=\"line\">        &lt;dependencies&gt;</span><br><span class=\"line\">            &lt;dependency&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class=\"line\">                &lt;version&gt;Dalston.SR1&lt;/version&gt;</span><br><span class=\"line\">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">            &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>\n\n<p>2.创建启动类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@EnableEurekaServer //用来指定该项目为Eureka的服务注册中心</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class EurekaApp &#123;</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        SpringApplication.run(EurekaApp.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>3.配置server服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># server (eureka 默认端口为：8761)</span><br><span class=\"line\">server.port=8761</span><br><span class=\"line\"># spring</span><br><span class=\"line\">spring.application.name=spring-cloud-server</span><br><span class=\"line\"># eureka</span><br><span class=\"line\"># 是否注册到eureka</span><br><span class=\"line\">eureka.client.register-with-eureka=false</span><br><span class=\"line\"># 是否从eureka获取注册信息</span><br><span class=\"line\">eureka.client.fetch-registry=false</span><br><span class=\"line\"># eureka服务器的地址（注意：地址最后面的 /eureka/ 这个是固定值）</span><br><span class=\"line\">eureka.client.serviceUrl.defaultZone=http://localhost:$&#123;server.port&#125;/eureka/</span><br><span class=\"line\"></span><br><span class=\"line\"># info自定义,读取pom文件中的内容</span><br><span class=\"line\">info.build.name=@project.name@</span><br><span class=\"line\">info.build.description=@project.description@</span><br><span class=\"line\">info.build.groupId=@project.groupId@</span><br><span class=\"line\">info.build.artifact=@project.artifactId@</span><br><span class=\"line\">info.build.version=@project.version@</span><br><span class=\"line\"># 指定环境</span><br><span class=\"line\">eureka.environment=dev</span><br><span class=\"line\"></span><br><span class=\"line\">#指定数据中心</span><br><span class=\"line\">#eureka.datacenter=roncoo</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置自我保护模式</span><br><span class=\"line\">eureka.server.enable-self-preservation=true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置清理无效节点的时间间隔，默认60000，即是60s</span><br><span class=\"line\">eureka.server.eviction-interval-timer-in-ms=5000</span><br><span class=\"line\">#设置连接密码</span><br><span class=\"line\">security.basic.enabled=true</span><br><span class=\"line\">security.user.name=qb</span><br><span class=\"line\">security.user.password=123456</span><br></pre></td></tr></table></figure>\n\n<p>4.配置完成启动eureka server即可，访问<a href=\"http://localhost:8761/eureka/\">http://localhost:8761/eureka/</a></p>\n<h4 id=\"Eureka高可用集群配置\"><a href=\"#Eureka高可用集群配置\" class=\"headerlink\" title=\"Eureka高可用集群配置:\"></a>Eureka高可用集群配置:</h4><p><img src=\"https://imagecdn.bosong.online/image/gaokeyong.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/gaokeyong.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"高可用\"></p>\n<p>三注册中心，两两互相注册将eureka.client.serviceUrl.defaultZone值设置为其他两节点值即可。</p>\n<h4 id=\"创建Eureka-Client项目\"><a href=\"#创建Eureka-Client项目\" class=\"headerlink\" title=\"创建Eureka Client项目\"></a>创建Eureka Client项目</h4><p>1.创建Springboot项目，引入如下依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class=\"line\">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </span><br><span class=\"line\">        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;dependencyManagement&gt;</span><br><span class=\"line\">        &lt;dependencies&gt;</span><br><span class=\"line\">            &lt;dependency&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class=\"line\">                &lt;version&gt;Dalston.SR1&lt;/version&gt;</span><br><span class=\"line\">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">            &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>\n<p>2.新增启动类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**</span><br><span class=\"line\"> * </span><br><span class=\"line\"> * @EnableEurekaServer</span><br><span class=\"line\"> * 用来指定该项目为Eureka的服务注册中心</span><br><span class=\"line\"> */</span><br><span class=\"line\">@EnableDiscoveryClient</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class ClientApp &#123;</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        SpringApplication.run(EurekaApp.class, args);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>3.配置client连接上服务发现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># server</span><br><span class=\"line\">server.port=8888</span><br><span class=\"line\"></span><br><span class=\"line\"># spring</span><br><span class=\"line\">spring.application.name=spring-cloud-consumer</span><br><span class=\"line\"></span><br><span class=\"line\"># eureka</span><br><span class=\"line\">eureka.client.serviceUrl.defaultZone=http://qb:123456@localhost:8761/eureka/</span><br><span class=\"line\"></span><br><span class=\"line\">#自定义访问路径</span><br><span class=\"line\">eureka.instance.status-page-url-path=/info</span><br><span class=\"line\">#自定义实例ID</span><br><span class=\"line\">eureka.instance.instanceId=$&#123;spring.application.name&#125;:$&#123;random.value&#125;</span><br><span class=\"line\">#显示IP地址</span><br><span class=\"line\">eureka.instance.prefer-ip-address=true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置拉取服务注册信息时间，默认60s</span><br><span class=\"line\">eureka.client.registry-fetch-interval-seconds=30</span><br><span class=\"line\"></span><br><span class=\"line\">#指定续约更新频率，默认是30s</span><br><span class=\"line\">eureka.instance.lease-renewal-interval-in-seconds=15</span><br><span class=\"line\"></span><br><span class=\"line\">#设置过期剔除时间，默认90s</span><br><span class=\"line\">eureka.instance.lease-expiration-duration-in-seconds=45</span><br></pre></td></tr></table></figure>\n\n<p>4.启动后，能在Eurekaweb端上看到服务的列表</p>\n<h4 id=\"服务发现使用场景\"><a href=\"#服务发现使用场景\" class=\"headerlink\" title=\"服务发现使用场景\"></a>服务发现使用场景</h4><p>服务发现并不是为了服务发现而服务发现，是为了使用一些必要的功能而必不可少的组件，服务发现的下游有丰富的内部服务调用工具</p>\n<ul>\n<li>Ribbon，实现客户端的负载均衡。</li>\n<li>Hystrix，断路器。</li>\n<li>Feign，RESTful Web Service客户端，整合了Ribbon和Hystrix。</li>\n</ul>\n<h3 id=\"服务调用端负载均衡——Ribbon\"><a href=\"#服务调用端负载均衡——Ribbon\" class=\"headerlink\" title=\"服务调用端负载均衡——Ribbon\"></a>服务调用端负载均衡——Ribbon</h3><p>Ribbon是Netflix发布的开源项目，主要功能是为REST客户端实现负载均衡。它主要包括六个组件：</p>\n<ol>\n<li>ServerList，负载均衡使用的服务器列表。这个列表会缓存在负载均衡器中，并定期更新。当Ribbon与Eureka结合使用时，ServerList的实现类就是DiscoveryEnabledNIWSServerList，它会保存Eureka Server中注册的服务实例表。</li>\n<li>ServerListFilter，服务器列表过滤器。这是一个接口，主要用于对Service Consumer获取到的服务器列表进行预过滤，过滤的结果也是ServerList。Ribbon提供了多种过滤器的实现。</li>\n<li>IPing，探测服务实例是否存活的策略。</li>\n<li>IRule，负载均衡策略，其实现类表述的策略包括：轮询、随机、根据响应时间加权，（可以自定义负载均衡策略，实现完之后可以重新注入ribbon）</li>\n<li>ILoadBalancer，负载均衡器。这也是一个接口，Ribbon为其提供了多个实现，比如ZoneAwareLoadBalancer。而上层代码通过调用其API进行服务调用的负载均衡选择。一般ILoadBalancer的实现类中会引用一个IRule。</li>\n<li>RestClient，服务调用器。顾名思义，这就是负载均衡后，Ribbon向Service Provider发起REST请求的工具。</li>\n</ol>\n<h4 id=\"Ribbon工作时会做四件事情：\"><a href=\"#Ribbon工作时会做四件事情：\" class=\"headerlink\" title=\"Ribbon工作时会做四件事情：\"></a>Ribbon工作时会做四件事情：</h4><p>1.优先选择在同一个Zone（区域）且负载较少的Eureka Server；<br>2.定期从Eureka更新并过滤服务实例列表；<br>3.根据用户指定的策略，在从Server取到的服务注册列表中选择一个实例的地址；<br>4.通过RestClient进行服务调用。</p>\n<h4 id=\"Ribbon的源码实现大致原理：\"><a href=\"#Ribbon的源码实现大致原理：\" class=\"headerlink\" title=\"Ribbon的源码实现大致原理：\"></a>Ribbon的源码实现大致原理：</h4><ul>\n<li><p>LoadBalancerClient ： 继承了ServiceInstanceChooser接口，实现类是RibbonLoadBalancerClient.主要方法有choose（ServiceInstanceChooser用来选择instance） ,execute（LoadBalancerClient 用来执行）.</p>\n</li>\n<li><p>ILoadBalancer:接口方法有addServers，chooseServer，markServerDown,getReachableServers,getAllServers.（负载均衡）实现类为BaseLoadBalancer 和 DynamicServerListLoadBalancer.</p>\n</li>\n<li><p>BaseLoadBalancer :主要由以下类进行配置IClientConfig（基本配置，用于初始化）  IRule（路由策略）  IPing （判断响应）  （静态配置负载均衡）</p>\n</li>\n<li><p>DynamicServerListLoadBalancer： ServerList（用于从Eureka中获取服务列表）  ServerListFilter（列表过滤）  动态配置负载均衡）</p>\n</li>\n</ul>\n<h4 id=\"负载均衡过程：\"><a href=\"#负载均衡过程：\" class=\"headerlink\" title=\"负载均衡过程：\"></a>负载均衡过程：</h4><p> 1.RibbonLoadBalancerClient接收到一个serviceid之后，调用ServiceInstanceChooser的choose方法，choose方法首先得到 ILoadBalancer （当中有client列表）。再利用ILoadBalancer 的chooseServer方法得到普通Server实例并实例化RibbonServer，并返回。chooseserver会通过loadbalancer中的rule来返回正确的instance。</p>\n<p>2.DynamicServerListLoadBalancer由iconfig初始化，初始化完成后调用updateListOfServers方法获得所有ServerList。（方法中通过ServerList实现类来访问EurekaClient中的注册列表）</p>\n<p>3.BaseLoadBalancer中有一个PingTask任务，他每10秒钟会向EurekaClient发送一个Ping。如果从Eureka拉取的注册列表发生了改变，则重新更新列表。</p>\n<p>4.LoadBalancerClient根据注册列表和IRule来进行负载均衡</p>\n<h4 id=\"Ribbon的应用\"><a href=\"#Ribbon的应用\" class=\"headerlink\" title=\"Ribbon的应用\"></a>Ribbon的应用</h4><p>springcloud提供了默认的配置RibbonClientConfiguration。它提供了包含ILoadBalancer,ServerListFilter在内的许多配置。</p>\n<p>你可以更改默认的配置，更改方法为在.property文件中添加<client>.ribbon.*的配置项</p>\n<h3 id=\"服务调用端熔断——Hystrix\"><a href=\"#服务调用端熔断——Hystrix\" class=\"headerlink\" title=\"服务调用端熔断——Hystrix\"></a>服务调用端熔断——Hystrix</h3><p>Netflix创建了一个名为Hystrix的库,实现了断路器的模式。</p>\n<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。<br><img src=\"https://imagecdn.bosong.online/image/hystrix.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hystrix.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix\"><br>正常情况下，在请求失败频率较低的情况下，Hystrix还是会直接把故障返回给客户端。只有当失败次数达到阈值（默认在20秒内失败5次）时，断路器打开并且不进行后续通信，而是直接返回备选响应。</p>\n<p>当然，Hystrix的备选响应也是可以由开发者定制的。<br><img src=\"https://imagecdn.bosong.online/image/hysit2.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hysit2.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix2\"></p>\n<p>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续地记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控。Spring Cloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面，Hystrix Dashboard Wiki上详细说明了图上每个指标的含义。</p>\n<p><img src=\"https://imagecdn.bosong.online/image/hystic3.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hystic3.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix3\"></p>\n<h3 id=\"服务调用端代码抽象和封装——Feign\"><a href=\"#服务调用端代码抽象和封装——Feign\" class=\"headerlink\" title=\"服务调用端代码抽象和封装——Feign\"></a>服务调用端代码抽象和封装——Feign</h3><p>Feign是一个声明式的Web Service客户端，它的目的就是让Web Service调用更加简单。</p>\n<p>它整合了Ribbon和Hystrix，从而让我们不再需要显式地使用这两个组件。</p>\n<p>Feign还提供了HTTP请求的模板，通过编写简单的接口和插入注解，我们就可以定义好HTTP请求的参数、格式、地址等信息。</p>\n<p>接下来，Feign会完全代理HTTP的请求，我们只需要像调用方法一样调用它就可以完成服务请求。</p>\n<p>Feign具有如下特性：</p>\n<ul>\n<li>可插拔的注解支持，包括Feign注解和JAX-RS注解</li>\n<li>支持可插拔的HTTP编码器和解码器</li>\n<li>支持Hystrix和它的Fallback</li>\n<li>支持Ribbon的负载均衡</li>\n<li>支持HTTP请求和响应的压缩</li>\n</ul>\n<p>以下是一个Feign的简单示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">@EnableDiscoveryClient </span><br><span class=\"line\">@EnableFeignClients  //启用fegin调用</span><br><span class=\"line\">public class Application</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public static void main(String[] args)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        SpringApplication.run(Application.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@FeignClient(name = &quot;elements&quot;, fallback = ElementsFallback.class) //指定feign调用的服务和Hystrix Fallback（name即eureka的application name）</span><br><span class=\"line\">public interface Elements</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @RequestMapping(value = &quot;/index&quot;)</span><br><span class=\"line\">    String index();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//Hystrix Fallback  </span><br><span class=\"line\">@Component</span><br><span class=\"line\">public class ElementsFallback implements Elements</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public String index()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        return &quot;熔断生效&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//测试类</span><br><span class=\"line\">@Component  </span><br><span class=\"line\">public class TestController &#123;</span><br><span class=\"line\">    @Autowired</span><br><span class=\"line\">    Elements elements;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(value = &quot;/testEureka&quot;, method = RequestMethod.GET)</span><br><span class=\"line\">    public String testeureka()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        return elements.index();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 说明：<br>（1）使用 <code>@Component</code>  注解向SpringBoot中注入该组件。</p>\n<p>（2）使用<code>@FeignClient(&quot;XXX&quot;)</code>注解来绑定该接口对应的服务。</p>\n<p>注意：在启动类上加 @EnableFeignClients 注解，如果定义的Feign接口定义跟启动类不在一个包名下，还需要制定扫描的包名：<code>@EnableFeignClients(basePackages = &quot;xxx.xxx.xxx&quot;)</code></p>\n<p>建议将接口定义，单独抽一个项目出来，后面打成公共的jar，这样无论是哪个项目需要调用接口，引入公共的接口SDK jar即可，不需要重新定义一遍。</p>\n</div><div class=\"story post-story\"><h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><p>eureka在服务下线后30秒节点还存在，需妥善处理</p>\n</div><div class=\"story post-story\"><h2 id=\"替代方案\"><a href=\"#替代方案\" class=\"headerlink\" title=\"替代方案\"></a>替代方案</h2><p>Eureka-&gt;consul consul实际也是CP型服务发现，并且监控的指标较多，可作为替代方案</p>\n<p>Ribbon-&gt;nginx 负载均衡nginx有相对较为成熟的机制，但是配置项较多，谨慎使用</p>\n\n</div>","more":"<div class=\"story post-story\"><h2 id=\"核心特性\"><a href=\"#核心特性\" class=\"headerlink\" title=\"核心特性\"></a>核心特性</h2><ul>\n<li>Eureka通过相互注册与复制支持高可用</li>\n<li>Eureka支持用户认证</li>\n<li>Eureka Client支持注册表缓存</li>\n<li>Eureka提供保护模式以解决网络分区故障</li>\n<li>Eureka提供健康检查</li>\n<li>Eureka支持RESTful API</li>\n</ul>\n<p>为什么选择Eureka而非Zookeeper作为服务发现组件，以下对比：</p>\n<p><img src=\"https://imagecdn.bosong.online/image/duibi.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/duibi.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"对比图\"></p>\n</div><div class=\"story post-story\"><h2 id=\"使用方法\"><a href=\"#使用方法\" class=\"headerlink\" title=\"使用方法\"></a>使用方法</h2><h3 id=\"服务注册过程：\"><a href=\"#服务注册过程：\" class=\"headerlink\" title=\"服务注册过程：\"></a>服务注册过程：</h3><p><img src=\"https://imagecdn.bosong.online/image/zhuceguocheng.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/zhuceguocheng.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"对比图\"></p>\n<p>当实例状态发生变化时（上线Or下线），都会请求到eureka-server发送一个状态，在一定的时间后，eureka会对该服务进行加入或者删除，然后进行eureka集群的缓存复制。</p>\n<h4 id=\"创建Eureka-Sever服务\"><a href=\"#创建Eureka-Sever服务\" class=\"headerlink\" title=\"创建Eureka Sever服务\"></a>创建Eureka Sever服务</h4><p>1.创建一个Spring Boot工程，命名问Eureka-Server，并在pom文件中引入依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class=\"line\">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </span><br><span class=\"line\">        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;dependencyManagement&gt;</span><br><span class=\"line\">        &lt;dependencies&gt;</span><br><span class=\"line\">            &lt;dependency&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class=\"line\">                &lt;version&gt;Dalston.SR1&lt;/version&gt;</span><br><span class=\"line\">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">            &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>\n\n<p>2.创建启动类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@EnableEurekaServer //用来指定该项目为Eureka的服务注册中心</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class EurekaApp &#123;</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        SpringApplication.run(EurekaApp.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>3.配置server服务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># server (eureka 默认端口为：8761)</span><br><span class=\"line\">server.port=8761</span><br><span class=\"line\"># spring</span><br><span class=\"line\">spring.application.name=spring-cloud-server</span><br><span class=\"line\"># eureka</span><br><span class=\"line\"># 是否注册到eureka</span><br><span class=\"line\">eureka.client.register-with-eureka=false</span><br><span class=\"line\"># 是否从eureka获取注册信息</span><br><span class=\"line\">eureka.client.fetch-registry=false</span><br><span class=\"line\"># eureka服务器的地址（注意：地址最后面的 /eureka/ 这个是固定值）</span><br><span class=\"line\">eureka.client.serviceUrl.defaultZone=http://localhost:$&#123;server.port&#125;/eureka/</span><br><span class=\"line\"></span><br><span class=\"line\"># info自定义,读取pom文件中的内容</span><br><span class=\"line\">info.build.name=@project.name@</span><br><span class=\"line\">info.build.description=@project.description@</span><br><span class=\"line\">info.build.groupId=@project.groupId@</span><br><span class=\"line\">info.build.artifact=@project.artifactId@</span><br><span class=\"line\">info.build.version=@project.version@</span><br><span class=\"line\"># 指定环境</span><br><span class=\"line\">eureka.environment=dev</span><br><span class=\"line\"></span><br><span class=\"line\">#指定数据中心</span><br><span class=\"line\">#eureka.datacenter=roncoo</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置自我保护模式</span><br><span class=\"line\">eureka.server.enable-self-preservation=true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置清理无效节点的时间间隔，默认60000，即是60s</span><br><span class=\"line\">eureka.server.eviction-interval-timer-in-ms=5000</span><br><span class=\"line\">#设置连接密码</span><br><span class=\"line\">security.basic.enabled=true</span><br><span class=\"line\">security.user.name=qb</span><br><span class=\"line\">security.user.password=123456</span><br></pre></td></tr></table></figure>\n\n<p>4.配置完成启动eureka server即可，访问<a href=\"http://localhost:8761/eureka/\">http://localhost:8761/eureka/</a></p>\n<h4 id=\"Eureka高可用集群配置\"><a href=\"#Eureka高可用集群配置\" class=\"headerlink\" title=\"Eureka高可用集群配置:\"></a>Eureka高可用集群配置:</h4><p><img src=\"https://imagecdn.bosong.online/image/gaokeyong.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/gaokeyong.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"高可用\"></p>\n<p>三注册中心，两两互相注册将eureka.client.serviceUrl.defaultZone值设置为其他两节点值即可。</p>\n<h4 id=\"创建Eureka-Client项目\"><a href=\"#创建Eureka-Client项目\" class=\"headerlink\" title=\"创建Eureka Client项目\"></a>创建Eureka Client项目</h4><p>1.创建Springboot项目，引入如下依赖：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;properties&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class=\"line\">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </span><br><span class=\"line\">        &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;dependencyManagement&gt;</span><br><span class=\"line\">        &lt;dependencies&gt;</span><br><span class=\"line\">            &lt;dependency&gt;</span><br><span class=\"line\">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class=\"line\">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class=\"line\">                &lt;version&gt;Dalston.SR1&lt;/version&gt;</span><br><span class=\"line\">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class=\"line\">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class=\"line\">            &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;/dependencies&gt;</span><br><span class=\"line\">    &lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>\n<p>2.新增启动类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/**</span><br><span class=\"line\"> * </span><br><span class=\"line\"> * @EnableEurekaServer</span><br><span class=\"line\"> * 用来指定该项目为Eureka的服务注册中心</span><br><span class=\"line\"> */</span><br><span class=\"line\">@EnableDiscoveryClient</span><br><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">public class ClientApp &#123;</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        SpringApplication.run(EurekaApp.class, args);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>3.配置client连接上服务发现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># server</span><br><span class=\"line\">server.port=8888</span><br><span class=\"line\"></span><br><span class=\"line\"># spring</span><br><span class=\"line\">spring.application.name=spring-cloud-consumer</span><br><span class=\"line\"></span><br><span class=\"line\"># eureka</span><br><span class=\"line\">eureka.client.serviceUrl.defaultZone=http://qb:123456@localhost:8761/eureka/</span><br><span class=\"line\"></span><br><span class=\"line\">#自定义访问路径</span><br><span class=\"line\">eureka.instance.status-page-url-path=/info</span><br><span class=\"line\">#自定义实例ID</span><br><span class=\"line\">eureka.instance.instanceId=$&#123;spring.application.name&#125;:$&#123;random.value&#125;</span><br><span class=\"line\">#显示IP地址</span><br><span class=\"line\">eureka.instance.prefer-ip-address=true</span><br><span class=\"line\"></span><br><span class=\"line\">#设置拉取服务注册信息时间，默认60s</span><br><span class=\"line\">eureka.client.registry-fetch-interval-seconds=30</span><br><span class=\"line\"></span><br><span class=\"line\">#指定续约更新频率，默认是30s</span><br><span class=\"line\">eureka.instance.lease-renewal-interval-in-seconds=15</span><br><span class=\"line\"></span><br><span class=\"line\">#设置过期剔除时间，默认90s</span><br><span class=\"line\">eureka.instance.lease-expiration-duration-in-seconds=45</span><br></pre></td></tr></table></figure>\n\n<p>4.启动后，能在Eurekaweb端上看到服务的列表</p>\n<h4 id=\"服务发现使用场景\"><a href=\"#服务发现使用场景\" class=\"headerlink\" title=\"服务发现使用场景\"></a>服务发现使用场景</h4><p>服务发现并不是为了服务发现而服务发现，是为了使用一些必要的功能而必不可少的组件，服务发现的下游有丰富的内部服务调用工具</p>\n<ul>\n<li>Ribbon，实现客户端的负载均衡。</li>\n<li>Hystrix，断路器。</li>\n<li>Feign，RESTful Web Service客户端，整合了Ribbon和Hystrix。</li>\n</ul>\n<h3 id=\"服务调用端负载均衡——Ribbon\"><a href=\"#服务调用端负载均衡——Ribbon\" class=\"headerlink\" title=\"服务调用端负载均衡——Ribbon\"></a>服务调用端负载均衡——Ribbon</h3><p>Ribbon是Netflix发布的开源项目，主要功能是为REST客户端实现负载均衡。它主要包括六个组件：</p>\n<ol>\n<li>ServerList，负载均衡使用的服务器列表。这个列表会缓存在负载均衡器中，并定期更新。当Ribbon与Eureka结合使用时，ServerList的实现类就是DiscoveryEnabledNIWSServerList，它会保存Eureka Server中注册的服务实例表。</li>\n<li>ServerListFilter，服务器列表过滤器。这是一个接口，主要用于对Service Consumer获取到的服务器列表进行预过滤，过滤的结果也是ServerList。Ribbon提供了多种过滤器的实现。</li>\n<li>IPing，探测服务实例是否存活的策略。</li>\n<li>IRule，负载均衡策略，其实现类表述的策略包括：轮询、随机、根据响应时间加权，（可以自定义负载均衡策略，实现完之后可以重新注入ribbon）</li>\n<li>ILoadBalancer，负载均衡器。这也是一个接口，Ribbon为其提供了多个实现，比如ZoneAwareLoadBalancer。而上层代码通过调用其API进行服务调用的负载均衡选择。一般ILoadBalancer的实现类中会引用一个IRule。</li>\n<li>RestClient，服务调用器。顾名思义，这就是负载均衡后，Ribbon向Service Provider发起REST请求的工具。</li>\n</ol>\n<h4 id=\"Ribbon工作时会做四件事情：\"><a href=\"#Ribbon工作时会做四件事情：\" class=\"headerlink\" title=\"Ribbon工作时会做四件事情：\"></a>Ribbon工作时会做四件事情：</h4><p>1.优先选择在同一个Zone（区域）且负载较少的Eureka Server；<br>2.定期从Eureka更新并过滤服务实例列表；<br>3.根据用户指定的策略，在从Server取到的服务注册列表中选择一个实例的地址；<br>4.通过RestClient进行服务调用。</p>\n<h4 id=\"Ribbon的源码实现大致原理：\"><a href=\"#Ribbon的源码实现大致原理：\" class=\"headerlink\" title=\"Ribbon的源码实现大致原理：\"></a>Ribbon的源码实现大致原理：</h4><ul>\n<li><p>LoadBalancerClient ： 继承了ServiceInstanceChooser接口，实现类是RibbonLoadBalancerClient.主要方法有choose（ServiceInstanceChooser用来选择instance） ,execute（LoadBalancerClient 用来执行）.</p>\n</li>\n<li><p>ILoadBalancer:接口方法有addServers，chooseServer，markServerDown,getReachableServers,getAllServers.（负载均衡）实现类为BaseLoadBalancer 和 DynamicServerListLoadBalancer.</p>\n</li>\n<li><p>BaseLoadBalancer :主要由以下类进行配置IClientConfig（基本配置，用于初始化）  IRule（路由策略）  IPing （判断响应）  （静态配置负载均衡）</p>\n</li>\n<li><p>DynamicServerListLoadBalancer： ServerList（用于从Eureka中获取服务列表）  ServerListFilter（列表过滤）  动态配置负载均衡）</p>\n</li>\n</ul>\n<h4 id=\"负载均衡过程：\"><a href=\"#负载均衡过程：\" class=\"headerlink\" title=\"负载均衡过程：\"></a>负载均衡过程：</h4><p> 1.RibbonLoadBalancerClient接收到一个serviceid之后，调用ServiceInstanceChooser的choose方法，choose方法首先得到 ILoadBalancer （当中有client列表）。再利用ILoadBalancer 的chooseServer方法得到普通Server实例并实例化RibbonServer，并返回。chooseserver会通过loadbalancer中的rule来返回正确的instance。</p>\n<p>2.DynamicServerListLoadBalancer由iconfig初始化，初始化完成后调用updateListOfServers方法获得所有ServerList。（方法中通过ServerList实现类来访问EurekaClient中的注册列表）</p>\n<p>3.BaseLoadBalancer中有一个PingTask任务，他每10秒钟会向EurekaClient发送一个Ping。如果从Eureka拉取的注册列表发生了改变，则重新更新列表。</p>\n<p>4.LoadBalancerClient根据注册列表和IRule来进行负载均衡</p>\n<h4 id=\"Ribbon的应用\"><a href=\"#Ribbon的应用\" class=\"headerlink\" title=\"Ribbon的应用\"></a>Ribbon的应用</h4><p>springcloud提供了默认的配置RibbonClientConfiguration。它提供了包含ILoadBalancer,ServerListFilter在内的许多配置。</p>\n<p>你可以更改默认的配置，更改方法为在.property文件中添加<client>.ribbon.*的配置项</client></p>\n<h3 id=\"服务调用端熔断——Hystrix\"><a href=\"#服务调用端熔断——Hystrix\" class=\"headerlink\" title=\"服务调用端熔断——Hystrix\"></a>服务调用端熔断——Hystrix</h3><p>Netflix创建了一个名为Hystrix的库,实现了断路器的模式。</p>\n<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。<br><img src=\"https://imagecdn.bosong.online/image/hystrix.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hystrix.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix\"><br>正常情况下，在请求失败频率较低的情况下，Hystrix还是会直接把故障返回给客户端。只有当失败次数达到阈值（默认在20秒内失败5次）时，断路器打开并且不进行后续通信，而是直接返回备选响应。</p>\n<p>当然，Hystrix的备选响应也是可以由开发者定制的。<br><img src=\"https://imagecdn.bosong.online/image/hysit2.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hysit2.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix2\"></p>\n<p>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续地记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。Netflix通过hystrix-metrics-event-stream项目实现了对以上指标的监控。Spring Cloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面，Hystrix Dashboard Wiki上详细说明了图上每个指标的含义。</p>\n<p><img src=\"https://imagecdn.bosong.online/image/hystic3.png\" class=\"lazyload\" data-srcset=\"https://imagecdn.bosong.online/image/hystic3.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\" alt=\"hystrix3\"></p>\n<h3 id=\"服务调用端代码抽象和封装——Feign\"><a href=\"#服务调用端代码抽象和封装——Feign\" class=\"headerlink\" title=\"服务调用端代码抽象和封装——Feign\"></a>服务调用端代码抽象和封装——Feign</h3><p>Feign是一个声明式的Web Service客户端，它的目的就是让Web Service调用更加简单。</p>\n<p>它整合了Ribbon和Hystrix，从而让我们不再需要显式地使用这两个组件。</p>\n<p>Feign还提供了HTTP请求的模板，通过编写简单的接口和插入注解，我们就可以定义好HTTP请求的参数、格式、地址等信息。</p>\n<p>接下来，Feign会完全代理HTTP的请求，我们只需要像调用方法一样调用它就可以完成服务请求。</p>\n<p>Feign具有如下特性：</p>\n<ul>\n<li>可插拔的注解支持，包括Feign注解和JAX-RS注解</li>\n<li>支持可插拔的HTTP编码器和解码器</li>\n<li>支持Hystrix和它的Fallback</li>\n<li>支持Ribbon的负载均衡</li>\n<li>支持HTTP请求和响应的压缩</li>\n</ul>\n<p>以下是一个Feign的简单示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SpringBootApplication</span><br><span class=\"line\">@EnableDiscoveryClient </span><br><span class=\"line\">@EnableFeignClients  //启用fegin调用</span><br><span class=\"line\">public class Application</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public static void main(String[] args)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        SpringApplication.run(Application.class, args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">@FeignClient(name = &quot;elements&quot;, fallback = ElementsFallback.class) //指定feign调用的服务和Hystrix Fallback（name即eureka的application name）</span><br><span class=\"line\">public interface Elements</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @RequestMapping(value = &quot;/index&quot;)</span><br><span class=\"line\">    String index();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//Hystrix Fallback  </span><br><span class=\"line\">@Component</span><br><span class=\"line\">public class ElementsFallback implements Elements</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public String index()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        return &quot;熔断生效&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//测试类</span><br><span class=\"line\">@Component  </span><br><span class=\"line\">public class TestController &#123;</span><br><span class=\"line\">    @Autowired</span><br><span class=\"line\">    Elements elements;</span><br><span class=\"line\"></span><br><span class=\"line\">    @RequestMapping(value = &quot;/testEureka&quot;, method = RequestMethod.GET)</span><br><span class=\"line\">    public String testeureka()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        return elements.index();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p> 说明：<br>（1）使用 <code>@Component</code>  注解向SpringBoot中注入该组件。</p>\n<p>（2）使用<code>@FeignClient(&quot;XXX&quot;)</code>注解来绑定该接口对应的服务。</p>\n<p>注意：在启动类上加 @EnableFeignClients 注解，如果定义的Feign接口定义跟启动类不在一个包名下，还需要制定扫描的包名：<code>@EnableFeignClients(basePackages = &quot;xxx.xxx.xxx&quot;)</code></p>\n<p>建议将接口定义，单独抽一个项目出来，后面打成公共的jar，这样无论是哪个项目需要调用接口，引入公共的接口SDK jar即可，不需要重新定义一遍。</p>\n</div><div class=\"story post-story\"><h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><p>eureka在服务下线后30秒节点还存在，需妥善处理</p>\n</div><div class=\"story post-story\"><h2 id=\"替代方案\"><a href=\"#替代方案\" class=\"headerlink\" title=\"替代方案\"></a>替代方案</h2><p>Eureka-&gt;consul consul实际也是CP型服务发现，并且监控的指标较多，可作为替代方案</p>\n<p>Ribbon-&gt;nginx 负载均衡nginx有相对较为成熟的机制，但是配置项较多，谨慎使用</p>\n\n</div>","categories":[{"name":"Java","path":"api/categories/Java.json"}],"tags":[{"name":"spring cloud","path":"api/tags/spring cloud.json"}]}